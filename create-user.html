<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>User Management - RBPF 105</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/api-client.js?v=6"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.5s;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    
    <!-- Header -->
    <div class="bg-white/10 backdrop-blur-sm border-b border-white/20 py-4 px-6">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-white flex items-center gap-3">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
                Pengurusan Pengguna
            </h1>
            <button onclick="window.location.href='index.html'" class="px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-colors border border-white/30 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="hidden sm:inline">Kembali ke Utama</span>
            </button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 sm:p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Left Panel: Add New User -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="gradient-bg p-4">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                        </svg>
                        Add New User
                    </h2>
                </div>

                <div class="p-6">
                    <!-- Success/Error Message for Add User -->
                    <div id="addUserMessage" class="hidden mb-4 p-3 rounded-lg border-l-4"></div>

                    <form onsubmit="handleAddUser(event)" class="space-y-4">
                        <!-- Full Name -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1.5">Nama Penuh</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                <input 
                                    type="text" 
                                    id="addFullName" 
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    placeholder="Contoh: ASP Dk Husma"
                                    required
                                >
                            </div>
                        </div>

                        <!-- Jawatan -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1.5">Jawatan</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <input 
                                    type="text" 
                                    id="addJawatan" 
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    placeholder="Contoh: Timbalan Setiausaha"
                                    required
                                >
                            </div>
                        </div>

                        <!-- Username -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1.5">Nama Pengguna</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                <input 
                                    type="text" 
                                    id="addUsername" 
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    placeholder="Masukkan nama pengguna untuk login"
                                    required
                                >
                            </div>
                        </div>

                        <!-- Password -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1.5">Password</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                    </svg>
                                </div>
                                <input 
                                    type="password" 
                                    id="addPassword" 
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    placeholder="••••••••••"
                                    required
                                    minlength="6"
                                >
                            </div>
                        </div>

                        <!-- Role -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1.5">Role</label>
                            <div class="relative">
                                <select 
                                    id="addRole" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none bg-white"
                                    required
                                >
                                    <option value="">Select role...</option>
                                    <option value="admin" selected>Admin</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button 
                            type="submit" 
                            class="w-full py-3 gradient-bg text-white rounded-lg font-semibold hover:opacity-90 transition-opacity flex items-center justify-center gap-2 mt-6"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                            </svg>
                            <span>Add New User</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Right Panel: Reset User Credentials -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="gradient-bg p-4">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                        </svg>
                        Reset User Credentials
                    </h2>
                </div>

                <div class="p-6">
                    <!-- Success/Error Message for Reset -->
                    <div id="resetUserMessage" class="hidden mb-4 p-3 rounded-lg border-l-4"></div>

                    <form onsubmit="handleResetUser(event)" class="space-y-4">
                        <!-- Select User -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1.5">Select User</label>
                            <div class="relative">
                                <select 
                                    id="resetSelectUser" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none bg-white"
                                    required
                                    onchange="loadUserData()"
                                >
                                    <option value="">Choose a user...</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- New Username -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1.5">New Username</label>
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="resetUsername" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-blue-50" 
                                    placeholder="husmawati.hussin@police.gov.bn"
                                    readonly
                                >
                            </div>
                        </div>

                        <!-- New Password -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1.5">New Password</label>
                            <div class="relative">
                                <input 
                                    type="password" 
                                    id="resetPassword" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-blue-50" 
                                    placeholder="••••••••••"
                                    required
                                    minlength="6"
                                >
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button 
                            type="submit" 
                            class="w-full py-3 bg-yellow-500 text-white rounded-lg font-semibold hover:bg-yellow-600 transition-colors flex items-center justify-center gap-2 mt-6"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                            </svg>
                            <span>Reset Credentials</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- DKH Signature -->
    <div class="fixed bottom-2 right-2 text-white opacity-50" style="font-size: 0.5rem;">
        DKH
    </div>

    <script>
        // Check authentication
        window.onload = function() {
            if (!AuthAPI.isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }
            loadUserList();
        };

        const DAY_NAMES = ["Ahad", "Isnin", "Selasa", "Rabu", "Khamis", "Jumaat", "Sabtu"];

        function formatDateTime(date) {
            const dayName = DAY_NAMES[date.getDay()];
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${dayName}, ${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        }

        function logActivity(action, type = 'general') {
            const activities = JSON.parse(localStorage.getItem('rbpf_activity_log')) || [];
            const username = localStorage.getItem('rbpf_username') || 'Unknown User';
            
            const newActivity = {
                id: Date.now(),
                username: username,
                action: action,
                type: type,
                timestamp: new Date().toISOString(),
                displayTime: formatDateTime(new Date())
            };
            
            activities.unshift(newActivity);
            
            if (activities.length > 100) {
                activities.length = 100;
            }
            
            localStorage.setItem('rbpf_activity_log', JSON.stringify(activities));
        }

        // Handle Add User - Using API
        async function handleAddUser(event) {
            event.preventDefault();
            
            const fullName = document.getElementById('addFullName').value.trim();
            const jawatan = document.getElementById('addJawatan').value.trim();
            const username = document.getElementById('addUsername').value.trim();
            const password = document.getElementById('addPassword').value;
            const role = document.getElementById('addRole').value;
            
            // Validation
            if (password.length < 6) {
                showMessage('addUserMessage', 'error', 'Password must be at least 6 characters.');
                return;
            }
            
            if (!role) {
                showMessage('addUserMessage', 'error', 'Please select a role.');
                return;
            }
            
            // Call API to create user
            const result = await UsersAPI.create(fullName, jawatan, username, password, role);
            
            if (result.success) {
                // Log activity
                await ActivityAPI.log(`Created new user: ${username} (${role})`, 'general');
                
                // Show success message
                showMessage('addUserMessage', 'success', `User "${username}" successfully created!`);
                
                // Clear form and reload user list
                setTimeout(() => {
                    event.target.reset();
                    loadUserList();
                }, 1500);
            } else {
                showMessage('addUserMessage', 'error', result.message || 'Failed to create user');
            }
        }

        // Load user list for reset dropdown - Using API
        async function loadUserList() {
            const result = await UsersAPI.getAll();
            const selectUser = document.getElementById('resetSelectUser');
            
            selectUser.innerHTML = '<option value="">Choose a user...</option>';
            
            if (result.success && result.data) {
                result.data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.full_name} (${user.username})`;
                    selectUser.appendChild(option);
                });
            }
        }

        // Load user data when selected - Using API
        async function loadUserData() {
            const selectUser = document.getElementById('resetSelectUser');
            const userId = parseInt(selectUser.value);
            
            if (!userId) {
                document.getElementById('resetUsername').value = '';
                document.getElementById('resetPassword').value = '';
                return;
            }
            
            const result = await UsersAPI.getAll();
            if (result.success && result.data) {
                const user = result.data.find(u => u.id === userId);
                if (user) {
                    document.getElementById('resetUsername').value = user.username;
                }
            }
        }

        // Handle Reset User - Using API
        async function handleResetUser(event) {
            event.preventDefault();
            
            const userId = parseInt(document.getElementById('resetSelectUser').value);
            const newPassword = document.getElementById('resetPassword').value;
            
            if (!userId) {
                showMessage('resetUserMessage', 'error', 'Please select a user.');
                return;
            }
            
            if (newPassword.length < 6) {
                showMessage('resetUserMessage', 'error', 'Password must be at least 6 characters.');
                return;
            }
            
            // Call API to reset password
            const result = await UsersAPI.resetPassword(userId, newPassword);
            
            if (result.success) {
                // Show success message
                showMessage('resetUserMessage', 'success', 'Password has been reset successfully!');
                
                // Clear form
                setTimeout(() => {
                    event.target.reset();
                    document.getElementById('resetUsername').value = '';
                }, 1500);
            } else {
                showMessage('resetUserMessage', 'error', result.message || 'Failed to reset password');
            }
        }

        // Show message function
        function showMessage(elementId, type, message) {
            const messageEl = document.getElementById(elementId);
            
            messageEl.classList.remove('hidden');
            messageEl.textContent = message;
            
            if (type === 'success') {
                messageEl.classList.remove('bg-red-100', 'border-red-500', 'text-red-700');
                messageEl.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
            } else {
                messageEl.classList.remove('bg-green-100', 'border-green-500', 'text-green-700');
                messageEl.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                
                // Shake animation
                const form = event.target;
                form.classList.add('animate-shake');
                setTimeout(() => form.classList.remove('animate-shake'), 500);
            }
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>
