<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>HP-105 Calendar - Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/api-client.js?v=7"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html {
            height: 100%;
            -webkit-text-size-adjust: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0.5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header Section - Logo left, Countdown center, Home button right */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            margin-bottom: 0.75rem;
            gap: 1rem;
            flex-wrap: wrap;
            position: relative;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 0 0 auto;
        }
        
        .header-logo {
            width: 55px;
            height: 55px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.375rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        
        .header-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
        }
        
        .header-title-section {
            display: flex;
            flex-direction: column;
        }
        
        .header-title {
            font-size: 1.25rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            line-height: 1.2;
        }
        
        .header-subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-top: 0.125rem;
        }
        
        .header-center {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .header-right {
            flex: 0 0 auto;
        }
        
        /* Checklist Table */
        .checklist-container {
            padding: 0.5rem 0;
            position: relative;
        }
        
        .checklist-footer {
            text-align: right;
            padding: 0.5rem 1rem;
            color: #9ca3af;
            font-size: 0.375rem;
            margin-top: 1rem;
        }
        
        .calendar-footer {
            text-align: right;
            padding: 0.5rem 1rem;
            color: #9ca3af;
            font-size: 0.375rem;
            margin-top: 0.5rem;
        }
        
        /* Home Button for Logged-in Users - Top Right Corner */
        .viewer-home-button {
            position: absolute;
            top: 0;
            right: 0;
            z-index: 1001;
            background: rgba(30, 64, 175, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            min-height: 40px;
            display: none;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.8125rem;
            font-weight: 600;
            text-decoration: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(30, 64, 175, 0.3);
            user-select: none;
            transition: all 0.2s;
        }
        
        .viewer-home-button:hover {
            background: rgba(30, 58, 138, 0.95);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        .viewer-home-button:active {
            transform: scale(0.95);
        }
        
        .viewer-home-button svg {
            width: 1.125rem;
            height: 1.125rem;
        }
        
        .viewer-home-button.show {
            display: flex;
        }
        
        .checklist-table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .checklist-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
            border-spacing: 0;
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 0.875rem;
            border: 2px solid #444;
        }
        
        .checklist-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .checklist-table th {
            padding: 0.45rem 0.55rem;
            text-align: center;
            font-weight: 700;
            font-size: 0.82rem;
            white-space: normal;
            word-break: break-word;
            border: 2px solid #444;
        }
        
        .checklist-table th:nth-child(4) {
            text-align: center;
        }
        
        .checklist-table th:first-child {
            width: 5%;
            min-width: 35px;
            max-width: 55px;
            position: sticky;
            left: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10;
        }
        
        .checklist-table tbody tr {
            border-top: 1px solid #d1d5db;
            border-bottom: 1px solid #d1d5db;
            transition: background-color 0.15s;
        }
        
        .checklist-table tbody tr:hover {
            background-color: #f9fafb;
        }
        
        .checklist-table tbody tr:first-child {
            border-top: 1px solid #d1d5db;
        }
        
        .checklist-table tbody tr:last-child {
            border-bottom: 1px solid #d1d5db;
        }
        
        .checklist-table td {
            padding: 0.5rem 0.75rem;
            vertical-align: top;
            color: #374151;
            border: 2px solid #444;
            word-break: break-word;
            hyphens: auto;
            text-align: center;
        }
        
        .checklist-table td:nth-child(4) {
            text-align: center;
        }
        
        .checklist-table td div {
            text-align: center;
        }
        
        .tindakan-cell {
            text-align: center !important;
        }
        
        .checklist-table td:first-child {
            font-weight: 600;
            color: #1f2937;
            background: #f9fafb;
            position: sticky;
            left: 0;
            z-index: 5;
            width: 5%;
            min-width: 35px;
            max-width: 55px;
            border-right: 2px solid #d1d5db;
        }
        
        .checklist-table tbody tr:hover td:first-child {
            background: #f3f4f6;
        }
        
        .checklist-table td:not(:first-child) {
            min-width: 80px;
        }
        
        .budget-cell {
            text-align: center;
            font-weight: 600;
            white-space: nowrap;
        }

        .btn-save-all {
            background: #2563eb;
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .btn-save-all:hover {
            background: #1d4ed8;
        }
        
        .goodies-cell {
            text-align: center;
        }

        /* Hide budget tab/page entirely */
        #calendar-month-budget,
        #tab-budget {
            display: none !important;
        }
        
        /* To Do List Styles */
        .todolist-container {
            padding: 1.5rem;
            max-width: 1200px;
            width: 95%;
            margin: 0 auto;
            border: 2px solid #d8b4fe;
            border-radius: 8px;
            background: white;
        }
        
        .todolist-title-box {
            display: flex;
            align-items: center;
            border: 1px solid #6b7280;
            border-radius: 6px;
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            background: white;
        }
        
        .todolist-title-label {
            font-weight: 700;
            color: #374151;
            font-size: 1rem;
            margin-right: 0.5rem;
            white-space: nowrap;
        }
        
        .todolist-title-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 1rem;
            color: #374151;
            background: transparent;
        }
        
        .todolist-save-button-wrapper {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .todolist-save-button {
            display: flex;
            align-items: center;
            background: #2563eb;
            color: #fff;
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: background 0.2s;
            width: auto;
            min-width: 120px;
        }
        
        .todolist-save-button:hover {
            background: #1d4ed8;
        }
        
        .todolist-save-button:active {
            background: #1e40af;
        }
        
        .todolist-save-status {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .todolist-save-status.success {
            color: #10b981;
        }
        
        .todolist-save-status.error {
            color: #ef4444;
        }
        
        .todolist-table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .todolist-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #6b7280;
        }
        
        .todolist-table th {
            background: #f9fafb;
            border: 1px solid #6b7280;
            padding: 0.75rem;
            text-align: center;
            font-weight: 700;
            color: #374151;
            font-size: 0.875rem;
        }
        
        .todolist-table th:nth-child(1) {
            width: 6%;
            min-width: 50px;
        }
        
        .todolist-table th:nth-child(2) {
            width: 12%;
            min-width: 120px;
        }
        
        .todolist-table th:nth-child(3) {
            width: 72%;
            min-width: 400px;
        }
        
        .todolist-table th:nth-child(4) {
            width: 10%;
            min-width: 80px;
        }
        
        .todolist-table td {
            border: 1px solid #6b7280;
            padding: 0.5rem;
            text-align: center;
        }
        
        .todolist-table td:nth-child(1) {
            font-weight: 600;
            color: #374151;
            background: #f9fafb;
        }
        
        .todolist-date-input,
        .todolist-task-input {
            width: 100%;
            border: none;
            outline: none;
            padding: 0.5rem;
            font-size: 0.875rem;
            color: #374151;
            background: transparent;
            text-align: left;
        }
        
        .todolist-task-input {
            text-align: left;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            resize: vertical;
            min-height: 2.5rem;
            line-height: 1.5;
            font-family: inherit;
            overflow-y: auto;
        }
        
        .todolist-table td:nth-child(3) {
            vertical-align: top;
            padding: 0.5rem;
        }
        
        .todolist-table td:nth-child(3) textarea {
            width: 100%;
            box-sizing: border-box;
        }
        
        .todolist-checkbox-cell {
            text-align: center;
            vertical-align: middle;
            position: relative;
            padding: 0.5rem;
        }
        
        .todolist-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #8b5cf6;
            opacity: 1;
            margin: 0;
            vertical-align: middle;
        }
        
        .todolist-checkbox:disabled {
            accent-color: #10b981 !important;
            opacity: 1 !important;
            cursor: not-allowed;
            filter: none !important;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .todolist-checkbox:disabled:checked {
            accent-color: #10b981 !important;
            background-color: #10b981 !important;
        }
        
        .disabled-green-checkbox {
            accent-color: #10b981 !important;
            -webkit-appearance: checkbox;
            appearance: checkbox;
        }
        
        .disabled-green-checkbox:checked {
            accent-color: #10b981 !important;
            background-color: #10b981 !important;
        }
        
        /* Green checkmark overlay for disabled checked boxes */
        .todolist-checkbox-cell.green-checked::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            background-color: #10b981;
            border-radius: 3px;
            z-index: 1;
            pointer-events: none;
        }
        
        .todolist-checkbox-cell.green-checked::after {
            content: '✓';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
            z-index: 2;
            pointer-events: none;
            line-height: 18px;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .todolist-checkbox-cell.green-checked .todolist-checkbox {
            opacity: 0;
            position: relative;
            z-index: 0;
        }
        
        .todolist-table tbody tr:hover {
            background: #f9fafb;
        }
        
        /* Column sizing for checklist */
        .checklist-table th:nth-child(1),
        .checklist-table td:nth-child(1) {
            min-width: 50px;
            max-width: 70px;
        }
        
        .checklist-table th:nth-child(2),
        .checklist-table td:nth-child(2) {
            width: 10%;
            min-width: 90px;
            max-width: 140px;
        }
        
        /* Tindakan column (3rd) – compact to header size */
        .checklist-table th:nth-child(3),
        .checklist-table td:nth-child(3) {
            width: 8%;
            min-width: 90px;
            max-width: 140px;
        }
        
        /* Keterangan column (4th) – wider */
        .checklist-table th:nth-child(4),
        .checklist-table td:nth-child(4) {
            width: 35%;
            min-width: 320px;
            max-width: 600px;
        }
        
        /* Cenderahati column */
        .checklist-table th:nth-child(5),
        .checklist-table td:nth-child(5) {
            width: 10%;
            min-width: 90px;
            max-width: 130px;
            text-align: center;
        }
        
        .checklist-table th:nth-child(6),
        .checklist-table td:nth-child(6) {
            width: 10%;
            min-width: 90px;
            max-width: 130px;
            text-align: center;
        }
        
        .checklist-table th:nth-child(7),
        .checklist-table td:nth-child(7) {
            width: 10%;
            min-width: 120px;
            max-width: 200px;
        }
        
        .total-row td {
            background: #fce7eb;
            font-weight: 700;
        }
        
        .total-label {
            text-align: center;
        }
        
        .activity-item {
            display: block;
            padding: 0.375rem 0.5rem;
            margin-bottom: 0.25rem;
            background: #eff6ff;
            border-left: 3px solid #3b82f6;
            border-radius: 0.25rem;
            font-size: 0.8125rem;
            line-height: 1.4;
        }
        
        .activity-item:last-child {
            margin-bottom: 0;
        }
        
        .empty-cell {
            color: #9ca3af;
            font-style: italic;
            font-size: 0.75rem;
        }
        
        .cenderahati-input {
            width: 70px;
            padding: 0.35rem 0.45rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            text-align: center;
            transition: all 0.2s;
        }
        
        .cenderahati-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .cenderahati-input:hover {
            border-color: #9ca3af;
        }
        
        /* Budget Table Specific Styles */
        .budget-table th:first-child,
        .budget-table td:first-child {
            min-width: 60px !important;
            text-align: center;
        }
        
        .budget-table th:nth-child(2),
        .budget-table td:nth-child(2) {
            min-width: 180px !important;
            font-weight: 600;
        }
        
        .budget-table th:nth-child(3),
        .budget-table td:nth-child(3) {
            min-width: 300px !important;
        }
        
        .budget-table th:nth-child(4),
        .budget-table td:nth-child(4) {
            min-width: 140px !important;
            text-align: right;
            font-weight: 600;
        }
        
        .budget-table tbody tr:hover {
            background: #f9fafb;
        }
        
        .budget-total-row {
            border-top: 3px solid #f59e0b !important;
        }
        
        .budget-total-row td {
            background: #fef3c7 !important;
            font-size: 1.1rem !important;
        }
        
        @media (max-width: 768px) {
            .checklist-table {
                font-size: 0.75rem;
            }
            
            .checklist-table th,
            .checklist-table td {
                padding: 0.5rem 0.75rem;
            }
            
            .checklist-table th:first-child,
            .checklist-table td:first-child {
                min-width: 80px;
            }
            
            .checklist-table td:not(:first-child) {
                min-width: 120px;
            }
            
            .activity-item {
                font-size: 0.7rem;
                padding: 0.25rem 0.375rem;
            }
        }
        
        /* Countdown Banner - Inline with header */
        .countdown-banner {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            color: #000000;
            flex-shrink: 0;
        }
        
        .countdown-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .countdown-icon {
            width: 1.5rem;
            height: 1.5rem;
            flex-shrink: 0;
        }
        
        .countdown-icon svg {
            width: 100%;
            height: 100%;
        }
        
        .countdown-text {
            font-size: 1.05rem;
            font-weight: 700;
            white-space: nowrap;
            color: #000000;
        }
        
        .countdown-date {
            font-size: 0.65rem;
            opacity: 0.8;
            margin-top: 0.125rem;
        }
        
        /* Date Display - Flip Clock Style */
        .date-display {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            margin: 0;
            padding: 0;
        }
        
        .date-segment {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }
        
        .date-value {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 0.25rem;
            padding: 0.25rem 0.375rem;
            font-weight: 700;
            font-size: 0.9rem;
            min-width: 1.75rem;
            text-align: center;
            backdrop-filter: blur(5px);
            color: #000000;
        }
        
        .date-label {
            font-size: 0.54rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000000;
        }
        
        .date-separator {
            font-size: 0.9rem;
            font-weight: 700;
            opacity: 0.8;
            margin: 0 0.125rem;
            color: #000000;
        }
        
        /* Calendar Container */
        .calendar-wrapper {
            background: white;
            border-radius: 0.75rem;
            padding: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        /* Calendar Scrollable Wrapper - Only horizontal scroll, vertical handled by body */
        .calendar-scroll-wrapper {
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Calendar Tabs - Animated Button Style */
        .calendar-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.25rem;
        }
        
        .calendar-tab {
            padding: 0.625rem 1.25rem;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(102, 126, 234, 0.2);
            user-select: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .calendar-tab:hover {
            color: #667eea;
            background: #e0e7ff;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }
        
        .calendar-tab:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .calendar-tab.active {
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        
        .calendar-tab.active:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }
        
        .calendar-tab svg {
            width: 1rem;
            height: 1rem;
            transition: transform 0.3s;
        }
        
        .calendar-tab:hover svg {
            transform: scale(1.1);
        }
        
        .calendar-tab.active svg {
            color: white;
        }
        
        /* Calendar Month */
        .calendar-month {
            display: none;
        }
        
        .calendar-month.active {
            display: block;
        }
        
        .calendar-month-title {
            text-align: center;
            font-size: 0.875rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.375rem;
        }
        
        .calendar-days-header {
            display: grid;
            grid-template-columns: repeat(7, minmax(120px, 1fr));
            gap: 0.25rem;
            margin-bottom: 0.25rem;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            padding-bottom: 0.25rem;
        }
        
        .calendar-day-name {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: #6b7280;
            padding: 0.25rem 0;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, minmax(120px, 1fr));
            gap: 0.25rem;
            min-width: 840px;
        }
        
        .calendar-day {
            min-height: 80px;
            padding: 0.5rem 0.375rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.25rem;
            transition: all 0.15s;
            display: flex;
            flex-direction: column;
            font-size: 0.625rem;
            position: relative;
        }
        
        .calendar-day:hover {
            background: #eff6ff;
            border-color: #3b82f6;
            box-shadow: 0 1px 3px rgba(59,130,246,0.1);
        }
        
        .calendar-day-number {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
            font-size: 0.7rem;
        }
        
        .calendar-day-events {
            font-size: 0.65rem;
            line-height: 1.3;
            color: #4b5563;
            overflow: visible;
            word-wrap: break-word;
            flex: 1;
        }
        
        .calendar-day.weekend {
            background: #fef3c7;
        }
        
        .calendar-day.empty {
            background: #f9fafb;
            cursor: default;
            border-color: #e5e7eb;
        }
        
        .calendar-day.empty:hover {
            background: #f9fafb;
            border-color: #e5e7eb;
            box-shadow: none;
        }
        
        /* Multiple events styling - different colors */
        .calendar-day.has-multiple-events .calendar-day-number {
            font-weight: 700;
        }
        
        .calendar-day.has-multiple-events.dec .calendar-day-number {
            color: #1f2937;
        }
        
        .calendar-day.has-multiple-events.jan .calendar-day-number {
            color: #991b1b;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 0.375rem;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 0.5rem;
            }
            
            .header-left {
                width: 100%;
            }
            
            .countdown-banner {
                width: 100%;
                padding: 0.5rem 0.75rem;
            }
            
            .header-title {
                font-size: 1rem;
            }
            
            .header-subtitle {
                font-size: 0.7rem;
            }
            
            .header-logo {
                width: 45px;
                height: 45px;
            }
            
            .countdown-text {
                font-size: 0.8rem;
            }
            
            .countdown-icon {
                font-size: 1rem;
            }
            
            .calendar-wrapper {
                padding: 0.5rem;
            }
            
            .calendar-tabs {
                flex-wrap: wrap;
                gap: 0.25rem;
                margin-bottom: 0.5rem;
            }
            
            .calendar-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
                min-height: 40px;
            }
            
            .calendar-days {
                min-width: 840px;
            }
            
            .calendar-days-header {
                min-width: 840px;
            }
            
            .calendar-day {
                min-height: 70px;
                padding: 0.375rem 0.25rem;
            }
            
            .calendar-day-number {
                font-size: 0.65rem;
                margin-bottom: 0.125rem;
            }
            
            .calendar-day-events {
                font-size: 0.6rem;
                line-height: 1.2;
            }
            
            .calendar-day-name {
                font-size: 0.6rem;
            }
            
            /* Acara Checklist Mobile Styles */
            .checklist-container {
                padding: 0.5rem;
            }
            
            .checklist-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -0.5rem;
                padding: 0 0.5rem;
            }
            
            .checklist-table {
                font-size: 0.75rem;
                min-width: 800px;
            }
            
            .checklist-table th {
                padding: 0.35rem 0.4rem;
                font-size: 0.7rem;
            }
            
            .checklist-table td {
                padding: 0.35rem 0.4rem;
                font-size: 0.7rem;
            }
            
            .checklist-table td:first-child {
                min-width: 30px;
                max-width: 40px;
            }
            
            .checklist-table .cenderahati-input,
            .checklist-table .goodies-cell {
                font-size: 0.7rem;
                padding: 0.25rem;
            }
            
            .checklist-table .budget-cell {
                font-size: 0.7rem;
            }
            
            .checklist-footer {
                font-size: 0.3rem;
                padding: 0.25rem 0.5rem;
            }
            
            /* To Do List Mobile Styles */
            .todolist-container {
                padding: 0.75rem;
                width: 100%;
                max-width: 100%;
                margin: 0;
            }
            
            .todolist-save-button-wrapper {
                flex-direction: row;
                align-items: center;
                gap: 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            .todolist-save-button {
                width: auto;
                min-width: 100px;
                justify-content: center;
                padding: 0.625rem 1rem;
                font-size: 0.8rem;
            }
            
            .todolist-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -0.75rem;
                padding: 0 0.75rem;
            }
            
            .todolist-table {
                font-size: 0.75rem;
                min-width: 600px;
            }
            
            .todolist-table th {
                padding: 0.5rem 0.4rem;
                font-size: 0.7rem;
            }
            
            .todolist-table td {
                padding: 0.4rem 0.3rem;
                font-size: 0.7rem;
            }
            
            .todolist-date-input,
            .todolist-task-input {
                font-size: 0.75rem;
                padding: 0.4rem;
                min-height: 2rem;
            }
            
            .todolist-task-input {
                min-height: 2rem;
                font-size: 0.7rem;
            }
            
            .todolist-checkbox {
                width: 20px;
                height: 20px;
            }
            
            .todolist-table th:nth-child(1) {
                width: 8%;
                min-width: 40px;
            }
            
            .todolist-table th:nth-child(2) {
                width: 15%;
                min-width: 100px;
            }
            
            .todolist-table th:nth-child(3) {
                width: 62%;
                min-width: 250px;
            }
            
            .todolist-table th:nth-child(4) {
                width: 15%;
                min-width: 60px;
            }
        }
        
        @media (max-width: 480px) {
            .header-logo {
                width: 40px;
                height: 40px;
            }
            
            .header-title {
                font-size: 0.9rem;
            }
            
            .countdown-content {
                flex-wrap: wrap;
            }
            
            .calendar-day {
                min-height: 50px;
            }
            
            /* Acara Checklist - Extra Small Mobile */
            .checklist-table {
                font-size: 0.65rem;
                min-width: 700px;
            }
            
            .checklist-table th {
                padding: 0.3rem 0.3rem;
                font-size: 0.65rem;
            }
            
            .checklist-table td {
                padding: 0.3rem 0.3rem;
                font-size: 0.65rem;
            }
            
            .checklist-table .cenderahati-input {
                font-size: 0.65rem;
                padding: 0.2rem;
                min-width: 50px;
            }
            
            /* To Do List - Extra Small Mobile */
            .todolist-container {
                padding: 0.5rem;
            }
            
            .todolist-table {
                font-size: 0.65rem;
                min-width: 500px;
            }
            
            .todolist-table th {
                padding: 0.4rem 0.3rem;
                font-size: 0.65rem;
            }
            
            .todolist-table td {
                padding: 0.3rem 0.25rem;
                font-size: 0.65rem;
            }
            
            .todolist-date-input,
            .todolist-task-input {
                font-size: 0.65rem;
                padding: 0.3rem;
                min-height: 1.75rem;
            }
            
            .todolist-save-button {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
                min-width: 90px;
            }
        }
        
        /* Desktop - Keep compact */
        @media (min-width: 1024px) {
            .calendar-day {
                min-height: 75px;
                padding: 0.5rem 0.375rem;
            }
            
            .calendar-day-events {
                font-size: 0.65rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header - Logo left, Countdown center, Home button right -->
        <div class="header">
            <div class="header-left">
                <div class="header-logo">
                    <img src="rbpfnew.jpg" alt="RBPF Logo">
                </div>
                <div class="header-title-section">
                    <div class="header-title">HP-105 CHECKLIST</div>
                    <div class="header-subtitle">Paparan Kalendar</div>
                </div>
            </div>
            
            <div class="header-center">
                <div class="countdown-banner">
                    <div class="countdown-content">
                        <div class="countdown-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                <path d="M2 17l10 5 10-5"></path>
                                <path d="M2 12l10 5 10-5"></path>
                            </svg>
                        </div>
                        <div class="date-display">
                            <div class="date-segment">
                                <div class="date-value" id="currentDay">--</div>
                                <div class="date-label">Hari</div>
                            </div>
                            <span class="date-separator">/</span>
                            <div class="date-segment">
                                <div class="date-value" id="currentMonth">--</div>
                                <div class="date-label">Bulan</div>
                            </div>
                            <span class="date-separator">/</span>
                            <div class="date-segment">
                                <div class="date-value" id="currentYear">----</div>
                                <div class="date-label">Tahun</div>
                            </div>
                        </div>
                        <div class="countdown-text" id="countdownTimer">Memuatkan...</div>
                    </div>
                </div>
            </div>
            
            <div class="header-right">
                <!-- Home button will be positioned here if logged in -->
            </div>
        </div>
        
        <!-- Home Button for Logged-in Users - Top Right Corner -->
        <a href="index.html" class="viewer-home-button" id="viewerHomeButton">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
            </svg>
            <span>Home</span>
        </a>
        
        <!-- Calendar Section -->
        <div class="calendar-wrapper">
            <div class="calendar-tabs">
                <button class="calendar-tab active" onclick="switchCalendarTab('dec')" id="tab-dec">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span>Disember 2025</span>
                </button>
                <button class="calendar-tab" onclick="switchCalendarTab('jan')" id="tab-jan">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span>Januari 2026</span>
                </button>
                <button class="calendar-tab" onclick="switchCalendarTab('checklist')" id="tab-checklist">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    <span>Acara Checklist</span>
                </button>
                <button class="calendar-tab" onclick="switchCalendarTab('todolist')" id="tab-todolist">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    <span>To Do List</span>
                </button>
            </div>
            
            <!-- December 2025 Calendar -->
            <div class="calendar-month active" id="calendar-month-dec">
                <h3 class="calendar-month-title">Disember 2025</h3>
                <div class="calendar-scroll-wrapper">
                    <div class="calendar-days-header" style="min-width: 840px;">
                        <div class="calendar-day-name">Ahd</div>
                        <div class="calendar-day-name">Isn</div>
                        <div class="calendar-day-name">Sel</div>
                        <div class="calendar-day-name">Rab</div>
                        <div class="calendar-day-name">Kha</div>
                        <div class="calendar-day-name">Jum</div>
                        <div class="calendar-day-name">Sab</div>
                    </div>
                    <div class="calendar-days" id="calendar-dec-2025"></div>
                </div>
                <div class="calendar-footer">DKH@2025</div>
            </div>
            
            <!-- January 2026 Calendar -->
            <div class="calendar-month" id="calendar-month-jan">
                <h3 class="calendar-month-title">Januari 2026</h3>
                <div class="calendar-scroll-wrapper">
                    <div class="calendar-days-header" style="min-width: 840px;">
                        <div class="calendar-day-name">Ahd</div>
                        <div class="calendar-day-name">Isn</div>
                        <div class="calendar-day-name">Sel</div>
                        <div class="calendar-day-name">Rab</div>
                        <div class="calendar-day-name">Kha</div>
                        <div class="calendar-day-name">Jum</div>
                        <div class="calendar-day-name">Sab</div>
                    </div>
                    <div class="calendar-days" id="calendar-jan-2026"></div>
                </div>
                <div class="calendar-footer">DKH@2025</div>
            </div>
            
            <!-- Acara Checklist Tab -->
            <div class="calendar-month" id="calendar-month-checklist">
                <div class="checklist-container">
                    <div class="checklist-table-wrapper">
                        <table class="checklist-table">
                            <thead>
                                <tr>
                                    <th>Bil</th>
                                    <th>Perkara</th>
                                    <th>Tindakan</th>
                                    <th>Keterangan</th>
                                    <th id="cenderahati-header">Cenderahati hp105</th>
                                    <th>Goodies bag hp105</th>
                                    <th>Budget</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td>Perbarisan</td>
                                    <td class="tindakan-cell">P. Perbarisan</td>
                                    <td>
                                        <div>Anggaran Perbelanjaan merangkumi 7 hari latihan dan Majlis kemucak perbarisan</div>
                                    </td>
                                    <td><input type="number" class="cenderahati-input" placeholder="0" min="0" value="376" /></td>
                                    <td class="goodies-cell">-</td>
                                    <td class="budget-cell">$34,073.75</td>
                                </tr>
                                <tr>
                                    <td rowspan="2">2</td>
                                    <td rowspan="2">Mkn Beradat</td>
                                    <td class="tindakan-cell">P. Permakanan</td>
                                    <td>
                                        <div>Raptai makan beradat bersama Pengerusi pada 10/01/2026 dan bersama PJP 13/01/2026. Support Staff untuk 15/01/2026</div>
                                    </td>
                                    <td><input type="number" class="cenderahati-input" data-category="Mkn Beradat" placeholder="-" min="0" /></td>
                                    <td class="goodies-cell">-</td>
                                    <td class="budget-cell"></td>
                                </tr>
                                <tr>
                                    <td class="tindakan-cell">Setiausaha Mes</td>
                                    <td>
                                        <div>Makan beradat pada 15/01/2026 (<strong>belum termasuk support staffs</strong>)</div>
                                    </td>
                                    <td><input type="number" class="cenderahati-input" data-category="Mkn Beradat" placeholder="-" min="0" /></td>
                                    <td class="goodies-cell">-</td>
                                    <td class="budget-cell">$20,438.00</td>
                                </tr>
                                <tr>
                                    <td rowspan="2">3</td>
                                    <td rowspan="2">Keagamaan</td>
                                    <td class="tindakan-cell">BUI</td>
                                    <td>
                                        <div>Mencetak Surah Yassin sebanyak 300 Softcover dan 50 Hardtcover (Ezy Printing)</div>
                                    </td>
                                    <td><input type="number" class="cenderahati-input" data-category="Keagamaan" placeholder="-" min="0" /></td>
                                    <td class="goodies-cell">-</td>
                                    <td class="budget-cell">$1,275.00</td>
                                </tr>
                                <tr>
                                    <td class="tindakan-cell"></td>
                                    <td>
                                        <div>Majlis Doa Kesyukuran HP105 : perbelanjaan kelengkapan &amp; permakanan</div>
                                    </td>
                                    <td><input type="number" class="cenderahati-input" data-category="Keagamaan" placeholder="-" min="0" /></td>
                                    <td class="goodies-cell">-</td>
                                    <td class="budget-cell">$1,950.00</td>
                                </tr>
                                <tr>
                                    <td>4</td>
                                    <td>Pameran</td>
                                    <td class="tindakan-cell">P. Pameran</td>
                                    <td>
                                        <div>Pameran diadakan selama dua(2) hari</div>
                                    </td>
                                    <td><input type="number" class="cenderahati-input" placeholder="0" min="0" value="50" /></td>
                                    <td class="goodies-cell">600</td>
                                    <td class="budget-cell">$12,800.00</td>
                                </tr>
                                <tr>
                                    <td>5</td>
                                    <td>Daerah TT</td>
                                    <td class="tindakan-cell">OCPD TT</td>
                                    <td>
                                        <div>Kejohanan Bolasepak</div>
                                    </td>
                                    <td><input type="number" class="cenderahati-input" placeholder="0" min="0" value="41" /></td>
                                    <td class="goodies-cell">210</td>
                                    <td class="budget-cell">$2,328.50</td>
                                </tr>
                                <!-- Daerah BM (rowspan with detailed activities) -->
                                <tr>
                                    <td rowspan="3">6</td>
                                    <td rowspan="3">Daerah BM</td>
                                    <td class="tindakan-cell">P. Derma Darah</td>
                                    <td>Kempen Derma Darah</td>
                                    <td><input type="number" class="cenderahati-input no-fallback" data-category="Daerah BM" placeholder="-" min="0" /></td>
                                    <td class="goodies-cell">100</td>
                                    <td class="budget-cell" rowspan="3"></td>
                                </tr>
                                <tr>
                                    <td class="tindakan-cell">OCPD BM</td>
                                    <td>Gotong Royong</td>
                                    <td><input type="number" class="cenderahati-input no-fallback" data-category="Daerah BM" placeholder="-" min="0" /></td>
                                    <td class="goodies-cell">300</td>
                                </tr>
                                <tr>
                                    <td class="tindakan-cell"></td>
                                    <td>Walkaton</td>
                                    <td><input type="number" class="cenderahati-input no-fallback" data-category="Daerah BM" placeholder="-" min="0" value="5" /></td>
                                    <td class="goodies-cell">145</td>
                                </tr>

                                <!-- Daerah Belait -->
                                <tr>
                                    <td rowspan="3">7</td>
                                    <td rowspan="3">Daerah Belait</td>
                                    <td rowspan="3" class="tindakan-cell">OCPD Belait</td>
                                    <td>Open day</td>
                                    <td><input type="number" class="cenderahati-input no-fallback" data-category="Daerah Belait" placeholder="-" min="0" /></td>
                                    <td class="goodies-cell">550</td>
                                    <td class="budget-cell" rowspan="3">$2,621.00</td>
                                </tr>
                                <tr>
                                    <td>Gotong Royong</td>
                                    <td><input type="number" class="cenderahati-input no-fallback" data-category="Daerah Belait" placeholder="-" min="0" /></td>
                                    <td class="goodies-cell">-</td>
                                </tr>
                                <tr>
                                    <td>Kempen Derma Darah</td>
                                    <td><input type="number" class="cenderahati-input no-fallback" data-category="Daerah Belait" placeholder="-" min="0" /></td>
                                    <td class="goodies-cell">100</td>
                                </tr>

                                <!-- Daerah Temb -->
                                <tr>
                                    <td rowspan="3">8</td>
                                    <td rowspan="3">Daerah Temb</td>
                                    <td rowspan="3" class="tindakan-cell">OCPD Temb</td>
                                    <td>Kempen Derma Darah</td>
                                    <td><input type="number" class="cenderahati-input no-fallback" data-category="Daerah Temb" placeholder="-" min="0" /></td>
                                    <td class="goodies-cell">100</td>
                                    <td class="budget-cell" rowspan="3">$1,083.70</td>
                                </tr>
                                <tr>
                                    <td>Gotong Royong</td>
                                    <td><input type="number" class="cenderahati-input no-fallback" data-category="Daerah Temb" placeholder="-" min="0" /></td>
                                    <td class="goodies-cell">-</td>
                                </tr>
                                <tr>
                                    <td>Community Engagement @ POLSARA</td>
                                    <td><input type="number" class="cenderahati-input no-fallback" data-category="Daerah Temb" placeholder="-" min="0" /></td>
                                    <td class="goodies-cell">80</td>
                                </tr>
                                <tr>
                                    <td>9</td>
                                    <td>Kelengkapan</td>
                                    <td class="tindakan-cell">P. Kelengkapan</td>
                                    <td>
                                        <div>Perbelanjaan penyewaan kem, backdrop, fabric ceiling</div>
                                    </td>
                                    <td><input type="number" class="cenderahati-input" placeholder="0" min="0" value="0" /></td>
                                    <td class="goodies-cell">-</td>
                                    <td class="budget-cell"></td>
                                </tr>
                                <tr>
                                    <td>11</td>
                                    <td>PRO</td>
                                    <td class="tindakan-cell"></td>
                                    <td>
                                        <div>Pencetakan poster Sambutan HP ke -105</div>
                                    </td>
                                    <td><input type="number" class="cenderahati-input" placeholder="0" min="0" value="0" /></td>
                                    <td class="goodies-cell">-</td>
                                    <td class="budget-cell"></td>
                                </tr>
                                <tr>
                                    <td>10</td>
                                    <td>Cenderahati</td>
                                    <td class="tindakan-cell"></td>
                                    <td>
                                        <div>Cenderahati kepada Tetamu Kehormat, Peserta dan Pengunjung</div>
                                    </td>
                                    <td><input type="number" class="cenderahati-input" placeholder="0" min="0" value="472" /></td>
                                    <td class="goodies-cell">2185</td>
                                    <td class="budget-cell"></td>
                                </tr>
                                <tr class="total-row">
                                    <td colspan="6" class="total-label">Jumlah Keseluruhan</td>
                                    <td class="budget-cell"><strong>$76,569.95</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="checklist-footer">DKH@2025</div>
                </div>
            </div>
            
            <!-- To Do List Tab -->
            <div class="calendar-month" id="calendar-month-todolist">
                <div class="todolist-container">
                    <div class="todolist-save-button-wrapper">
                        <button class="todolist-save-button" onclick="saveAllToDoListData()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1rem; height: 1rem; margin-right: 0.5rem;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Save
                        </button>
                        <span class="todolist-save-status" id="todolist-save-status"></span>
                    </div>
                    <div class="todolist-table-wrapper">
                        <table class="todolist-table">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>DATE</th>
                                    <th>TASKS</th>
                                    <th>DONE?</th>
                                </tr>
                            </thead>
                            <tbody id="todolist-tbody">
                                <tr data-row-id="1">
                                    <td>1</td>
                                    <td><input type="text" class="todolist-date-input" placeholder="" data-row="1" /></td>
                                    <td><textarea class="todolist-task-input" placeholder="" data-row="1" rows="2"></textarea></td>
                                    <td class="todolist-checkbox-cell">
                                        <input type="checkbox" class="todolist-checkbox" data-row="1" />
                                    </td>
                                </tr>
                                <tr data-row-id="2">
                                    <td>2</td>
                                    <td><input type="text" class="todolist-date-input" placeholder="" data-row="2" /></td>
                                    <td><textarea class="todolist-task-input" placeholder="" data-row="2" rows="2"></textarea></td>
                                    <td class="todolist-checkbox-cell">
                                        <input type="checkbox" class="todolist-checkbox" data-row="2" />
                                    </td>
                                </tr>
                                <tr data-row-id="3">
                                    <td>3</td>
                                    <td><input type="text" class="todolist-date-input" placeholder="" data-row="3" /></td>
                                    <td><textarea class="todolist-task-input" placeholder="" data-row="3" rows="2"></textarea></td>
                                    <td class="todolist-checkbox-cell">
                                        <input type="checkbox" class="todolist-checkbox" data-row="3" />
                                    </td>
                                </tr>
                                <tr data-row-id="4">
                                    <td>4</td>
                                    <td><input type="text" class="todolist-date-input" placeholder="" data-row="4" /></td>
                                    <td><textarea class="todolist-task-input" placeholder="" data-row="4" rows="2"></textarea></td>
                                    <td class="todolist-checkbox-cell">
                                        <input type="checkbox" class="todolist-checkbox" data-row="4" />
                                    </td>
                                </tr>
                                <tr data-row-id="5">
                                    <td>5</td>
                                    <td><input type="text" class="todolist-date-input" placeholder="" data-row="5" /></td>
                                    <td><textarea class="todolist-task-input" placeholder="" data-row="5" rows="2"></textarea></td>
                                    <td class="todolist-checkbox-cell">
                                        <input type="checkbox" class="todolist-checkbox" data-row="5" />
                                    </td>
                                </tr>
                                <tr data-row-id="6">
                                    <td>6</td>
                                    <td><input type="text" class="todolist-date-input" placeholder="" data-row="6" /></td>
                                    <td><textarea class="todolist-task-input" placeholder="" data-row="6" rows="2"></textarea></td>
                                    <td class="todolist-checkbox-cell">
                                        <input type="checkbox" class="todolist-checkbox" data-row="6" />
                                    </td>
                                </tr>
                                <tr data-row-id="7">
                                    <td>7</td>
                                    <td><input type="text" class="todolist-date-input" placeholder="" data-row="7" /></td>
                                    <td><textarea class="todolist-task-input" placeholder="" data-row="7" rows="2"></textarea></td>
                                    <td class="todolist-checkbox-cell">
                                        <input type="checkbox" class="todolist-checkbox" data-row="7" />
                                    </td>
                                </tr>
                                <tr data-row-id="8">
                                    <td>8</td>
                                    <td><input type="text" class="todolist-date-input" placeholder="" data-row="8" /></td>
                                    <td><textarea class="todolist-task-input" placeholder="" data-row="8" rows="2"></textarea></td>
                                    <td class="todolist-checkbox-cell">
                                        <input type="checkbox" class="todolist-checkbox" data-row="8" />
                                    </td>
                                </tr>
                                <tr data-row-id="9">
                                    <td>9</td>
                                    <td><input type="text" class="todolist-date-input" placeholder="" data-row="9" /></td>
                                    <td><textarea class="todolist-task-input" placeholder="" data-row="9" rows="2"></textarea></td>
                                    <td class="todolist-checkbox-cell">
                                        <input type="checkbox" class="todolist-checkbox" data-row="9" />
                                    </td>
                                </tr>
                                <tr data-row-id="10">
                                    <td>10</td>
                                    <td><input type="text" class="todolist-date-input" placeholder="" data-row="10" /></td>
                                    <td><textarea class="todolist-task-input" placeholder="" data-row="10" rows="2"></textarea></td>
                                    <td class="todolist-checkbox-cell">
                                        <input type="checkbox" class="todolist-checkbox" data-row="10" />
                                    </td>
                                </tr>
                                <tr data-row-id="11">
                                    <td>11</td>
                                    <td><input type="text" class="todolist-date-input" placeholder="" data-row="11" /></td>
                                    <td><textarea class="todolist-task-input" placeholder="" data-row="11" rows="2"></textarea></td>
                                    <td class="todolist-checkbox-cell">
                                        <input type="checkbox" class="todolist-checkbox" data-row="11" />
                                    </td>
                                </tr>
                                <tr data-row-id="12">
                                    <td>12</td>
                                    <td><input type="text" class="todolist-date-input" placeholder="" data-row="12" /></td>
                                    <td><textarea class="todolist-task-input" placeholder="" data-row="12" rows="2"></textarea></td>
                                    <td class="todolist-checkbox-cell">
                                        <input type="checkbox" class="todolist-checkbox" data-row="12" />
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="checklist-footer">DKH@2025</div>
                </div>
            </div>
            
            <!-- Budget Tab -->
            <div class="calendar-month" id="calendar-month-budget">
                <div class="checklist-container">
                    <div class="checklist-table-wrapper">
                        <table class="checklist-table budget-table">
                            <thead>
                                <tr>
                                    <th style="min-width: 60px;">Bil</th>
                                    <th style="min-width: 180px;">Perkara</th>
                                    <th style="min-width: 300px;">Keterangan</th>
                                    <th style="min-width: 140px;">Perbelanjaan</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td>Perbarisan</td>
                                    <td>Anggaran Perbelanjaan merangkumi hari latihan dan raptai perbarisan</td>
                                    <td><strong>$ 34,073.75</strong></td>
                                </tr>
                                <tr>
                                    <td>2</td>
                                    <td>Kelengkapan</td>
                                    <td>Perbelanjaan penyewaan kem, backdrop, fabric ceiling</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>3</td>
                                    <td>Makan Beradat</td>
                                    <td>Makan beradat pada 15/01/2026</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>Raptai Makan Beradat</td>
                                    <td>Raptai makan beradat bersama Pengerusi pada 10/01/2026 dan bersama PJP 13/01/2026</td>
                                    <td><strong>$ 20,929.00</strong></td>
                                </tr>
                                <tr>
                                    <td>4</td>
                                    <td>Keagamaan</td>
                                    <td>Mencetak surah yassin sebanyak 500 softcover dan 50 softcover</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>5</td>
                                    <td>Pameran</td>
                                    <td>Pameran diadakan selama dua(2) hari</td>
                                    <td><strong>$ 12,800.00</strong></td>
                                </tr>
                                <tr>
                                    <td>6</td>
                                    <td>Aktiviti Daerah Brunei Muara</td>
                                    <td>Open day</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>Walkaton</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>Kempen Derma Darah</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>Gotong Royong</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>7</td>
                                    <td>Aktiviti Daerah Tutong</td>
                                    <td>Kejohanan Bolasepak</td>
                                    <td><strong>$ 1,638.50</strong></td>
                                </tr>
                                <tr>
                                    <td>8</td>
                                    <td>Aktiviti Daerah Belait</td>
                                    <td>Open day</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>Kempen Derma Darah</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>9</td>
                                    <td>Aktiviti Daerah Temburong</td>
                                    <td>Kempen Derma Darah</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>Gotong Royong</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>Kawad OCPD & Penyampaian Sijil kepujian</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>7</td>
                                    <td>Cenderahati</td>
                                    <td>Cenderahati kepada Tetamu Kehormat, Peserta dan Pengunjung</td>
                                    <td><strong>belum ada</strong></td>
                                </tr>
                                <tr>
                                    <td>8</td>
                                    <td>PRO</td>
                                    <td>Pencetakan poster Sambutan HP ke -105</td>
                                    <td><strong>belum ada</strong></td>
                                </tr>
                                <tr class="budget-total-row">
                                    <td colspan="3" style="text-align: right; font-weight: 700; background: #fef3c7;">Jumlah Keseluruhan</td>
                                    <td style="font-weight: 700; font-size: 1.1rem; background: #fef3c7;"><strong>$ 69,441.25</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="checklist-footer">DKH@2025</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Switch calendar tab
        function switchCalendarTab(month) {
            document.querySelectorAll('.calendar-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.calendar-month').forEach(monthEl => monthEl.classList.remove('active'));
            
            const tab = document.getElementById(`tab-${month}`);
            const monthEl = document.getElementById(`calendar-month-${month}`);
            
            if (tab) tab.classList.add('active');
            if (monthEl) monthEl.classList.add('active');
            
            // Apply To Do List restrictions when switching to todolist tab
            if (month === 'todolist') {
                setTimeout(() => {
                    restrictToDoListAccess();
                }, 100);
            }
        }
        
        // Update countdown - using same logic as index.html
        function updateCountdown() {
            const now = new Date();
            const eventDate = new Date('January 15, 2026 00:00:00');
            const timeDiff = eventDate.getTime() - now.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            let countdownText;
            if (daysDiff > 1) {
                countdownText = `${daysDiff} hari lagi!`;
            } else if (daysDiff === 1) {
                countdownText = "ESOK!";
            } else if (daysDiff <= 0) {
                if (now.getDate() === 15 && now.getMonth() === 0 && now.getFullYear() === 2026) {
                    countdownText = "HARI INI! 🎉";
                } else {
                    countdownText = "Acara telah selesai.";
                }
            }
            
            document.getElementById('countdownTimer').textContent = countdownText;
            
            // Update date display
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            
            document.getElementById('currentDay').textContent = day;
            document.getElementById('currentMonth').textContent = month;
            document.getElementById('currentYear').textContent = year;
        }
        
        // Generate calendar - using same logic as index.html
        function generateCalendar() {
            // December 2025
            const decContainer = document.getElementById('calendar-dec-2025');
            const dec2025 = new Date(2025, 11, 1);
            const decDaysInMonth = 31;
            const decFirstDay = dec2025.getDay();
            
            let decHTML = '';
            for (let i = 0; i < decFirstDay; i++) {
                decHTML += '<div class="calendar-day empty"></div>';
            }
            for (let day = 1; day <= decDaysInMonth; day++) {
                // Only Friday (5) and Sunday (0) are public holidays, Saturday (6) is working day
                const dayOfWeek = (decFirstDay + day - 1) % 7;
                const isPublicHoliday = dayOfWeek === 0 || dayOfWeek === 5;
                decHTML += `
                    <div class="calendar-day ${isPublicHoliday ? 'weekend' : ''} dec">
                        <div class="calendar-day-number">${day}</div>
                        <div id="dec-${day}-notes" class="calendar-day-events"></div>
                    </div>
                `;
            }
            decContainer.innerHTML = decHTML;
            
            // January 2026
            const janContainer = document.getElementById('calendar-jan-2026');
            const jan2026 = new Date(2026, 0, 1);
            const janDaysInMonth = 31;
            const janFirstDay = jan2026.getDay();
            
            let janHTML = '';
            for (let i = 0; i < janFirstDay; i++) {
                janHTML += '<div class="calendar-day empty"></div>';
            }
            for (let day = 1; day <= janDaysInMonth; day++) {
                const dayOfWeek = (janFirstDay + day - 1) % 7;
                const isPublicHoliday = dayOfWeek === 0 || dayOfWeek === 5;
                janHTML += `
                    <div class="calendar-day ${isPublicHoliday ? 'weekend' : ''} jan">
                        <div class="calendar-day-number">${day}</div>
                        <div id="jan-${day}-notes" class="calendar-day-events"></div>
                    </div>
                `;
            }
            janContainer.innerHTML = janHTML;
        }
        
        // Format time AM/PM
        function formatTimeAMPM(timeString) {
            // Return empty string if no time provided
            if (!timeString) return '';
            
            // Check if timeString is a valid time format (HH:MM or H:MM)
            if (!timeString.includes(':')) return '';
            
            const [hours, minutes] = timeString.split(':');
            let hour = parseInt(hours);
            
            // If parsing failed or resulted in NaN, return empty string
            if (isNaN(hour) || !minutes) return '';
            
            const ampm = hour >= 12 ? 'PM' : 'AM';
            if (hour === 0) hour = 12;
            else if (hour > 12) hour = hour - 12;
            
            return `${hour}:${minutes} ${ampm}`;
        }
        
        // Load calendar events - using same logic as index.html
        async function loadAllCalendarEvents() {
            try {
                console.log('Memuatkan acara kalendar...');
                console.log('CalendarEventsAPI tersedia:', typeof CalendarEventsAPI !== 'undefined');
                
                if (typeof CalendarEventsAPI === 'undefined') {
                    console.error('CalendarEventsAPI tidak ditakrifkan! Pastikan api-client.js dimuatkan.');
                    alert('Ralat: CalendarEventsAPI tidak dijumpai. Sila pastikan api-client.js dimuatkan.');
                    return;
                }
                
                const result = await CalendarEventsAPI.getAll();
                console.log('Respons API:', result);
                
                if (!result) {
                    console.error('API mengembalikan null atau undefined');
                    alert('Ralat: API tidak mengembalikan respons. Sila semak konsol untuk butiran.');
                    return;
                }
                
                if (!result.success) {
                    console.error('API mengembalikan ralat:', result);
                    alert('Ralat memuatkan acara kalendar: ' + (result.message || 'Ralat tidak diketahui'));
                    return;
                }
                
                const events = result.data || [];
                console.log('Acara dimuatkan:', events.length, events);
                
                if (events.length === 0) {
                    console.log('Tiada acara dalam pangkalan data - ini adalah normal jika tiada acara ditambah lagi');
                    // Don't show alert for empty database, just log it
                    return;
                }
                
                // Clear all existing events
                document.querySelectorAll('.calendar-day-events').forEach(el => {
                    el.innerHTML = '';
                });
                
                // Group events by month and day
                // Normalize month values: 'dec' or 'December' -> 'dec', 'jan' or 'January' -> 'jan'
                const eventsByDay = {};
                events.forEach(event => {
                    let month = event.month ? event.month.toLowerCase() : '';
                    // Normalize month names
                    if (month === 'december' || month === '12') month = 'dec';
                    if (month === 'january' || month === '1') month = 'jan';
                    
                    const day = event.day;
                    const key = `${month}-${day}`;
                    
                    console.log(`Processing event: month="${event.month}" -> "${month}", day="${day}", key="${key}"`);
                    
                    if (!eventsByDay[key]) {
                        eventsByDay[key] = [];
                    }
                    eventsByDay[key].push(event);
                });
                
                console.log('Events grouped by day:', eventsByDay);
                console.log('All keys:', Object.keys(eventsByDay));
                
                // Display events - using same format as index.html with venue
                let eventsDisplayed = 0;
                Object.keys(eventsByDay).forEach(key => {
                    const dayEvents = eventsByDay[key];
                    // Sort events: Mesyuarat first, then Bergambar Ramai, then others alphabetically
                    dayEvents.sort((a, b) => {
                        const at = (a.event_title || a.title || '').toLowerCase();
                        const bt = (b.event_title || b.title || '').toLowerCase();
                        
                        // Priority order: 1) Mesyuarat, 2) Bergambar Ramai, 3) Others alphabetically
                        const aIsMesyuarat = at.includes('mesyuarat');
                        const bIsMesyuarat = bt.includes('mesyuarat');
                        const aIsBergambar = at.includes('bergambar');
                        const bIsBergambar = bt.includes('bergambar');
                        
                        // Mesyuarat always comes first
                        if (aIsMesyuarat && !bIsMesyuarat) return -1;
                        if (!aIsMesyuarat && bIsMesyuarat) return 1;
                        
                        // If both are Mesyuarat, sort by number (08 before 07, etc.)
                        if (aIsMesyuarat && bIsMesyuarat) {
                            return at.localeCompare(bt);
                        }
                        
                        // Bergambar Ramai comes second (after Mesyuarat)
                        if (aIsBergambar && !bIsBergambar && !bIsMesyuarat) return -1;
                        if (!aIsBergambar && bIsBergambar && !aIsMesyuarat) return 1;
                        
                        // Otherwise sort alphabetically
                        return at.localeCompare(bt);
                    });
                    const [month, day] = key.split('-');
                    const el = document.getElementById(`${key}-notes`);
                    
                    console.log(`Looking for element: ${key}-notes`, el);
                    
                    if (el) {
                        // Find the parent calendar-day element
                        const dayEl = el.closest('.calendar-day');
                        
                        let html = '';
                        const colors = ['#1f2937', '#991b1b', '#166534']; // black, dark red, dark green
                        dayEvents.forEach((event, index) => {
                            const formattedTime = formatTimeAMPM(event.event_time);
                            const displayTime = formattedTime ? formattedTime + ' ' : '';
                            const color = colors[index % colors.length];
                            const eventTitle = event.event_title || '';
                            const venue = event.venue ? ` @${event.venue}` : '';
                            html += `<div style="margin-bottom: 2px; line-height: 1.2; color: ${color}; font-weight: ${dayEvents.length > 1 ? '600' : '400'}; font-size: 0.6rem;">• ${displayTime}${eventTitle}${venue}</div>`;
                        });
                        el.innerHTML = html;
                        eventsDisplayed += dayEvents.length;
                        
                        // Update day number color if multiple events
                        if (dayEl && dayEvents.length > 1) {
                            const dayNumberEl = dayEl.querySelector('.calendar-day-number');
                            if (dayNumberEl) {
                                const colors = ['#1f2937', '#991b1b', '#166534'];
                                dayNumberEl.style.color = colors[(dayEvents.length - 1) % colors.length];
                                dayNumberEl.style.fontWeight = '700';
                            }
                        }
                    } else {
                        console.warn('Element not found for:', key, 'Expected ID:', `${key}-notes`);
                    }
                });
                
                console.log(`Memaparkan ${eventsDisplayed} acara merentasi ${Object.keys(eventsByDay).length} hari`);
                
                console.log('Acara kalendar berjaya dimuatkan');
            } catch (error) {
                console.error('Ralat memuatkan acara kalendar:', error);
                alert('Ralat memuatkan acara kalendar. Sila semak konsol untuk butiran.');
            }
        }
        
        // Fix viewport height for mobile browsers
        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        // Check if user is logged in and show home button
        function checkLoginStatus() {
            try {
                if (typeof AuthAPI !== 'undefined' && AuthAPI.isLoggedIn()) {
                    const homeButton = document.getElementById('viewerHomeButton');
                    if (homeButton) {
                        homeButton.classList.add('show');
                    }
                }
            } catch (error) {
                console.log('AuthAPI not available or user not logged in');
            }
        }
        
        // Initialize - No authentication required for viewer
        window.onload = async function() {
            // This page is accessible without login for viewer roles
            // No authentication check needed
            
            // Check if user is logged in to show home button
            checkLoginStatus();
            
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            
            // Generate calendar first
            generateCalendar();
            updateCountdown();
            setInterval(updateCountdown, 1000);
            
            // Wait for calendar to fully render, then load events
            setTimeout(async () => {
                console.log('Starting to load calendar events...');
                await loadAllCalendarEvents();
                await loadCenderahatiData();
            }, 500);
        };
        
        // ============================================
        // Cenderahati Functions
        // ============================================
        
        async function loadCenderahatiData() {
            try {
                console.log('Loading cenderahati data...');
                const response = await CenderahatiAPI.getAll();
                
                if (response.success && response.data) {
                    console.log('Cenderahati data loaded:', response.data);
                    
                    // Update all input fields with saved values
                    document.querySelectorAll('.cenderahati-input').forEach(input => {
                        const category = input.dataset.category ||
                            (input.closest('tr')?.querySelector('td:nth-child(2)')?.textContent.trim()) ||
                            (input.closest('tr')?.querySelector('td:first-child')?.textContent.trim());
                        if (category && response.data[category]) {
                            input.value = response.data[category].count;
                        }
                    });
                    
                    // Update total after loading data
                    updateCenderahatiTotal();
                } else {
                    console.log('No cenderahati data found or failed to load');
                }
            } catch (error) {
                console.error('Error loading cenderahati data:', error);
            }
        }
        
        async function saveCenderahatiData(category, count) {
            try {
                console.log(`Saving cenderahati for ${category}: ${count}`);
                const response = await CenderahatiAPI.save(category, count);
                
                if (response.success) {
                    console.log('Cenderahati saved successfully:', response);
                    // Show success indicator
                    showSaveIndicator('✓ Saved', 'success');
                    // Update total after saving
                    updateCenderahatiTotal();
                } else {
                    console.error('Failed to save cenderahati:', response);
                    showSaveIndicator('✗ Error', 'error');
                }
            } catch (error) {
                console.error('Error saving cenderahati:', error);
                showSaveIndicator('✗ Error', 'error');
            }
        }
        
        function updateCenderahatiTotal() {
            let total = 0;
            document.querySelectorAll('.cenderahati-input').forEach(input => {
                const value = parseInt(input.value) || 0;
                total += value;
            });
            
            const header = document.getElementById('cenderahati-header');
            if (header) {
            header.textContent = `Cenderahati hp105`;
            }
            
            console.log('Cenderahati total updated:', total);
        }
        
        function showSaveIndicator(message, type) {
            // Create or get existing indicator
            let indicator = document.getElementById('cenderahati-save-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'cenderahati-save-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    padding: 10px 20px;
                    border-radius: 8px;
                    font-weight: 600;
                    z-index: 10000;
                    transition: opacity 0.3s;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                `;
                document.body.appendChild(indicator);
            }
            
            indicator.textContent = message;
            indicator.style.backgroundColor = type === 'success' ? '#10b981' : '#ef4444';
            indicator.style.color = 'white';
            indicator.style.opacity = '1';
            indicator.style.display = 'block';
            
            // Hide after 2 seconds
            setTimeout(() => {
                indicator.style.opacity = '0';
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 300);
            }, 2000);
        }

        // -----------------------------
        // Super admin check helper
        // -----------------------------
        function isSuperAdmin() {
            try {
                if (!AuthAPI || !AuthAPI.isLoggedIn()) return false;
                const user = AuthAPI.getCurrentUser();
                if (!user) return false;
                if (user.roles && user.roles.some(r => ['super-admin', 'superadmin', 'admin'].includes(String(r).toLowerCase()))) return true;
                if (user.role && String(user.role).toLowerCase().includes('admin')) return true;
                if (user.username && String(user.username).toLowerCase().includes('admin')) return true;
                return false;
            } catch (e) {
                console.warn('isSuperAdmin check failed', e);
                return false;
            }
        }

        // -----------------------------
        // Checklist editing (existing rows only)
        // -----------------------------
        const checklistFallback = [
            { category: 'Perbarisan', keterangan: 'Anggaran Perbelanjaan merangkumi 7 hari latihan dan Majlis kemucak perbarisan', tindakan: 'P. Perbarisan', cenderahati: '376', goodies: '-', budget: '$34,073.75' },
            { category: 'Mkn Beradat', keterangan: '<div>Raptai makan beradat bersama Pengerusi pada 10/01/2026 dan bersama PJP 13/01/2026. Support Staff untuk 15/01/2026</div><div>Makan beradat pada 15/01/2026 (belum termasuk support staffs)</div>', tindakan: ['P. Permakanan','Setiausaha Mes'], cenderahati: ['',''], goodies: ['-','-'], budget: ['','$20,438.00'] },
            { category: 'Keagamaan', keterangan: '<div>Mencetak Surah Yassin sebanyak 300 Softcover dan 50 Hardtcover (Ezy Printing)</div><div>Majlis Doa Kesyukuran HP105 : perbelanjaan kelengkapan &amp; permakanan</div>', tindakan: ['BUI',''], cenderahati: ['',''], goodies: ['-','-'], budget: ['$1,275.00','$1,950.00'] },
            { category: 'Pameran', keterangan: 'Pameran diadakan selama dua(2) hari', tindakan: 'P. Pameran', cenderahati: '50', goodies: '600', budget: '$12,800.00' },
            { category: 'Daerah TT', keterangan: '<div>Kejohanan Bolasepak</div>', tindakan: 'OCPD TT', cenderahati: '41', goodies: '210', budget: '$2,328.50' },
            { category: 'Daerah BM', keterangan: '<div>Kempen Derma Darah</div><div>Gotong Royong</div><div>Walkaton</div>', tindakan: ['P. Derma Darah','OCPD BM',''], cenderahati: ['','','5'], goodies: ['100','300','145'], budget: ['','',''] },
            { category: 'Daerah Belait', keterangan: '<div>Open day</div><div>Gotong Royong</div><div>Kempen Derma Darah</div>', tindakan: 'OCPD Belait', cenderahati: ['','',''], goodies: ['550','-','100'], budget: ['$2,621.00','$2,621.00','$2,621.00'] },
            { category: 'Daerah Temb', keterangan: '<div>Kempen Derma Darah</div><div>Gotong Royong</div><div>Community Engagement @ POLSARA</div>', tindakan: 'OCPD Temb', cenderahati: ['','',''], goodies: ['100','-','80'], budget: ['$1,083.70','$1,083.70','$1,083.70'] },
            { category: 'Kelengkapan', keterangan: 'Perbelanjaan penyewaan kem, backdrop, fabric ceiling', tindakan: 'P. Kelengkapan', cenderahati: '0', goodies: '-', budget: '' },
            { category: 'PRO', keterangan: 'Pencetakan poster Sambutan HP ke -105', tindakan: '', cenderahati: '0', goodies: '-', budget: '' },
            { category: 'Cenderahati', keterangan: 'Cenderahati kepada Tetamu Kehormat, Peserta dan Pengunjung', tindakan: '', cenderahati: '472', goodies: '2185', budget: '' }
        ];
        function getCategoryFromRow(row) {
            let cur = row;
            while (cur) {
                const tds = cur.querySelectorAll('td');
                if (tds[1] && tds[1].textContent.trim()) {
                    return tds[1].textContent.trim();
                }
                cur = cur.previousElementSibling;
            }
            return '';
        }

        function getTindakanFromRow(row) {
            let cur = row;
            while (cur) {
                const tds = cur.querySelectorAll('td');
                if (tds[2] && tds[2].textContent.trim()) {
                    return tds[2].textContent.trim();
                }
                cur = cur.previousElementSibling;
            }
            return '';
        }

        function collectChecklistRow(row) {
            const tds = row.querySelectorAll('td');
            const category = getCategoryFromRow(row);
            if (!category) return null;
            
            // Check if this row has rowspan (multi-row category)
            const categoryCell = tds[1];
            const rowspan = categoryCell ? parseInt(categoryCell.getAttribute('rowspan') || '1') : 1;
            
            let keteranganParts = [];
            let cenderahatiParts = [];
            let goodiesParts = [];
            let tindakanParts = [];
            
            if (rowspan > 1) {
                // Collect all sub-rows for this category
                let currentRow = row;
                for (let i = 0; i < rowspan && currentRow; i++) {
                    const subTds = currentRow.querySelectorAll('td');
                    if (subTds[2]) {
                        const tinText = subTds[2].textContent.trim();
                        tindakanParts.push(tinText || '');
                    }
                    if (subTds[3]) {
                        const ketText = subTds[3].textContent.trim();
                        if (ketText) keteranganParts.push(ketText);
                    }
                    if (subTds[4]) {
                        const cenInput = subTds[4].querySelector('input');
                        const cenValue = cenInput ? cenInput.value.trim() : subTds[4].textContent.trim();
                        // Push the value as-is (empty string for empty, '0' for zero, etc.)
                        cenderahatiParts.push(cenValue);
                    }
                    if (subTds[5]) {
                        const goodText = subTds[5].textContent.trim();
                        goodiesParts.push(goodText || '');
                    }
                    currentRow = currentRow.nextElementSibling;
                }
            } else {
                // Single row
                if (tds[2]) {
                    const tinText = tds[2].textContent.trim();
                    tindakanParts.push(tinText || '');
                }
                if (tds[3]) {
                    const ketText = tds[3].textContent.trim();
                    if (ketText) keteranganParts.push(ketText);
                }
                if (tds[4]) {
                    const cenInput = tds[4].querySelector('input');
                    const cenValue = cenInput ? cenInput.value.trim() : tds[4].textContent.trim();
                    cenderahatiParts.push(cenValue || '');
                }
                if (tds[5]) {
                    const goodText = tds[5].textContent.trim();
                    goodiesParts.push(goodText || '');
                }
            }
            
            // Combine keterangan into div format if multiple, or plain text if single
            const keterangan = keteranganParts.length > 1 
                ? keteranganParts.map(k => `<div>${k}</div>`).join('')
                : (keteranganParts[0] || '');
            
            // Return arrays for tindakan/cenderahati/goodies if multiple, single value if one
            return {
                category,
                activity1: '',
                activity2: '',
                activity3: '',
                activity4: '',
                tindakan: tindakanParts.length > 1 ? tindakanParts : (tindakanParts[0] || ''),
                keterangan: keterangan,
                cenderahati: cenderahatiParts.length > 1 ? cenderahatiParts : (cenderahatiParts[0] || ''),
                goodies: goodiesParts.length > 1 ? goodiesParts : (goodiesParts[0] || '')
            };
        }

        async function loadChecklistData() {
            try {
                const res = await ChecklistAPI.getAll();
                if (!res || !res.success || !res.data) return false;
                let hasContent = false;
                const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
                const processedCategories = new Set();
                
                // Debug: Log Daerah BM data from API
                const daerahBMData = res.data.find(r => r.category === 'Daerah BM');
                if (daerahBMData) {
                    console.log('Loading Daerah BM from API:', {
                        cenderahati: daerahBMData.cenderahati,
                        cenderahatiType: Array.isArray(daerahBMData.cenderahati) ? 'array' : typeof daerahBMData.cenderahati
                    });
                }
                
                rows.forEach((row, index) => {
                    if (row.classList.contains('total-row')) return;
                    const tds = row.querySelectorAll('td');
                    const categoryCell = tds[1];
                    if (!categoryCell) return;
                    
                    const category = categoryCell.textContent.trim();
                    if (!category || processedCategories.has(category)) return;
                    
                    const rowData = res.data.find(r => (r.category || '').toLowerCase() === category.toLowerCase());
                    if (!rowData) return;
                    
                    hasContent = true;
                    const rowspan = parseInt(categoryCell.getAttribute('rowspan') || '1');
                    
                    // Parse keterangan - could be HTML with divs or plain text
                    let keteranganParts = [];
                    if (rowData.keterangan) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = rowData.keterangan;
                        const divs = tempDiv.querySelectorAll('div');
                        if (divs.length > 0) {
                            divs.forEach(d => keteranganParts.push(d.textContent.trim()));
                        } else {
                            keteranganParts.push(rowData.keterangan.trim());
                        }
                    }
                    
                    // Parse cenderahati - could be array or single value
                    const cenderahatiParts = Array.isArray(rowData.cenderahati) 
                        ? rowData.cenderahati 
                        : (rowData.cenderahati ? [rowData.cenderahati] : ['']);
                    
                    // Parse goodies - could be array or single value
                    const goodiesParts = Array.isArray(rowData.goodies)
                        ? rowData.goodies
                        : (rowData.goodies ? [rowData.goodies] : ['']);
                    
                    // Parse tindakan - could be array or single value
                    const tindakanParts = Array.isArray(rowData.tindakan)
                        ? rowData.tindakan
                        : (rowData.tindakan ? [rowData.tindakan] : ['']);
                    
                    // Apply to all sub-rows
                    let currentRow = row;
                    for (let i = 0; i < rowspan && currentRow; i++) {
                        const subTds = currentRow.querySelectorAll('td');
                        // Only update tindakan if we have data from DB, otherwise keep HTML default
                        if (subTds[2] && tindakanParts.length > 0 && tindakanParts[i] !== undefined && tindakanParts[i]) {
                            subTds[2].textContent = tindakanParts[i];
                        }
                        if (subTds[3] && keteranganParts[i] !== undefined) {
                            subTds[3].textContent = keteranganParts[i] || '';
                        }
                        if (subTds[4]) {
                            const input = subTds[4].querySelector('input');
                            // For Daerah BM, ALWAYS force correct values: 0, 0, 5 - NEVER use DB data
                            if (category === 'Daerah BM' && input) {
                                const keterangan = subTds[3]?.textContent.trim();
                                // Set value based on keterangan text to ensure accuracy
                                if (keterangan === 'Kempen Derma Darah') {
                                    input.value = '0';
                                } else if (keterangan === 'Gotong Royong') {
                                    input.value = '0';
                                } else if (keterangan === 'Walkaton') {
                                    input.value = '5';
                                } else {
                                    // Fallback to array index
                                    const correctValues = ['0', '0', '5'];
                                    input.value = correctValues[i] || '0';
                                }
                            } else if (cenderahatiParts.length > 0 && cenderahatiParts[i] !== undefined) {
                                // For other categories, use DB data
                                const cenValue = String(cenderahatiParts[i] || '');
                                if (input) {
                                    input.value = cenValue;
                                } else {
                                    subTds[4].textContent = cenValue;
                                }
                            }
                        }
                        if (subTds[5] && goodiesParts[i] !== undefined) {
                            subTds[5].textContent = goodiesParts[i] || '';
                        }
                        currentRow = currentRow.nextElementSibling;
                    }
                    
                    processedCategories.add(category);
                });
                return hasContent;
            } catch (err) {
                console.error('Checklist load error', err);
                return false;
            }
        }

        async function applyChecklistFallback(force = false) {
            try {
                const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
                rows.forEach(row => {
                    if (row.classList.contains('total-row')) return;
                    const tds = row.querySelectorAll('td');
                    const category = tds[1] ? tds[1].textContent.trim() : '';
                    const rowData = checklistFallback.find(r => r.category.toLowerCase() === category.toLowerCase());
                    if (!rowData) return;
                    if (!force) {
                        // If the row already has any content, skip unless force is true
                        const existing = [tds[2], tds[3], tds[4], tds[5], tds[6]].some(td => td && td.textContent.trim());
                        if (existing) return;
                    }
                    // Column order: Bil | Perkara | Tindakan | Keterangan | Cenderahati | Goodies | Budget
                    if (tds[2]) tds[2].textContent = rowData.tindakan || '';
                    if (tds[3] && rowData.keterangan) tds[3].innerHTML = rowData.keterangan;
                    if (tds[4] && rowData.cenderahati !== undefined) {
                        const input = tds[4].querySelector('input');
                        if (input) {
                            if (input.classList.contains('no-fallback')) return;
                            input.value = Array.isArray(rowData.cenderahati) ? (rowData.cenderahati[0] || '') : (rowData.cenderahati || '');
                        } else {
                            tds[4].textContent = Array.isArray(rowData.cenderahati) ? (rowData.cenderahati[0] || '') : (rowData.cenderahati || '');
                        }
                    }
                    if (tds[5]) {
                        if (Array.isArray(rowData.goodies)) {
                            tds[5].textContent = rowData.goodies[0] || '';
                        } else {
                            tds[5].textContent = rowData.goodies || '';
                        }
                    }
                    if (tds[6]) {
                        if (Array.isArray(rowData.budget)) {
                            tds[6].textContent = rowData.budget[0] || '';
                        } else {
                            tds[6].textContent = rowData.budget || '';
                        }
                    }
                });
                // Only seed DB when force=true (initial empty state)
                if (force) {
                    // Collect data from the table structure (which has correct tindakan values)
                    const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
                    const processedCategories = new Set();
                    
                    for (const row of rows) {
                        if (row.classList.contains('total-row')) continue;
                        const payload = collectChecklistRow(row);
                        if (!payload || !payload.category || processedCategories.has(payload.category)) continue;
                        processedCategories.add(payload.category);
                        await ChecklistAPI.save(payload);
                    }
                }
            } catch (err) {
                console.error('Checklist fallback error', err);
            }
        }

        async function saveChecklistRow(row) {
            try {
                const payload = collectChecklistRow(row);
                if (!payload.category) return;
                const res = await ChecklistAPI.save(payload);
                if (!res || !res.success) {
                    console.warn('Gagal simpan checklist untuk ' + payload.category);
                }
            } catch (err) {
                console.error('Checklist save error', err);
            }
        }

        async function manualSaveAll() {
            try {
                const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
                const map = {};
                const processedCategories = new Set();
                
                rows.forEach(row => {
                    if (row.classList.contains('total-row')) return;
                    const tds = row.querySelectorAll('td');
                    const categoryCell = tds[1];
                    if (!categoryCell) return;
                    
                    // Skip if this is a sub-row (not the first row of a multi-row category)
                    const rowspan = parseInt(categoryCell.getAttribute('rowspan') || '1');
                    const category = categoryCell.textContent.trim();
                    if (!category || processedCategories.has(category)) return;
                    
                    // Mark this category as processed
                    processedCategories.add(category);
                    
                    const p = collectChecklistRow(row);
                    if (!p || !p.category) return;
                    
                    // Debug logging for Daerah BM
                    if (p.category === 'Daerah BM') {
                        console.log('Saving Daerah BM:', {
                            cenderahati: p.cenderahati,
                            cenderahatiType: Array.isArray(p.cenderahati) ? 'array' : typeof p.cenderahati
                        });
                    }
                    
                    map[p.category] = p;
                });
                
                const results = await Promise.all(Object.values(map).map(p => ChecklistAPI.save(p)));
                const ok = results.every(r => r && r.success);
                if (!ok) {
                    alert('Some rows failed to save.');
                } else {
                    alert('All checklist rows saved successfully!');
                    // Reload data after saving to show updated values
                    setTimeout(() => {
                        loadChecklistData().then(() => {
                            console.log('Data reloaded after save');
                        });
                    }, 500);
                }
            } catch (e) {
                console.error('manualSaveAll error', e);
                alert('Error saving checklist: ' + e.message);
            }
        }

        function enableChecklistEditing() {
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            // Allow editing for all roles
            document.querySelectorAll('.cenderahati-input').forEach(input => {
                input.disabled = false;
            });

            rows.forEach(row => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                const ketCell = tds[3];
                const goodCell = tds[5];
                if (ketCell) {
                    ketCell.contentEditable = true;
                    ketCell.querySelectorAll('div').forEach(d => {
                        d.contentEditable = true;
                        // Save when leaving the inner div
                        d.addEventListener('blur', () => saveChecklistRow(row));
                        d.addEventListener('keyup', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                saveChecklistRow(row);
                            }
                        });
                    });
                    ketCell.classList.add('editable-cell');
                    ketCell.addEventListener('blur', () => saveChecklistRow(row));
                    ketCell.addEventListener('keyup', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            saveChecklistRow(row);
                        }
                    });
                }
                if (goodCell) {
                    goodCell.contentEditable = true;
                    goodCell.querySelectorAll('div').forEach(d => {
                        d.contentEditable = true;
                        d.addEventListener('blur', () => saveChecklistRow(row));
                        d.addEventListener('keyup', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                saveChecklistRow(row);
                            }
                        });
                    });
                    goodCell.classList.add('editable-cell');
                    goodCell.addEventListener('blur', () => saveChecklistRow(row));
                    goodCell.addEventListener('keyup', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            saveChecklistRow(row);
                        }
                    });
                }
                // cenderahati inputs save on blur/change
                const cenInput = tds[4]?.querySelector('input');
                if (cenInput) {
                    cenInput.addEventListener('blur', () => saveChecklistRow(row));
                    cenInput.addEventListener('change', () => saveChecklistRow(row));
                }
            });
        }

        // -----------------------------
        // Budget editing (existing rows only)
        // -----------------------------
        function collectBudgetRow(row) {
            const tds = row.querySelectorAll('td');
            const bil = tds[0] ? tds[0].textContent.trim() : '';
            const perkara = tds[1] ? tds[1].textContent.trim() : '';
            const keterangan = tds[2] ? tds[2].textContent.trim() : '';
            // Strip currency symbols/commas; allow empty
            let perbelanjaan = tds[3] ? tds[3].textContent.trim() : '';
            perbelanjaan = perbelanjaan.replace(/[\$,]/g, '').trim();
            if (perbelanjaan === '') {
                perbelanjaan = '0';
            }
            return { bil, perkara, keterangan, perbelanjaan };
        }

        async function saveBudgetRow(row) {
            try {
                const payload = collectBudgetRow(row);
                if (!payload.bil) return; // skip rows without bil
                const res = await BudgetAPI.update(payload);
                if (!res || !res.success) {
                    alert('Gagal simpan budget untuk bil ' + payload.bil);
                }
            } catch (err) {
                console.error('Budget save error', err);
                alert('Ralat simpan budget');
            }
        }

        function enableBudgetEditing() {
            if (!isSuperAdmin()) return;
            const rows = document.querySelectorAll('#calendar-month-budget tbody tr');
            rows.forEach(row => {
                const tds = row.querySelectorAll('td');
                if (tds.length < 4) return;
                // Skip rows without bil (to prevent save errors)
                const bil = tds[0] ? tds[0].textContent.trim() : '';
                if (!bil) return;
                [1,2,3].forEach(idx => {
                    const cell = tds[idx];
                    if (!cell) return;
                    cell.contentEditable = true;
                    cell.classList.add('editable-cell');
                    cell.addEventListener('blur', () => saveBudgetRow(row));
                    cell.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            saveBudgetRow(row);
                            cell.blur();
                        }
                    });
                });
            });
        }
        
        // Force correct values for Daerah BM - ALWAYS runs
        function forceDaerahBMValues() {
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            rows.forEach(row => {
                const tds = row.querySelectorAll('td');
                const categoryCell = tds[1];
                if (categoryCell && categoryCell.textContent.trim() === 'Daerah BM') {
                    const rowspan = parseInt(categoryCell.getAttribute('rowspan') || '1');
                    if (rowspan > 1) {
                        // Find all Daerah BM sub-rows
                        let currentRow = row;
                        const correctValues = ['0', '0', '5'];
                        for (let i = 0; i < rowspan && currentRow; i++) {
                            const subTds = currentRow.querySelectorAll('td');
                            const input = subTds[4]?.querySelector('input');
                            if (input && correctValues[i] !== undefined) {
                                // Force the correct value
                                input.value = correctValues[i];
                                console.log('Forced Daerah BM row', i, 'to value', correctValues[i]);
                            }
                            currentRow = currentRow.nextElementSibling;
                        }
                        return; // Found it, exit
                    }
                }
            });
        }

        // Add event listeners to cenderahati inputs
        document.addEventListener('DOMContentLoaded', function() {
            // Attach event listeners after a short delay to ensure inputs are rendered
            setTimeout(() => {
                document.querySelectorAll('.cenderahati-input').forEach(input => {
                    // Update total in real-time as user types
                    input.addEventListener('input', function() {
                        updateCenderahatiTotal();
                    });
                    
                    input.addEventListener('change', async function() {
                        const row = this.closest('tr');
                        const category = this.dataset.category ||
                            row.querySelector('td:nth-child(2)')?.textContent.trim() ||
                            row.querySelector('td:first-child')?.textContent.trim();
                        if (category) {
                            const count = parseInt(this.value) || 0;
                            await saveCenderahatiData(category, count);
                        }
                    });
                    
                    // Also save on blur (when user clicks away)
                    input.addEventListener('blur', async function() {
                        const row = this.closest('tr');
                        const category = this.dataset.category ||
                            row.querySelector('td:nth-child(2)')?.textContent.trim() ||
                            row.querySelector('td:first-child')?.textContent.trim();
                        if (category) {
                            const count = parseInt(this.value) || 0;
                            await saveCenderahatiData(category, count);
                        }
                    });
                });
                
                console.log('Cenderahati event listeners attached');
            }, 600);

            // Load checklist data and enable editing (with fallback seed if empty)
            loadChecklistData().then(async (loaded) => {
                // If nothing loaded, seed fallback ONCE
                if (!loaded) {
                    await applyChecklistFallback(true);
                }
                enableChecklistEditing();
                // ALWAYS force correct values for Daerah BM after loading
                setTimeout(forceDaerahBMValues, 100);
            });
            
            // Load and enable To Do List (wait for API to be available)
            if (typeof ToDoListAPI !== 'undefined') {
                loadToDoListData();
                enableToDoListEditing();
                restrictToDoListAccess();
            } else {
                // Wait a bit for script to load
                setTimeout(() => {
                    if (typeof ToDoListAPI !== 'undefined') {
                        loadToDoListData();
                        enableToDoListEditing();
                        restrictToDoListAccess();
                    } else {
                        console.error('ToDoListAPI not available after timeout');
                    }
                }, 500);
            }
            
            // Also force values immediately and after delays - run multiple times to ensure it sticks
            setTimeout(forceDaerahBMValues, 500);
            setTimeout(forceDaerahBMValues, 1000);
            setTimeout(forceDaerahBMValues, 2000);
            
            // Also force on any input change for Daerah BM
            setTimeout(() => {
                document.querySelectorAll('.cenderahati-input[data-category="Daerah BM"]').forEach((input, index) => {
                    const correctValues = ['0', '0', '5'];
                    if (correctValues[index] !== undefined && input.value !== correctValues[index]) {
                        input.value = correctValues[index];
                    }
                    // Add event listener to prevent wrong values
                    input.addEventListener('input', function() {
                        const row = this.closest('tr');
                        const tds = row.querySelectorAll('td');
                        const keterangan = tds[3]?.textContent.trim();
                        if (keterangan === 'Gotong Royong' && this.value !== '0') {
                            this.value = '0';
                        } else if (keterangan === 'Kempen Derma Darah' && this.value !== '0') {
                            this.value = '0';
                        } else if (keterangan === 'Walkaton' && this.value !== '5') {
                            this.value = '5';
                        }
                    });
                });
            }, 1500);

            // Enable budget editing for super admin
            enableBudgetEditing();
        });
        
        // To Do List Functions
        async function loadToDoListData() {
            try {
                // Use window.ToDoListAPI as fallback
                const API = window.ToDoListAPI || ToDoListAPI;
                if (typeof API === 'undefined') {
                    console.error('ToDoListAPI is not defined. Make sure api-client.js is loaded.');
                    return;
                }
                const res = await API.getAll();
                if (!res || !res.success) return;
                
                // Load row data (no title box anymore)
                if (res.data && Array.isArray(res.data)) {
                    res.data.forEach(item => {
                        const rowNum = item.row_number || item.row_num;
                        const row = document.querySelector(`tr[data-row-id="${rowNum}"]`);
                        if (row) {
                            const dateInput = row.querySelector('.todolist-date-input');
                            const taskInput = row.querySelector('.todolist-task-input');
                            const checkbox = row.querySelector('.todolist-checkbox');
                            const cell = checkbox ? checkbox.closest('.todolist-checkbox-cell') : null;
                            
                            if (dateInput) dateInput.value = item.date_value || '';
                            if (taskInput) taskInput.value = item.task || '';
                            if (checkbox) {
                                checkbox.checked = item.done == 1;
                                // Apply green-checked class for non-super-admin users
                                if (!isSuperAdmin() && checkbox.checked && cell) {
                                    cell.classList.add('green-checked');
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('Error loading To Do List data:', e);
            }
        }
        
        async function saveToDoListItem(rowNumber, checklistFor, dateValue, task, done) {
            try {
                // Use window.ToDoListAPI as fallback
                const API = window.ToDoListAPI || ToDoListAPI;
                if (typeof API === 'undefined') {
                    console.error('ToDoListAPI is not defined. Make sure api-client.js is loaded.');
                    throw new Error('ToDoListAPI is not available');
                }
                const currentUser = AuthAPI.getCurrentUser();
                const res = await API.save({
                    row_number: rowNumber,
                    checklist_for: checklistFor,
                    date_value: dateValue,
                    task: task,
                    done: done,
                    username: currentUser ? currentUser.username : 'System'
                });
                
                return res && res.success;
            } catch (e) {
                console.error('Error saving To Do List item:', e);
                throw e;
            }
        }
        
        function enableToDoListEditing() {
            // No auto-save - user will click Save button manually
        }
        
        function restrictToDoListAccess() {
            // Only super_admin can edit To Do List (strict check)
            let isSuperAdminUser = false;
            try {
                if (AuthAPI && AuthAPI.isLoggedIn()) {
                    const user = AuthAPI.getCurrentUser();
                    if (user && user.role === 'super_admin') {
                        isSuperAdminUser = true;
                    }
                }
            } catch (e) {
                console.warn('ToDoList access check failed', e);
            }
            
            // Hide save button for non-super-admin users
            const saveButton = document.querySelector('.todolist-save-button');
            if (saveButton) {
                if (!isSuperAdminUser) {
                    saveButton.style.display = 'none';
                } else {
                    saveButton.style.display = 'flex';
                }
            }
            
            // Disable all input fields for non-super-admin users
            const dateInputs = document.querySelectorAll('.todolist-date-input');
            const taskInputs = document.querySelectorAll('.todolist-task-input');
            const checkboxes = document.querySelectorAll('.todolist-checkbox');
            
            dateInputs.forEach(input => {
                input.disabled = !isSuperAdminUser;
                if (!isSuperAdminUser) {
                    input.style.cursor = 'not-allowed';
                    input.style.opacity = '1';
                    input.style.backgroundColor = '#f3f4f6';
                    input.style.color = '#000000';
                } else {
                    input.style.cursor = 'text';
                    input.style.opacity = '1';
                    input.style.backgroundColor = 'transparent';
                    input.style.color = '#374151';
                }
            });
            
            taskInputs.forEach(input => {
                input.disabled = !isSuperAdminUser;
                if (!isSuperAdminUser) {
                    input.style.cursor = 'not-allowed';
                    input.style.opacity = '1';
                    input.style.backgroundColor = '#f3f4f6';
                    input.style.color = '#000000';
                } else {
                    input.style.cursor = 'text';
                    input.style.opacity = '1';
                    input.style.backgroundColor = 'transparent';
                    input.style.color = '#374151';
                }
            });
            
            checkboxes.forEach(checkbox => {
                checkbox.disabled = !isSuperAdminUser;
                const cell = checkbox.closest('.todolist-checkbox-cell');
                
                if (!isSuperAdminUser) {
                    checkbox.style.cursor = 'not-allowed';
                    checkbox.style.width = '18px';
                    checkbox.style.height = '18px';
                    
                    // If checkbox is checked, add green-checked class to cell
                    if (checkbox.checked && cell) {
                        cell.classList.add('green-checked');
                    } else if (cell) {
                        cell.classList.remove('green-checked');
                    }
                    
                    // Listen for changes (though disabled, this helps with initial state)
                    checkbox.addEventListener('change', function() {
                        if (this.checked && cell) {
                            cell.classList.add('green-checked');
                        } else if (cell) {
                            cell.classList.remove('green-checked');
                        }
                    });
                } else {
                    checkbox.style.cursor = 'pointer';
                    checkbox.style.opacity = '1';
                    checkbox.style.accentColor = '#8b5cf6';
                    if (cell) {
                        cell.classList.remove('green-checked');
                    }
                }
            });
        }
        
        async function saveAllToDoListData() {
            const statusEl = document.getElementById('todolist-save-status');
            const saveButton = document.querySelector('.todolist-save-button');
            
            // Check if API is available
            if (typeof ToDoListAPI === 'undefined' || typeof window.ToDoListAPI === 'undefined') {
                if (statusEl) {
                    statusEl.textContent = '✗ API not loaded. Please refresh the page.';
                    statusEl.className = 'todolist-save-status error';
                }
                console.error('ToDoListAPI is not defined');
                return;
            }
            
            // Use window.ToDoListAPI as fallback
            const API = window.ToDoListAPI || ToDoListAPI;
            
            // Show saving status
            if (statusEl) {
                statusEl.textContent = 'Saving...';
                statusEl.className = 'todolist-save-status';
            }
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.style.opacity = '0.6';
                saveButton.style.cursor = 'not-allowed';
            }
            
            try {
                // No checklist_for title anymore, use empty string
                const checklistFor = '';
                
                // Get all rows
                const rows = document.querySelectorAll('#todolist-tbody tr');
                const savePromises = [];
                
                rows.forEach(row => {
                    const rowId = row.getAttribute('data-row-id');
                    if (!rowId) return;
                    
                    const rowNumber = parseInt(rowId);
                    const dateInput = row.querySelector('.todolist-date-input');
                    const taskInput = row.querySelector('.todolist-task-input');
                    const checkbox = row.querySelector('.todolist-checkbox');
                    
                    const dateValue = dateInput ? dateInput.value.trim() : '';
                    const task = taskInput ? taskInput.value.trim() : '';
                    const done = checkbox && checkbox.checked ? 1 : 0;
                    
                    savePromises.push(saveToDoListItem(rowNumber, checklistFor, dateValue, task, done));
                });
                
                // Wait for all saves to complete
                await Promise.all(savePromises);
                
                // Show success status
                if (statusEl) {
                    statusEl.textContent = '✓ Saved successfully!';
                    statusEl.className = 'todolist-save-status success';
                    setTimeout(() => {
                        statusEl.textContent = '';
                        statusEl.className = 'todolist-save-status';
                    }, 3000);
                }
            } catch (e) {
                console.error('Error saving To Do List:', e);
                if (statusEl) {
                    statusEl.textContent = '✗ Error saving: ' + (e.message || 'Unknown error');
                    statusEl.className = 'todolist-save-status error';
                    setTimeout(() => {
                        statusEl.textContent = '';
                        statusEl.className = 'todolist-save-status';
                    }, 5000);
                }
            } finally {
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.style.opacity = '1';
                    saveButton.style.cursor = 'pointer';
                }
            }
        }
    </script>
</body>
</html>

