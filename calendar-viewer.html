<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>HP-105 Calendar - Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/api-client.js?v=7"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html {
            height: 100%;
            -webkit-text-size-adjust: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0.5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header Section - Logo left, Countdown center, Home button right */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            margin-bottom: 0.75rem;
            gap: 1rem;
            flex-wrap: wrap;
            position: relative;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 0 0 auto;
        }
        
        .header-logo {
            width: 55px;
            height: 55px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.375rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        
        .header-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
        }
        
        .header-title-section {
            display: flex;
            flex-direction: column;
        }
        
        .header-title {
            font-size: 1.25rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            line-height: 1.2;
        }
        
        .header-subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-top: 0.125rem;
        }
        
        .header-center {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .header-right {
            flex: 0 0 auto;
        }
        
        /* Checklist Table */
        .checklist-container {
            padding: 0.5rem 0;
            position: relative;
        }
        
        .checklist-footer {
            text-align: right;
            padding: 0.5rem 1rem;
            color: #9ca3af;
            font-size: 0.375rem;
            margin-top: 1rem;
        }
        
        .calendar-footer {
            text-align: right;
            padding: 0.5rem 1rem;
            color: #9ca3af;
            font-size: 0.375rem;
            margin-top: 0.5rem;
        }
        
        /* Home Button for Logged-in Users - Top Right Corner */
        .viewer-home-button {
            position: absolute;
            top: 0;
            right: 0;
            z-index: 1001;
            background: rgba(30, 64, 175, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            min-height: 40px;
            display: none;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.8125rem;
            font-weight: 600;
            text-decoration: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(30, 64, 175, 0.3);
            user-select: none;
            transition: all 0.2s;
        }
        
        .viewer-home-button:hover {
            background: rgba(30, 58, 138, 0.95);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        .viewer-home-button:active {
            transform: scale(0.95);
        }
        
        .viewer-home-button svg {
            width: 1.125rem;
            height: 1.125rem;
        }
        
        .viewer-home-button.show {
            display: flex;
        }
        
        .checklist-table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .checklist-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
            border-spacing: 0;
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 0.875rem;
            border: 2px solid #444;
        }
        
        .checklist-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .checklist-table th {
            padding: 0.45rem 0.55rem;
            text-align: center;
            font-weight: 700;
            font-size: 0.82rem;
            white-space: normal;
            word-break: break-word;
            border: 2px solid #444;
        }
        
        .checklist-table th:nth-child(4) {
            text-align: center;
        }
        
        .checklist-table th:first-child {
            width: 5%;
            min-width: 35px;
            max-width: 55px;
            position: sticky;
            left: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10;
        }
        
        .checklist-table tbody tr {
            border-top: 1px solid #d1d5db;
            border-bottom: 1px solid #d1d5db;
            transition: background-color 0.15s;
        }
        
        .checklist-table tbody tr:hover {
            background-color: #f9fafb;
        }
        
        .checklist-table tbody tr:first-child {
            border-top: 1px solid #d1d5db;
        }
        
        .checklist-table tbody tr:last-child {
            border-bottom: 1px solid #d1d5db;
        }
        
        .checklist-table td {
            padding: 0.5rem 0.75rem;
            vertical-align: top;
            color: #374151;
            border: 2px solid #444;
            word-break: break-word;
            hyphens: auto;
            text-align: center;
        }
        
        .checklist-table td:nth-child(4) {
            text-align: center;
        }
        
        .checklist-table td div {
            text-align: center;
        }
        
        .tindakan-cell {
            text-align: center !important;
        }
        
        .checklist-table td:first-child {
            font-weight: 600;
            color: #1f2937;
            background: #f9fafb;
            position: sticky;
            left: 0;
            z-index: 5;
            width: 5%;
            min-width: 35px;
            max-width: 55px;
            border-right: 2px solid #d1d5db;
        }
        
        .checklist-table tbody tr:hover td:first-child {
            background: #f3f4f6;
        }
        
        .checklist-table td:not(:first-child) {
            min-width: 80px;
        }
        
        .budget-cell {
            text-align: center;
            font-weight: 600;
            white-space: nowrap;
        }

        .btn-save-all {
            background: #2563eb;
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .btn-save-all:hover {
            background: #1d4ed8;
        }
        
        .goodies-cell {
            text-align: center;
        }

        /* Hide budget tab/page entirely */
        #calendar-month-budget,
        #tab-budget {
            display: none !important;
        }
        
        /* To Do List Styles */
        .todolist-container {
            padding: 1.5rem;
            max-width: 1200px;
            width: 95%;
            margin: 0 auto;
            border: 2px solid #d8b4fe;
            border-radius: 8px;
            background: white;
        }
        
        .todolist-title-box {
            display: flex;
            align-items: center;
            border: 1px solid #6b7280;
            border-radius: 6px;
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            background: white;
        }
        
        .todolist-title-label {
            font-weight: 700;
            color: #374151;
            font-size: 1rem;
            margin-right: 0.5rem;
            white-space: nowrap;
        }
        
        .todolist-title-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 1rem;
            color: #374151;
            background: transparent;
        }
        
        .todolist-save-button-wrapper {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .todolist-save-button {
            display: flex;
            align-items: center;
            background: #2563eb;
            color: #fff;
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: background 0.2s;
            width: auto;
            min-width: 120px;
        }
        
        .todolist-save-button:hover {
            background: #1d4ed8;
        }
        
        .todolist-save-button:active {
            background: #1e40af;
        }
        
        .todolist-save-status {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .todolist-save-status.success {
            color: #10b981;
        }
        
        .todolist-save-status.error {
            color: #ef4444;
        }
        
        .todolist-table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .todolist-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #6b7280;
        }
        
        .todolist-table th {
            background: #f9fafb;
            border: 1px solid #6b7280;
            padding: 0.75rem;
            text-align: center;
            font-weight: 700;
            color: #374151;
            font-size: 0.875rem;
        }
        
        .todolist-table th:nth-child(1) {
            width: 6%;
            min-width: 50px;
        }
        
        .todolist-table th:nth-child(2) {
            width: 12%;
            min-width: 120px;
        }
        
        .todolist-table th:nth-child(3) {
            width: 72%;
            min-width: 400px;
        }
        
        .todolist-table th:nth-child(4) {
            width: 10%;
            min-width: 80px;
        }
        
        .todolist-table td {
            border: 1px solid #6b7280;
            padding: 0.5rem;
            text-align: center;
        }
        
        .todolist-table td:nth-child(1) {
            font-weight: 600;
            color: #374151;
            background: #f9fafb;
        }
        
        .todolist-date-input,
        .todolist-task-input {
            width: 100%;
            border: none;
            outline: none;
            padding: 0.5rem;
            font-size: 0.875rem;
            color: #374151;
            background: transparent;
            text-align: left;
        }
        
        .todolist-task-input {
            text-align: left;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            resize: vertical;
            min-height: 2.5rem;
            line-height: 1.5;
            font-family: inherit;
            overflow-y: auto;
        }
        
        .todolist-table td:nth-child(3) {
            vertical-align: top;
            padding: 0.5rem;
        }
        
        .todolist-table td:nth-child(3) textarea {
            width: 100%;
            box-sizing: border-box;
        }
        
        .todolist-checkbox-cell {
            text-align: center;
            vertical-align: middle;
            position: relative;
            padding: 0.5rem;
        }
        
        .todolist-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #8b5cf6;
            opacity: 1;
            margin: 0;
            vertical-align: middle;
        }
        
        .todolist-checkbox:disabled {
            accent-color: #10b981 !important;
            opacity: 1 !important;
            cursor: not-allowed;
            filter: none !important;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .todolist-checkbox:disabled:checked {
            accent-color: #10b981 !important;
            background-color: #10b981 !important;
        }
        
        .disabled-green-checkbox {
            accent-color: #10b981 !important;
            -webkit-appearance: checkbox;
            appearance: checkbox;
        }
        
        .disabled-green-checkbox:checked {
            accent-color: #10b981 !important;
            background-color: #10b981 !important;
        }
        
        /* Green checkmark overlay for disabled checked boxes */
        .todolist-checkbox-cell.green-checked::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            background-color: #10b981;
            border-radius: 3px;
            z-index: 1;
            pointer-events: none;
        }
        
        .todolist-checkbox-cell.green-checked::after {
            content: '✓';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
            z-index: 2;
            pointer-events: none;
            line-height: 18px;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .todolist-checkbox-cell.green-checked .todolist-checkbox {
            opacity: 0;
            position: relative;
            z-index: 0;
        }
        
        .todolist-table tbody tr:hover {
            background: #f9fafb;
        }
        
        /* Column sizing for checklist */
        .checklist-table th:nth-child(1),
        .checklist-table td:nth-child(1) {
            min-width: 50px;
            max-width: 70px;
        }
        
        .checklist-table th:nth-child(2),
        .checklist-table td:nth-child(2) {
            width: 10%;
            min-width: 90px;
            max-width: 140px;
        }
        
        /* Tindakan column (3rd) – compact to header size */
        .checklist-table th:nth-child(3),
        .checklist-table td:nth-child(3) {
            width: 8%;
            min-width: 90px;
            max-width: 140px;
        }
        
        /* Keterangan column (4th) – wider */
        .checklist-table th:nth-child(4),
        .checklist-table td:nth-child(4) {
            width: 35%;
            min-width: 320px;
            max-width: 600px;
        }
        
        /* Override for meetings table - make table compact and not full width */
        #calendar-month-meetings .checklist-table {
            width: auto !important;
            max-width: 500px !important;
            margin: 0 auto !important;
            table-layout: auto !important;
        }
        
        /* Override for meetings table - make all columns more compact */
        #calendar-month-meetings .checklist-table th:nth-child(1),
        #calendar-month-meetings .checklist-table td:nth-child(1) {
            width: auto !important;
            min-width: 35px !important;
            max-width: 45px !important;
            padding: 0.5rem 0.4rem !important;
        }
        
        #calendar-month-meetings .checklist-table th:nth-child(2),
        #calendar-month-meetings .checklist-table td:nth-child(2) {
            width: auto !important;
            min-width: 140px !important;
            max-width: 180px !important;
        }
        
        #calendar-month-meetings .checklist-table th:nth-child(3),
        #calendar-month-meetings .checklist-table td:nth-child(3) {
            width: auto !important;
            min-width: 110px !important;
            max-width: 130px !important;
        }
        
        #calendar-month-meetings .checklist-table th:nth-child(4),
        #calendar-month-meetings .checklist-table td:nth-child(4) {
            width: auto !important;
            min-width: 165px !important;
            max-width: 220px !important;
        }
        
        /* Cenderahati column */
        .checklist-table th:nth-child(5),
        .checklist-table td:nth-child(5) {
            width: 10%;
            min-width: 90px;
            max-width: 130px;
            text-align: center;
        }
        
        .checklist-table th:nth-child(6),
        .checklist-table td:nth-child(6) {
            width: 10%;
            min-width: 90px;
            max-width: 130px;
            text-align: center;
        }
        
        .checklist-table th:nth-child(7),
        .checklist-table td:nth-child(7) {
            width: 10%;
            min-width: 120px;
            max-width: 200px;
        }
        
        .total-row td {
            background: #fce7eb;
            font-weight: 700;
        }
        
        .total-label {
            text-align: center;
        }
        
        .activity-item {
            display: block;
            padding: 0.375rem 0.5rem;
            margin-bottom: 0.25rem;
            background: #eff6ff;
            border-left: 3px solid #3b82f6;
            border-radius: 0.25rem;
            font-size: 0.8125rem;
            line-height: 1.4;
        }
        
        .activity-item:last-child {
            margin-bottom: 0;
        }
        
        .empty-cell {
            color: #9ca3af;
            font-style: italic;
            font-size: 0.75rem;
        }
        
        .cenderahati-input {
            width: 70px;
            padding: 0.35rem 0.45rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            text-align: center;
            transition: all 0.2s;
        }
        
        .cenderahati-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .cenderahati-input:hover {
            border-color: #9ca3af;
        }
        
        /* Budget Table Specific Styles */
        .budget-table th:first-child,
        .budget-table td:first-child {
            min-width: 60px !important;
            text-align: center;
        }
        
        .budget-table th:nth-child(2),
        .budget-table td:nth-child(2) {
            min-width: 180px !important;
            font-weight: 600;
        }
        
        .budget-table th:nth-child(3),
        .budget-table td:nth-child(3) {
            min-width: 300px !important;
        }
        
        .budget-table th:nth-child(4),
        .budget-table td:nth-child(4) {
            min-width: 140px !important;
            text-align: right;
            font-weight: 600;
        }
        
        .budget-table tbody tr:hover {
            background: #f9fafb;
        }
        
        .budget-total-row {
            border-top: 3px solid #f59e0b !important;
        }
        
        .budget-total-row td {
            background: #fef3c7 !important;
            font-size: 1.1rem !important;
        }
        
        @media (max-width: 768px) {
            .checklist-table {
                font-size: 0.75rem;
            }
            
            .checklist-table th,
            .checklist-table td {
                padding: 0.5rem 0.75rem;
            }
            
            .checklist-table th:first-child,
            .checklist-table td:first-child {
                min-width: 80px;
            }
            
            .checklist-table td:not(:first-child) {
                min-width: 120px;
            }
            
            .activity-item {
                font-size: 0.7rem;
                padding: 0.25rem 0.375rem;
            }
        }
        
        /* Countdown Banner - Inline with header */
        .countdown-banner {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            color: #000000;
            flex-shrink: 0;
        }
        
        .countdown-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .countdown-icon {
            width: 1.5rem;
            height: 1.5rem;
            flex-shrink: 0;
        }
        
        .countdown-icon svg {
            width: 100%;
            height: 100%;
        }
        
        .countdown-text {
            font-size: 1.05rem;
            font-weight: 700;
            white-space: nowrap;
            color: #000000;
        }
        
        .countdown-date {
            font-size: 0.65rem;
            opacity: 0.8;
            margin-top: 0.125rem;
        }
        
        /* Date Display - Flip Clock Style */
        .date-display {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            margin: 0;
            padding: 0;
        }
        
        .date-segment {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }
        
        .date-value {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 0.25rem;
            padding: 0.25rem 0.375rem;
            font-weight: 700;
            font-size: 0.9rem;
            min-width: 1.75rem;
            text-align: center;
            backdrop-filter: blur(5px);
            color: #000000;
        }
        
        .date-label {
            font-size: 0.54rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000000;
        }
        
        .date-separator {
            font-size: 0.9rem;
            font-weight: 700;
            opacity: 0.8;
            margin: 0 0.125rem;
            color: #000000;
        }
        
        /* Calendar Container */
        .calendar-wrapper {
            background: white;
            border-radius: 0.75rem;
            padding: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        /* Calendar Scrollable Wrapper - Only horizontal scroll, vertical handled by body */
        .calendar-scroll-wrapper {
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Calendar Tabs - Animated Button Style */
        .calendar-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.25rem;
        }
        
        .calendar-tab {
            padding: 0.625rem 1.25rem;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(102, 126, 234, 0.2);
            user-select: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .calendar-tab:hover {
            color: #667eea;
            background: #e0e7ff;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }
        
        .calendar-tab:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .calendar-tab.active {
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        
        .calendar-tab.active:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }
        
        .calendar-tab svg {
            width: 1rem;
            height: 1rem;
            transition: transform 0.3s;
        }
        
        .calendar-tab:hover svg {
            transform: scale(1.1);
        }
        
        .calendar-tab.active svg {
            color: white;
        }
        
        /* Calendar Month */
        .calendar-month {
            display: none;
        }
        
        .calendar-month.active {
            display: block;
        }
        
        .calendar-month-title {
            text-align: center;
            font-size: 0.875rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.375rem;
        }
        
        .calendar-days-header {
            display: grid;
            grid-template-columns: repeat(7, minmax(120px, 1fr));
            gap: 0.25rem;
            margin-bottom: 0.25rem;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            padding-bottom: 0.25rem;
        }
        
        .calendar-day-name {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: #6b7280;
            padding: 0.25rem 0;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, minmax(120px, 1fr));
            gap: 0.25rem;
            min-width: 840px;
        }
        
        .calendar-day {
            min-height: 80px;
            padding: 0.5rem 0.375rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.25rem;
            transition: all 0.15s;
            display: flex;
            flex-direction: column;
            font-size: 0.625rem;
            position: relative;
        }
        
        .calendar-day:hover {
            background: #eff6ff;
            border-color: #3b82f6;
            box-shadow: 0 1px 3px rgba(59,130,246,0.1);
        }
        
        .calendar-day-number {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
            font-size: 0.7rem;
        }
        
        .calendar-day-events {
            font-size: 0.65rem;
            line-height: 1.3;
            color: #4b5563;
            overflow: visible;
            word-wrap: break-word;
            flex: 1;
        }
        
        .calendar-day.weekend {
            background: #fef3c7;
        }
        
        .calendar-day.empty {
            background: #f9fafb;
            cursor: default;
            border-color: #e5e7eb;
        }
        
        .calendar-day.empty:hover {
            background: #f9fafb;
            border-color: #e5e7eb;
            box-shadow: none;
        }
        
        /* Multiple events styling - different colors */
        .calendar-day.has-multiple-events .calendar-day-number {
            font-weight: 700;
        }
        
        .calendar-day.has-multiple-events.dec .calendar-day-number {
            color: #1f2937;
        }
        
        .calendar-day.has-multiple-events.jan .calendar-day-number {
            color: #991b1b;
        }
        
        /* Blood donation icon */
        .blood-donation-icon {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 18px;
            height: 18px;
            z-index: 10;
            pointer-events: none;
        }
        
        .blood-donation-icon svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
        }
        
        /* Football icon */
        .football-icon {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 18px;
            height: 18px;
            z-index: 10;
            pointer-events: none;
        }
        
        .football-icon svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
        }
        
        /* Walking icon */
        .walking-icon {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 18px;
            height: 18px;
            z-index: 10;
            pointer-events: none;
        }
        
        .walking-icon svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 0.375rem;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 0.5rem;
            }
            
            .header-left {
                width: 100%;
            }
            
            .countdown-banner {
                width: 100%;
                padding: 0.5rem 0.75rem;
            }
            
            .header-title {
                font-size: 1rem;
            }
            
            .header-subtitle {
                font-size: 0.7rem;
            }
            
            .header-logo {
                width: 45px;
                height: 45px;
            }
            
            .countdown-text {
                font-size: 0.8rem;
            }
            
            .countdown-icon {
                font-size: 1rem;
            }
            
            .calendar-wrapper {
                padding: 0.5rem;
            }
            
            .calendar-tabs {
                flex-wrap: wrap;
                gap: 0.25rem;
                margin-bottom: 0.5rem;
            }
            
            .calendar-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
                min-height: 40px;
            }
            
            .calendar-days {
                min-width: 840px;
            }
            
            .calendar-days-header {
                min-width: 840px;
            }
            
            .calendar-day {
                min-height: 70px;
                padding: 0.375rem 0.25rem;
            }
            
            .calendar-day-number {
                font-size: 0.65rem;
                margin-bottom: 0.125rem;
            }
            
            .calendar-day-events {
                font-size: 0.6rem;
                line-height: 1.2;
            }
            
            .calendar-day-name {
                font-size: 0.6rem;
            }
            
            /* Icon adjustments for mobile */
            .blood-donation-icon,
            .football-icon,
            .walking-icon {
                width: 16px;
                height: 16px;
                top: 0.2rem;
                right: 0.2rem;
            }
            
            /* Acara Checklist Mobile Styles */
            .checklist-container {
                padding: 0.5rem;
            }
            
            .checklist-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -0.5rem;
                padding: 0 0.5rem;
            }
            
            .checklist-table {
                font-size: 0.75rem;
                min-width: 800px;
            }
            
            .checklist-table th {
                padding: 0.35rem 0.4rem;
                font-size: 0.7rem;
            }
            
            .checklist-table td {
                padding: 0.35rem 0.4rem;
                font-size: 0.7rem;
            }
            
            .checklist-table td:first-child {
                min-width: 30px;
                max-width: 40px;
            }
            
            .checklist-table .cenderahati-input,
            .checklist-table .goodies-cell {
                font-size: 0.7rem;
                padding: 0.25rem;
            }
            
            .checklist-table .budget-cell {
                font-size: 0.7rem;
            }
            
            .checklist-footer {
                font-size: 0.3rem;
                padding: 0.25rem 0.5rem;
            }
            
            /* To Do List Mobile Styles */
            .todolist-container {
                padding: 0.75rem;
                width: 100%;
                max-width: 100%;
                margin: 0;
            }
            
            .todolist-save-button-wrapper {
                flex-direction: row;
                align-items: center;
                gap: 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            .todolist-save-button {
                width: auto;
                min-width: 100px;
                justify-content: center;
                padding: 0.625rem 1rem;
                font-size: 0.8rem;
            }
            
            .todolist-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -0.75rem;
                padding: 0 0.75rem;
            }
            
            .todolist-table {
                font-size: 0.75rem;
                min-width: 600px;
            }
            
            .todolist-table th {
                padding: 0.5rem 0.4rem;
                font-size: 0.7rem;
            }
            
            .todolist-table td {
                padding: 0.4rem 0.3rem;
                font-size: 0.7rem;
            }
            
            .todolist-date-input,
            .todolist-task-input {
                font-size: 0.75rem;
                padding: 0.4rem;
                min-height: 2rem;
            }
            
            .todolist-task-input {
                min-height: 2rem;
                font-size: 0.7rem;
            }
            
            .todolist-checkbox {
                width: 20px;
                height: 20px;
            }
            
            .todolist-table th:nth-child(1) {
                width: 8%;
                min-width: 40px;
            }
            
            .todolist-table th:nth-child(2) {
                width: 15%;
                min-width: 100px;
            }
            
            .todolist-table th:nth-child(3) {
                width: 62%;
                min-width: 250px;
            }
            
            .todolist-table th:nth-child(4) {
                width: 15%;
                min-width: 60px;
            }
        }
        
        @media (max-width: 480px) {
            .header-logo {
                width: 40px;
                height: 40px;
            }
            
            .header-title {
                font-size: 0.9rem;
            }
            
            .countdown-content {
                flex-wrap: wrap;
            }
            
            .calendar-day {
                min-height: 50px;
            }
            
            /* Icon adjustments for extra small mobile */
            .blood-donation-icon,
            .football-icon,
            .walking-icon {
                width: 14px;
                height: 14px;
                top: 0.15rem;
                right: 0.15rem;
            }
            
            /* Acara Checklist - Extra Small Mobile */
            .checklist-table {
                font-size: 0.65rem;
                min-width: 700px;
            }
            
            .checklist-table th {
                padding: 0.3rem 0.3rem;
                font-size: 0.65rem;
            }
            
            .checklist-table td {
                padding: 0.3rem 0.3rem;
                font-size: 0.65rem;
            }
            
            .checklist-table .cenderahati-input {
                font-size: 0.65rem;
                padding: 0.2rem;
                min-width: 50px;
            }
            
            /* To Do List - Extra Small Mobile */
            .todolist-container {
                padding: 0.5rem;
            }
            
            .todolist-table {
                font-size: 0.65rem;
                min-width: 500px;
            }
            
            .todolist-table th {
                padding: 0.4rem 0.3rem;
                font-size: 0.65rem;
            }
            
            .todolist-table td {
                padding: 0.3rem 0.25rem;
                font-size: 0.65rem;
            }
            
            .todolist-date-input,
            .todolist-task-input {
                font-size: 0.65rem;
                padding: 0.3rem;
                min-height: 1.75rem;
            }
            
            .todolist-save-button {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
                min-width: 90px;
            }
        }
        
        /* Desktop - Keep compact */
        @media (min-width: 1024px) {
            .calendar-day {
                min-height: 75px;
                padding: 0.5rem 0.375rem;
            }
            
            .calendar-day-events {
                font-size: 0.65rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header - Logo left, Countdown center, Home button right -->
        <div class="header">
            <div class="header-left">
                <div class="header-logo">
                    <img src="rbpfnew.jpg" alt="RBPF Logo">
                </div>
                <div class="header-title-section">
                    <div class="header-title">HP-105 CHECKLIST</div>
                    <div class="header-subtitle">Memperkasa Pasukan Kearah Wawasan 2035</div>
                </div>
            </div>
            
            <div class="header-center">
                <div class="countdown-banner">
                    <div class="countdown-content">
                        <div class="countdown-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                <path d="M2 17l10 5 10-5"></path>
                                <path d="M2 12l10 5 10-5"></path>
                            </svg>
                        </div>
                        <div class="date-display">
                            <div class="date-segment">
                                <div class="date-value" id="currentDay">--</div>
                                <div class="date-label">Hari</div>
                            </div>
                            <span class="date-separator">/</span>
                            <div class="date-segment">
                                <div class="date-value" id="currentMonth">--</div>
                                <div class="date-label">Bulan</div>
                            </div>
                            <span class="date-separator">/</span>
                            <div class="date-segment">
                                <div class="date-value" id="currentYear">----</div>
                                <div class="date-label">Tahun</div>
                            </div>
                        </div>
                        <div class="countdown-text" id="countdownTimer">Memuatkan...</div>
                    </div>
                </div>
            </div>
            
            <div class="header-right">
                <!-- Home button will be positioned here if logged in -->
            </div>
        </div>
        
        <!-- Home Button for Logged-in Users - Top Right Corner -->
        <a href="index.html" class="viewer-home-button" id="viewerHomeButton">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
            </svg>
            <span>Home</span>
        </a>
        
        <!-- Calendar Section -->
        <div class="calendar-wrapper">
            <div class="calendar-tabs">
                <button class="calendar-tab active" onclick="switchCalendarTab('dec')" id="tab-dec">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span>Dec</span>
                </button>
                <button class="calendar-tab" onclick="switchCalendarTab('jan')" id="tab-jan">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span>Jan</span>
                </button>
                <button class="calendar-tab" onclick="switchCalendarTab('feb')" id="tab-feb">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span>Feb</span>
                </button>
                <button class="calendar-tab" onclick="switchCalendarTab('meetings')" id="tab-meetings">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span>Minit Mesyuarat</span>
                </button>
            </div>
            
            <!-- December 2025 Calendar -->
            <div class="calendar-month active" id="calendar-month-dec">
                <h3 class="calendar-month-title">Disember 2025</h3>
                <div class="calendar-scroll-wrapper">
                    <div class="calendar-days-header" style="min-width: 840px;">
                        <div class="calendar-day-name">Ahd</div>
                        <div class="calendar-day-name">Isn</div>
                        <div class="calendar-day-name">Sel</div>
                        <div class="calendar-day-name">Rab</div>
                        <div class="calendar-day-name">Kha</div>
                        <div class="calendar-day-name">Jum</div>
                        <div class="calendar-day-name">Sab</div>
                    </div>
                    <div class="calendar-days" id="calendar-dec-2025"></div>
                </div>
                <div class="calendar-footer">DKH@2025</div>
            </div>
            
            <!-- January 2026 Calendar -->
            <div class="calendar-month" id="calendar-month-jan">
                <h3 class="calendar-month-title">Januari 2026</h3>
                <div class="calendar-scroll-wrapper">
                    <div class="calendar-days-header" style="min-width: 840px;">
                        <div class="calendar-day-name">Ahd</div>
                        <div class="calendar-day-name">Isn</div>
                        <div class="calendar-day-name">Sel</div>
                        <div class="calendar-day-name">Rab</div>
                        <div class="calendar-day-name">Kha</div>
                        <div class="calendar-day-name">Jum</div>
                        <div class="calendar-day-name">Sab</div>
                    </div>
                    <div class="calendar-days" id="calendar-jan-2026"></div>
                </div>
                <div class="calendar-footer">DKH@2025</div>
            </div>
            
            <!-- February 2026 Calendar -->
            <div class="calendar-month" id="calendar-month-feb">
                <h3 class="calendar-month-title">Februari 2026</h3>
                <div class="calendar-scroll-wrapper">
                    <div class="calendar-days-header" style="min-width: 840px;">
                        <div class="calendar-day-name">Ahd</div>
                        <div class="calendar-day-name">Isn</div>
                        <div class="calendar-day-name">Sel</div>
                        <div class="calendar-day-name">Rab</div>
                        <div class="calendar-day-name">Kha</div>
                        <div class="calendar-day-name">Jum</div>
                        <div class="calendar-day-name">Sab</div>
                    </div>
                    <div class="calendar-days" id="calendar-feb-2026"></div>
                </div>
                <div class="calendar-footer">DKH@2025</div>
            </div>
            
            <!-- Minit Mesyuarat Tab -->
            <div class="calendar-month" id="calendar-month-meetings">
                <div class="checklist-container">
                    <div class="checklist-table-wrapper">
                        <table class="checklist-table" style="min-width: 450px;">
                            <thead>
                                <tr>
                                    <th style="min-width: 35px;">No.</th>
                                    <th style="min-width: 140px;">Aktiviti</th>
                                    <th style="min-width: 110px;">Tarikh</th>
                                    <th style="min-width: 165px;">Dokumen</th>
                                </tr>
                            </thead>
                            <tbody id="meetingTableBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 2rem; color: #6b7280;">
                                        Loading meetings...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="checklist-footer">DKH@2025</div>
                </div>
            </div>
            
            <!-- Budget Tab -->
            <div class="calendar-month" id="calendar-month-budget">
                <div class="checklist-container">
                    <div class="checklist-table-wrapper">
                        <table class="checklist-table budget-table">
                            <thead>
                                <tr>
                                    <th style="min-width: 60px;">Bil</th>
                                    <th style="min-width: 180px;">Perkara</th>
                                    <th style="min-width: 300px;">Keterangan</th>
                                    <th style="min-width: 140px;">Perbelanjaan</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td>Perbarisan</td>
                                    <td>Anggaran Perbelanjaan merangkumi hari latihan dan raptai perbarisan</td>
                                    <td><strong>$ 34,073.75</strong></td>
                                </tr>
                                <tr>
                                    <td>2</td>
                                    <td>Kelengkapan</td>
                                    <td>Perbelanjaan penyewaan kem, backdrop, fabric ceiling</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>3</td>
                                    <td>Makan Beradat</td>
                                    <td>Makan beradat pada 15/01/2026</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>Raptai Makan Beradat</td>
                                    <td>Raptai makan beradat bersama Pengerusi pada 10/01/2026 dan bersama PJP 13/01/2026</td>
                                    <td><strong>$ 20,929.00</strong></td>
                                </tr>
                                <tr>
                                    <td>4</td>
                                    <td>Keagamaan</td>
                                    <td>Mencetak surah yassin sebanyak 500 softcover dan 50 softcover</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>5</td>
                                    <td>Pameran</td>
                                    <td>Pameran diadakan selama dua(2) hari</td>
                                    <td><strong>$ 12,800.00</strong></td>
                                </tr>
                                <tr>
                                    <td>6</td>
                                    <td>Aktiviti Daerah Brunei Muara</td>
                                    <td>Open day</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>Walkaton</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>Kempen Derma Darah</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>Gotong Royong</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>7</td>
                                    <td>Aktiviti Daerah Tutong</td>
                                    <td>Kejohanan Bolasepak</td>
                                    <td><strong>$ 1,638.50</strong></td>
                                </tr>
                                <tr>
                                    <td>8</td>
                                    <td>Aktiviti Daerah Belait</td>
                                    <td>Open day</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>Kempen Derma Darah</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>9</td>
                                    <td>Aktiviti Daerah Temburong</td>
                                    <td>Kempen Derma Darah</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>Gotong Royong</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td>Kawad OCPD & Penyampaian Sijil kepujian</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>7</td>
                                    <td>Cenderahati</td>
                                    <td>Cenderahati kepada Tetamu Kehormat, Peserta dan Pengunjung</td>
                                    <td><strong>belum ada</strong></td>
                                </tr>
                                <tr>
                                    <td>8</td>
                                    <td>PRO</td>
                                    <td>Digital Poster HP105 (tiada pencetakan)</td>
                                    <td><strong>belum ada</strong></td>
                                </tr>
                                <tr class="budget-total-row">
                                    <td colspan="3" style="text-align: right; font-weight: 700; background: #fef3c7;">Jumlah Keseluruhan</td>
                                    <td style="font-weight: 700; font-size: 1.1rem; background: #fef3c7;"><strong>$ 69,441.25</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="checklist-footer">DKH@2025</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Switch calendar tab
        function switchCalendarTab(month) {
            document.querySelectorAll('.calendar-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.calendar-month').forEach(monthEl => monthEl.classList.remove('active'));
            
            const tab = document.getElementById(`tab-${month}`);
            const monthEl = document.getElementById(`calendar-month-${month}`);
            
            if (tab) tab.classList.add('active');
            if (monthEl) monthEl.classList.add('active');
            
            // Load meetings when switching to meetings tab
            if (month === 'meetings') {
                loadMeetings();
            }
        }
        
        // Load and display meetings
        async function loadMeetings() {
            const tbody = document.getElementById('meetingTableBody');
            
            if (!tbody) return;
            
            try {
                // Check if MeetingsAPI is available
                if (typeof MeetingsAPI === 'undefined' || !MeetingsAPI.getAll) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 2rem; color: #dc2626;">
                                Meetings API not available
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const result = await MeetingsAPI.getAll();
                
                if (!result || !result.success) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 2rem; color: #dc2626;">
                                Error loading meetings: ${result ? result.message : 'Unknown error'}
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const meetings = result.data || [];
                
                if (meetings.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 2rem; color: #6b7280;">
                                No meetings scheduled yet.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Sort meetings by date
                meetings.sort((a, b) => {
                    const dateA = new Date(a.meeting_date);
                    const dateB = new Date(b.meeting_date);
                    return dateA - dateB;
                });
                
                let html = '';
                meetings.forEach((meeting, index) => {
                    const formattedDate = new Date(meeting.meeting_date).toLocaleDateString('en-GB', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    });
                    
                    // Format date as DD-MMM-YYYY (e.g., 05-Nov-2025)
                    const [day, month, year] = formattedDate.split(' ');
                    const finalDate = `${day}-${month}-${year}`;
                    
                    let documentCell = '<span style="color: #9ca3af;">N/A</span>';
                    if (meeting.document_data && meeting.document_name) {
                        const safeDocumentData = meeting.document_data.replace(/'/g, "\\'");
                        const safeDocumentName = meeting.document_name.replace(/'/g, "\\'");
                        documentCell = `
                            <a href="#" onclick="downloadMeetingDocument('${safeDocumentData}', '${safeDocumentName}'); return false;" style="color: #4f46e5; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                📄 ${meeting.document_name}
                            </a>
                        `;
                    }
                    
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td style="font-weight: 600;">${meeting.title}</td>
                            <td>${finalDate}</td>
                            <td>${documentCell}</td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
            } catch (error) {
                console.error('Error loading meetings:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 2rem; color: #dc2626;">
                            Error: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        // Download meeting document function
        function downloadMeetingDocument(documentData, documentName) {
            if (!documentData || !documentData.startsWith('data:')) {
                alert('Document not available');
                return;
            }
            
            try {
                // Create a temporary anchor element to trigger download
                const link = document.createElement('a');
                link.href = documentData;
                link.download = documentName;
                link.style.display = 'none';
                
                // Append to body, click, and remove
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                setTimeout(() => {
                    alert(`✅ Downloading: ${documentName}`);
                }, 100);
            } catch (error) {
                console.error('Download error:', error);
                
                // Fallback: Try to open in new window if download fails
                try {
                    const newWindow = window.open('', '_blank');
                    if (!newWindow) {
                        alert('Unable to download or open document. Please check your browser settings.');
                        return;
                    }
                    
                    newWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                            <head>
                                <title>${documentName}</title>
                                <meta charset="UTF-8">
                                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                <style>
                                    * { margin: 0; padding: 0; box-sizing: border-box; }
                                    html, body { width: 100%; height: 100%; overflow: hidden; }
                                    body { font-family: Arial, sans-serif; background: #f3f4f6; display: flex; flex-direction: column; }
                                    .header { background: #4F46E5; color: white; padding: 0.75rem 1rem; text-align: center; }
                                    .content { flex: 1; width: 100%; position: relative; background: white; }
                                    iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
                                    .download-btn { display: block; margin: 1rem auto; padding: 0.75rem 1.5rem; background: #4F46E5; color: white; text-decoration: none; border-radius: 0.5rem; font-weight: 600; }
                                    .download-btn:hover { background: #4338ca; }
                                </style>
                            </head>
                            <body>
                                <div class="header">
                                    <h2>📄 ${documentName}</h2>
                                    <a href="${documentData}" download="${documentName}" class="download-btn">⬇️ Download Document</a>
                                </div>
                                <div class="content">
                                    <iframe src="${documentData}#toolbar=1&navpanes=1&scrollbar=1" type="application/pdf"></iframe>
                                </div>
                            </body>
                        </html>
                    `);
                    newWindow.document.close();
                } catch (fallbackError) {
                    alert('❌ Error: Unable to download or open document. ' + error.message);
                }
            }
        }
        
        // View meeting document function (for viewing in browser)
        function viewMeetingDocument(documentData, documentName) {
            if (!documentData || !documentData.startsWith('data:')) {
                alert('Document not available');
                return;
            }
            
            const newWindow = window.open('', '_blank');
            if (!newWindow) {
                alert('Pop-up blocked! Please allow pop-ups for this site.');
                return;
            }
            
            newWindow.document.write(`
                <!DOCTYPE html>
                <html>
                    <head>
                        <title>${documentName}</title>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            html, body { width: 100%; height: 100%; overflow: hidden; }
                            body { font-family: Arial, sans-serif; background: #f3f4f6; display: flex; flex-direction: column; }
                            .header { background: #4F46E5; color: white; padding: 0.75rem 1rem; text-align: center; }
                            .content { flex: 1; width: 100%; position: relative; background: white; }
                            iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
                            .download-btn { display: block; margin: 1rem auto; padding: 0.75rem 1.5rem; background: #4F46E5; color: white; text-decoration: none; border-radius: 0.5rem; font-weight: 600; }
                            .download-btn:hover { background: #4338ca; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h2>📄 ${documentName}</h2>
                            <a href="${documentData}" download="${documentName}" class="download-btn">⬇️ Download Document</a>
                        </div>
                        <div class="content">
                            <iframe src="${documentData}#toolbar=1&navpanes=1&scrollbar=1" type="application/pdf"></iframe>
                        </div>
                    </body>
                </html>
            `);
            newWindow.document.close();
        }
        
        // Update countdown - using same logic as index.html
        function updateCountdown() {
            const now = new Date();
            const eventDate = new Date('January 15, 2026 00:00:00');
            const timeDiff = eventDate.getTime() - now.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            let countdownText;
            if (daysDiff > 1) {
                countdownText = `${daysDiff} hari lagi!`;
            } else if (daysDiff === 1) {
                countdownText = "ESOK!";
            } else if (daysDiff <= 0) {
                if (now.getDate() === 15 && now.getMonth() === 0 && now.getFullYear() === 2026) {
                    countdownText = "HARI INI! 🎉";
                } else {
                    countdownText = "Acara telah selesai.";
                }
            }
            
            document.getElementById('countdownTimer').textContent = countdownText;
            
            // Update date display
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            
            document.getElementById('currentDay').textContent = day;
            document.getElementById('currentMonth').textContent = month;
            document.getElementById('currentYear').textContent = year;
        }
        
        // Generate calendar - using same logic as index.html
        function generateCalendar() {
            // December 2025
            const decContainer = document.getElementById('calendar-dec-2025');
            const dec2025 = new Date(2025, 11, 1);
            const decDaysInMonth = 31;
            const decFirstDay = dec2025.getDay();
            
            let decHTML = '';
            for (let i = 0; i < decFirstDay; i++) {
                decHTML += '<div class="calendar-day empty"></div>';
            }
            for (let day = 1; day <= decDaysInMonth; day++) {
                // Only Friday (5) and Sunday (0) are public holidays, Saturday (6) is working day
                const dayOfWeek = (decFirstDay + day - 1) % 7;
                const isPublicHoliday = dayOfWeek === 0 || dayOfWeek === 5;
                decHTML += `
                    <div class="calendar-day ${isPublicHoliday ? 'weekend' : ''} dec">
                        <div class="calendar-day-number">${day}</div>
                        <div id="dec-${day}-notes" class="calendar-day-events"></div>
                    </div>
                `;
            }
            decContainer.innerHTML = decHTML;
            
            // January 2026
            const janContainer = document.getElementById('calendar-jan-2026');
            const jan2026 = new Date(2026, 0, 1);
            const janDaysInMonth = 31;
            const janFirstDay = jan2026.getDay();
            
            let janHTML = '';
            for (let i = 0; i < janFirstDay; i++) {
                janHTML += '<div class="calendar-day empty"></div>';
            }
            for (let day = 1; day <= janDaysInMonth; day++) {
                const dayOfWeek = (janFirstDay + day - 1) % 7;
                const isPublicHoliday = dayOfWeek === 0 || dayOfWeek === 5;
                const isBloodDonation = day === 21 || day === 26;
                const isFootball = day === 27;
                const isWalking = day === 24;
                const bloodIcon = isBloodDonation ? `
                    <div class="blood-donation-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C10.5 2 9 3.5 9 5C9 6.5 9.5 8 10.5 9.5C11.5 11 12 12.5 12 14C12 12.5 12.5 11 13.5 9.5C14.5 8 15 6.5 15 5C15 3.5 13.5 2 12 2ZM12 14L10.5 17.5L12 21L13.5 17.5L12 14Z" fill="#dc2626"/>
                        </svg>
                    </div>
                ` : '';
                const footballIcon = isFootball ? `
                    <div class="football-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" fill="#ffffff" stroke="#000000" stroke-width="1"/>
                            <!-- Center pentagon (black) -->
                            <path d="M12 9L10.5 11.5L12.5 12.5L13.5 11.5L12 9Z" fill="#000000"/>
                            <!-- Top pentagon -->
                            <path d="M12 6L9.5 7.5L10.5 11.5L13.5 11.5L14.5 7.5L12 6Z" fill="#000000" opacity="0.5"/>
                            <!-- Top-left hexagon -->
                            <path d="M6.5 9.5L8 11.5L10.5 11.5L9.5 7.5L6.5 9.5Z" fill="#000000" opacity="0.5"/>
                            <!-- Top-right hexagon -->
                            <path d="M17.5 9.5L15.5 7.5L13.5 11.5L15.5 11.5L17.5 9.5Z" fill="#000000" opacity="0.5"/>
                            <!-- Left hexagon -->
                            <path d="M5.5 12L7.5 10.5L10.5 11.5L8.5 13.5L5.5 12Z" fill="#000000" opacity="0.5"/>
                            <!-- Right hexagon -->
                            <path d="M18.5 12L16.5 13.5L13.5 11.5L15.5 10.5L18.5 12Z" fill="#000000" opacity="0.5"/>
                            <!-- Bottom-left hexagon -->
                            <path d="M6.5 14.5L8 12.5L10.5 12.5L8.5 16.5L6.5 14.5Z" fill="#000000" opacity="0.5"/>
                            <!-- Bottom-right hexagon -->
                            <path d="M17.5 14.5L15.5 16.5L13.5 12.5L15.5 12.5L17.5 14.5Z" fill="#000000" opacity="0.5"/>
                            <!-- Bottom pentagon -->
                            <path d="M12 18L9.5 16.5L10.5 12.5L13.5 12.5L14.5 16.5L12 18Z" fill="#000000" opacity="0.5"/>
                            <!-- Connecting lines for ball structure -->
                            <line x1="10.5" y1="11.5" x2="8" y2="11.5" stroke="#000000" stroke-width="0.8" opacity="0.6"/>
                            <line x1="13.5" y1="11.5" x2="16" y2="11.5" stroke="#000000" stroke-width="0.8" opacity="0.6"/>
                            <line x1="10.5" y1="12.5" x2="8" y2="12.5" stroke="#000000" stroke-width="0.8" opacity="0.6"/>
                            <line x1="13.5" y1="12.5" x2="16" y2="12.5" stroke="#000000" stroke-width="0.8" opacity="0.6"/>
                        </svg>
                    </div>
                ` : '';
                const walkingIcon = isWalking ? `
                    <div class="walking-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- Person walking - head -->
                            <circle cx="10" cy="5" r="2" fill="#2563eb"/>
                            <!-- Body/torso -->
                            <path d="M10 7L9 10.5L11 12.5L11.5 9.5L10 7Z" fill="#2563eb"/>
                            <!-- Left leg (back, bent) -->
                            <path d="M9 10.5L7.5 15L9 16.5L10.5 13L9 10.5Z" fill="#2563eb"/>
                            <!-- Right leg (front, stepping forward) -->
                            <path d="M11 12.5L11.5 9.5L13.5 13.5L12.5 15L11 12.5Z" fill="#2563eb"/>
                            <!-- Left arm (swinging back) -->
                            <path d="M9 8.5L7 7.5L6 9.5L8 10.5L9 8.5Z" fill="#2563eb"/>
                            <!-- Right arm (swinging forward) -->
                            <path d="M11 7.5L12 6.5L13.5 8.5L12.5 10L11 7.5Z" fill="#2563eb"/>
                        </svg>
                    </div>
                ` : '';
                janHTML += `
                    <div class="calendar-day ${isPublicHoliday ? 'weekend' : ''} jan">
                        <div class="calendar-day-number">${day}</div>
                        ${bloodIcon}
                        ${footballIcon}
                        ${walkingIcon}
                        <div id="jan-${day}-notes" class="calendar-day-events"></div>
                    </div>
                `;
            }
            janContainer.innerHTML = janHTML;
            
            // February 2026
            const febContainer = document.getElementById('calendar-feb-2026');
            const feb2026 = new Date(2026, 1, 1);
            const febDaysInMonth = new Date(2026, 2, 0).getDate();
            const febFirstDay = feb2026.getDay();
            
            let febHTML = '';
            for (let i = 0; i < febFirstDay; i++) {
                febHTML += '<div class="calendar-day empty"></div>';
            }
            for (let day = 1; day <= febDaysInMonth; day++) {
                const dayOfWeek = (febFirstDay + day - 1) % 7;
                const isPublicHoliday = dayOfWeek === 0 || dayOfWeek === 5;
                const isBloodDonation = day === 5;
                const bloodIcon = isBloodDonation ? `
                    <div class="blood-donation-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C10.5 2 9 3.5 9 5C9 6.5 9.5 8 10.5 9.5C11.5 11 12 12.5 12 14C12 12.5 12.5 11 13.5 9.5C14.5 8 15 6.5 15 5C15 3.5 13.5 2 12 2ZM12 14L10.5 17.5L12 21L13.5 17.5L12 14Z" fill="#dc2626"/>
                        </svg>
                    </div>
                ` : '';
                febHTML += `
                    <div class="calendar-day ${isPublicHoliday ? 'weekend' : ''} feb">
                        <div class="calendar-day-number">${day}</div>
                        ${bloodIcon}
                        <div id="feb-${day}-notes" class="calendar-day-events"></div>
                    </div>
                `;
            }
            febContainer.innerHTML = febHTML;
        }
        
        // Format time AM/PM
        function formatTimeAMPM(timeString) {
            // Return empty string if no time provided
            if (!timeString) return '';
            
            // Check if timeString is a valid time format (HH:MM or H:MM)
            if (!timeString.includes(':')) return '';
            
            const [hours, minutes] = timeString.split(':');
            let hour = parseInt(hours);
            
            // If parsing failed or resulted in NaN, return empty string
            if (isNaN(hour) || !minutes) return '';
            
            const ampm = hour >= 12 ? 'PM' : 'AM';
            if (hour === 0) hour = 12;
            else if (hour > 12) hour = hour - 12;
            
            return `${hour}:${minutes} ${ampm}`;
        }
        
        // Load calendar events - using same logic as index.html
        async function loadAllCalendarEvents() {
            try {
                console.log('Memuatkan acara kalendar...');
                console.log('CalendarEventsAPI tersedia:', typeof CalendarEventsAPI !== 'undefined');
                
                if (typeof CalendarEventsAPI === 'undefined') {
                    console.error('CalendarEventsAPI tidak ditakrifkan! Pastikan api-client.js dimuatkan.');
                    alert('Ralat: CalendarEventsAPI tidak dijumpai. Sila pastikan api-client.js dimuatkan.');
                    return;
                }
                
                const result = await CalendarEventsAPI.getAll();
                console.log('Respons API:', result);
                
                if (!result) {
                    console.error('API mengembalikan null atau undefined');
                    alert('Ralat: API tidak mengembalikan respons. Sila semak konsol untuk butiran.');
                    return;
                }
                
                if (!result.success) {
                    console.error('API mengembalikan ralat:', result);
                    alert('Ralat memuatkan acara kalendar: ' + (result.message || 'Ralat tidak diketahui'));
                    return;
                }
                
                const events = result.data || [];
                console.log('Acara dimuatkan:', events.length, events);
                
                if (events.length === 0) {
                    console.log('Tiada acara dalam pangkalan data - ini adalah normal jika tiada acara ditambah lagi');
                    // Don't show alert for empty database, just log it
                    return;
                }
                
                // Clear all existing events
                document.querySelectorAll('.calendar-day-events').forEach(el => {
                    el.innerHTML = '';
                });
                
                // Group events by month and day
                // Normalize month values: 'dec' or 'December' -> 'dec', 'jan' or 'January' -> 'jan'
                const eventsByDay = {};
                events.forEach(event => {
                    let month = event.month ? event.month.toLowerCase() : '';
                    // Normalize month names
                    if (month === 'december' || month === '12') month = 'dec';
                    if (month === 'january' || month === '1') month = 'jan';
                    if (month === 'february' || month === 'februari' || month === '2') month = 'feb';
                    
                    const day = event.day;
                    const key = `${month}-${day}`;
                    
                    console.log(`Processing event: month="${event.month}" -> "${month}", day="${day}", key="${key}"`);
                    
                    if (!eventsByDay[key]) {
                        eventsByDay[key] = [];
                    }
                    eventsByDay[key].push(event);
                });
                
                console.log('Events grouped by day:', eventsByDay);
                console.log('All keys:', Object.keys(eventsByDay));
                
                // Display events - using same format as index.html with venue
                let eventsDisplayed = 0;
                Object.keys(eventsByDay).forEach(key => {
                    const dayEvents = eventsByDay[key];
                    // Sort events: Mesyuarat first, then Bergambar Ramai, then others alphabetically
                    dayEvents.sort((a, b) => {
                        const at = (a.event_title || a.title || '').toLowerCase();
                        const bt = (b.event_title || b.title || '').toLowerCase();
                        
                        // Priority order: 1) Mesyuarat, 2) Bergambar Ramai, 3) Others alphabetically
                        const aIsMesyuarat = at.includes('mesyuarat');
                        const bIsMesyuarat = bt.includes('mesyuarat');
                        const aIsBergambar = at.includes('bergambar');
                        const bIsBergambar = bt.includes('bergambar');
                        
                        // Mesyuarat always comes first
                        if (aIsMesyuarat && !bIsMesyuarat) return -1;
                        if (!aIsMesyuarat && bIsMesyuarat) return 1;
                        
                        // If both are Mesyuarat, sort by number (08 before 07, etc.)
                        if (aIsMesyuarat && bIsMesyuarat) {
                            return at.localeCompare(bt);
                        }
                        
                        // Bergambar Ramai comes second (after Mesyuarat)
                        if (aIsBergambar && !bIsBergambar && !bIsMesyuarat) return -1;
                        if (!aIsBergambar && bIsBergambar && !aIsMesyuarat) return 1;
                        
                        // Otherwise sort alphabetically
                        return at.localeCompare(bt);
                    });
                    const [month, day] = key.split('-');
                    const el = document.getElementById(`${key}-notes`);
                    
                    console.log(`Looking for element: ${key}-notes`, el);
                    
                    if (el) {
                        // Find the parent calendar-day element
                        const dayEl = el.closest('.calendar-day');
                        
                        let html = '';
                        const colors = ['#1f2937', '#991b1b', '#166534']; // black, dark red, dark green
                        dayEvents.forEach((event, index) => {
                            const formattedTime = formatTimeAMPM(event.event_time);
                            const displayTime = formattedTime ? formattedTime + ' ' : '';
                            const color = colors[index % colors.length];
                            const eventTitle = event.event_title || '';
                            const venue = event.venue ? ` @${event.venue}` : '';
                            html += `<div style="margin-bottom: 2px; line-height: 1.2; color: ${color}; font-weight: ${dayEvents.length > 1 ? '600' : '400'}; font-size: 0.6rem;">• ${displayTime}${eventTitle}${venue}</div>`;
                        });
                        el.innerHTML = html;
                        eventsDisplayed += dayEvents.length;
                        
                        // Update day number color if multiple events
                        if (dayEl && dayEvents.length > 1) {
                            const dayNumberEl = dayEl.querySelector('.calendar-day-number');
                            if (dayNumberEl) {
                                const colors = ['#1f2937', '#991b1b', '#166534'];
                                dayNumberEl.style.color = colors[(dayEvents.length - 1) % colors.length];
                                dayNumberEl.style.fontWeight = '700';
                            }
                        }
                    } else {
                        console.warn('Element not found for:', key, 'Expected ID:', `${key}-notes`);
                    }
                });
                
                console.log(`Memaparkan ${eventsDisplayed} acara merentasi ${Object.keys(eventsByDay).length} hari`);
                
                console.log('Acara kalendar berjaya dimuatkan');
            } catch (error) {
                console.error('Ralat memuatkan acara kalendar:', error);
                alert('Ralat memuatkan acara kalendar. Sila semak konsol untuk butiran.');
            }
        }
        
        // Fix viewport height for mobile browsers
        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        // Check if user is logged in and show home button
        function checkLoginStatus() {
            try {
                if (typeof AuthAPI !== 'undefined' && AuthAPI.isLoggedIn()) {
                    const homeButton = document.getElementById('viewerHomeButton');
                    if (homeButton) {
                        homeButton.classList.add('show');
                    }
                }
            } catch (error) {
                console.log('AuthAPI not available or user not logged in');
            }
        }
        
        // Initialize - No authentication required for viewer
        window.onload = async function() {
            // This page is accessible without login for viewer roles
            // No authentication check needed
            
            // Check if user is logged in to show home button
            checkLoginStatus();
            
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            
            // Generate calendar first
            generateCalendar();
            updateCountdown();
            setInterval(updateCountdown, 1000);
            
            // Wait for calendar to fully render, then load events
            setTimeout(async () => {
                console.log('Starting to load calendar events...');
                await loadAllCalendarEvents();
                await loadCenderahatiData();
                
                // Fix Row 7 after data is loaded
                setTimeout(() => {
                    forceRow7SubRow1Keterangan();
                    forceReplaceRow7CenderahatiText();
                    ultraAggressiveRow7CenderahatiCleanup(); // ULTRA-AGGRESSIVE
                    aggressivelyCleanRow7();
                    verifyRow7Cenderahati();
                    aggressivelyRemoveTextFromCenderahati();
                    removeAllRepeatingTextAndCleanColumns();
                    // Run ultra-aggressive cleanup multiple times with delays
                    setTimeout(ultraAggressiveRow7CenderahatiCleanup, 100);
                    setTimeout(ultraAggressiveRow7CenderahatiCleanup, 200);
                    setTimeout(ultraAggressiveRow7CenderahatiCleanup, 500);
                    setTimeout(ultraAggressiveRow7CenderahatiCleanup, 1000);
                    setTimeout(ultraAggressiveRow7CenderahatiCleanup, 2000);
                }, 300);
            }, 500);
        };
        
        // ============================================
        // Cenderahati Functions
        // ============================================
        
        async function loadCenderahatiData() {
            try {
                console.log('Loading cenderahati data...');
                const response = await CenderahatiAPI.getAll();
                
                if (response.success && response.data) {
                    console.log('Cenderahati data loaded:', response.data);
                    
                    // Update all input fields with saved values
                    document.querySelectorAll('.cenderahati-input').forEach(input => {
                        const category = input.dataset.category ||
                            (input.closest('tr')?.querySelector('td:nth-child(2)')?.textContent.trim()) ||
                            (input.closest('tr')?.querySelector('td:first-child')?.textContent.trim());
                        if (category && response.data[category]) {
                            input.value = response.data[category].count;
                        }
                    });
                    
                    // Update total after loading data
                    updateCenderahatiTotal();
                } else {
                    console.log('No cenderahati data found or failed to load');
                }
            } catch (error) {
                console.error('Error loading cenderahati data:', error);
            }
        }
        
        async function saveCenderahatiData(category, count) {
            try {
                console.log(`Saving cenderahati for ${category}: ${count}`);
                const response = await CenderahatiAPI.save(category, count);
                
                if (response.success) {
                    console.log('Cenderahati saved successfully:', response);
                    // Show success indicator
                    showSaveIndicator('✓ Saved', 'success');
                    // Update total after saving
                    updateCenderahatiTotal();
                } else {
                    console.error('Failed to save cenderahati:', response);
                    showSaveIndicator('✗ Error', 'error');
                }
            } catch (error) {
                console.error('Error saving cenderahati:', error);
                showSaveIndicator('✗ Error', 'error');
            }
        }
        
        function updateCenderahatiTotal() {
            let total = 0;
            document.querySelectorAll('.cenderahati-input').forEach(input => {
                const value = parseInt(input.value) || 0;
                total += value;
            });
            
            const header = document.getElementById('cenderahati-header');
            if (header) {
            header.textContent = `Cenderahati hp105`;
            }
            
            console.log('Cenderahati total updated:', total);
        }
        
        function showSaveIndicator(message, type) {
            // Create or get existing indicator
            let indicator = document.getElementById('cenderahati-save-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'cenderahati-save-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    padding: 10px 20px;
                    border-radius: 8px;
                    font-weight: 600;
                    z-index: 10000;
                    transition: opacity 0.3s;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                `;
                document.body.appendChild(indicator);
            }
            
            indicator.textContent = message;
            indicator.style.backgroundColor = type === 'success' ? '#10b981' : '#ef4444';
            indicator.style.color = 'white';
            indicator.style.opacity = '1';
            indicator.style.display = 'block';
            
            // Hide after 2 seconds
            setTimeout(() => {
                indicator.style.opacity = '0';
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 300);
            }, 2000);
        }

        // -----------------------------
        // Super admin check helper
        // -----------------------------
        function isSuperAdmin() {
            try {
                if (!AuthAPI || !AuthAPI.isLoggedIn()) return false;
                const user = AuthAPI.getCurrentUser();
                if (!user) return false;
                if (user.roles && user.roles.some(r => ['super-admin', 'superadmin', 'admin'].includes(String(r).toLowerCase()))) return true;
                if (user.role && String(user.role).toLowerCase().includes('admin')) return true;
                if (user.username && String(user.username).toLowerCase().includes('admin')) return true;
                return false;
            } catch (e) {
                console.warn('isSuperAdmin check failed', e);
                return false;
            }
        }

        // -----------------------------
        // Checklist editing (existing rows only)
        // -----------------------------
        const checklistFallback = [
            { category: 'Perbarisan', keterangan: 'Anggaran Perbelanjaan merangkumi 7 hari latihan dan Majlis kemucak perbarisan', tindakan: 'P. Perbarisan', cenderahati: '376', goodies: '-', budget: '$35,065.50' },
            { category: 'Mkn Beradat', keterangan: '<div>Raptai makan beradat bersama Pengerusi pada 10/01/2026 dan bersama PJP 13/01/2026. Support Staff untuk 15/01/2026</div><div>Makan beradat pada 15/01/2026 (belum termasuk support staffs)</div>', tindakan: ['P. Permakanan','Setiausaha Mes'], cenderahati: ['',''], goodies: ['-','-'], budget: ['$1,011.50','$19,438.00'] },
            { category: 'Keagamaan', keterangan: '<div>Mencetak Surah Yassin sebanyak 300 Softcover dan 50 Hardtcover (Ezy Printing)</div><div>Majlis Doa Kesyukuran HP105 : perbelanjaan kelengkapan &amp; permakanan</div>', tindakan: ['BUI',''], cenderahati: ['',''], goodies: ['-','-'], budget: ['$1,275.00','$1,325.00'] },
            { category: 'Pameran', keterangan: 'Pameran diadakan selama dua(2) hari', tindakan: 'P. Pameran', cenderahati: '50', goodies: '600', budget: '$9,750.00' },
            { category: 'Daerah TT', keterangan: '<div>Kejohanan Bolasepak</div>', tindakan: 'OCPD TT', cenderahati: '41', goodies: '210', budget: '$2,328.50' },
            { category: 'Daerah BM', keterangan: '<div>Kempen Derma Darah</div><div>Gotong Royong</div><div>Walkaton</div>', tindakan: ['P. Derma Darah','OCPD BM',''], cenderahati: ['','','5'], goodies: ['100','-','145'], budget: '$1,680.00' },
            { category: 'Daerah Belait', keterangan: 'Open day', tindakan: 'OCPD Belait', cenderahati: ['1','-','-'], goodies: ['500','-','100'], budget: '$1,791.00' },
            { category: 'Daerah Temb', keterangan: '<div>Kempen Derma Darah </div><div>Gotong Royong </div><div>Community Engagement @ POLSARA </div>', tindakan: 'OCPD Temb', cenderahati: ['','','20'], goodies: ['100','-','60'], budget: '$838.70' },
            { category: 'Kelengkapan', keterangan: 'Perbelanjaan penyewaan kem, backdrop, fabric ceiling, Pull-up banners (4 sets)', tindakan: 'P. Kelengkapan', cenderahati: '-', goodies: '-', budget: '$18,367.30' },
            { category: 'PRO', keterangan: 'Digital poster HP ke -105 (tiada pencetakan)', tindakan: '', cenderahati: '-', goodies: '-', budget: '-' },
            { category: 'Cenderahati', keterangan: 'Cenderahati kepada Tetamu Kehormat, Peserta dan Pengunjung', tindakan: '', cenderahati: '493', goodies: '1815', budget: '-' }
        ];
        function getCategoryFromRow(row) {
            let cur = row;
            while (cur) {
                const tds = cur.querySelectorAll('td');
                if (tds[1] && tds[1].textContent.trim()) {
                    return tds[1].textContent.trim();
                }
                cur = cur.previousElementSibling;
            }
            return '';
        }

        function getTindakanFromRow(row) {
            let cur = row;
            while (cur) {
                const tds = cur.querySelectorAll('td');
                if (tds[2] && tds[2].textContent.trim()) {
                    return tds[2].textContent.trim();
                }
                cur = cur.previousElementSibling;
            }
            return '';
        }

        function collectChecklistRow(row) {
            const tds = row.querySelectorAll('td');
            const category = getCategoryFromRow(row);
            if (!category) return null;
            
            // Check if this row has rowspan (multi-row category)
            const categoryCell = tds[1];
            const rowspan = categoryCell ? parseInt(categoryCell.getAttribute('rowspan') || '1') : 1;
            
            let keteranganParts = [];
            let cenderahatiParts = [];
            let goodiesParts = [];
            let tindakanParts = [];
            
            if (rowspan > 1) {
                // Collect all sub-rows for this category
                let currentRow = row;
                for (let i = 0; i < rowspan && currentRow; i++) {
                    const subTds = currentRow.querySelectorAll('td');
                    if (subTds[2]) {
                        const tinText = subTds[2].textContent.trim();
                        tindakanParts.push(tinText || '');
                    }
                    if (subTds[3]) {
                        const ketText = subTds[3].textContent.trim();
                        if (ketText) keteranganParts.push(ketText);
                    }
                    if (subTds[4]) {
                        const cenInput = subTds[4].querySelector('input');
                        const cenValue = cenInput ? cenInput.value.trim() : subTds[4].textContent.trim();
                        // Push the value as-is (empty string for empty, '0' for zero, etc.)
                        cenderahatiParts.push(cenValue);
                    }
                    if (subTds[5]) {
                        const goodText = subTds[5].textContent.trim();
                        goodiesParts.push(goodText || '');
                    }
                    currentRow = currentRow.nextElementSibling;
                }
            } else {
                // Single row
                if (tds[2]) {
                    const tinText = tds[2].textContent.trim();
                    tindakanParts.push(tinText || '');
                }
                if (tds[3]) {
                    const ketText = tds[3].textContent.trim();
                    if (ketText) keteranganParts.push(ketText);
                }
                if (tds[4]) {
                    const cenInput = tds[4].querySelector('input');
                    const cenValue = cenInput ? cenInput.value.trim() : tds[4].textContent.trim();
                    cenderahatiParts.push(cenValue || '');
                }
                if (tds[5]) {
                    const goodText = tds[5].textContent.trim();
                    goodiesParts.push(goodText || '');
                }
            }
            
            // Combine keterangan into div format if multiple, or plain text if single
            const keterangan = keteranganParts.length > 1 
                ? keteranganParts.map(k => `<div>${k}</div>`).join('')
                : (keteranganParts[0] || '');
            
            // Return arrays for tindakan/cenderahati/goodies if multiple, single value if one
            return {
                category,
                activity1: '',
                activity2: '',
                activity3: '',
                activity4: '',
                tindakan: tindakanParts.length > 1 ? tindakanParts : (tindakanParts[0] || ''),
                keterangan: keterangan,
                cenderahati: cenderahatiParts.length > 1 ? cenderahatiParts : (cenderahatiParts[0] || ''),
                goodies: goodiesParts.length > 1 ? goodiesParts : (goodiesParts[0] || '')
            };
        }

        async function loadChecklistData() {
            try {
                // CRITICAL: NEW CLEAN TABLE - DO NOT OVERWRITE HTML VALUES
                // The HTML table now contains clean data from CSV file
                // Database may have corrupted data, so we skip loading it
                console.log('⚠️ NEW CLEAN TABLE DETECTED - Skipping database load to prevent corruption');
                console.log('✅ Using clean HTML table values from CSV file');
                
                const res = await ChecklistAPI.getAll();
                if (!res || !res.success || !res.data) {
                    console.log('No database data found - using clean HTML table');
                    return false;
                }
                
                // Log that we're skipping database updates
                console.log('Database data exists but will NOT overwrite clean HTML table');
                console.log('CSV sync will enforce correct values instead');
                
                // Return early - do NOT update HTML table with database values
                // The syncAllValuesFromCSV() function will ensure all values are correct
                return false; // Indicate no database data was applied
            } catch (err) {
                console.error('Checklist load error', err);
                return false;
            }
        }

        async function applyChecklistFallback(force = false) {
            try {
                const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
                rows.forEach(row => {
                    if (row.classList.contains('total-row')) return;
                    const tds = row.querySelectorAll('td');
                    const category = tds[1] ? tds[1].textContent.trim() : '';
                    const rowData = checklistFallback.find(r => r.category.toLowerCase() === category.toLowerCase());
                    if (!rowData) return;
                    if (!force) {
                        // If the row already has any content, skip unless force is true
                        const existing = [tds[2], tds[3], tds[4], tds[5], tds[6]].some(td => td && td.textContent.trim());
                        if (existing) return;
                    }
                    // Column order: Bil | Perkara | Tindakan | Keterangan | Cenderahati | Goodies | Budget
                    if (tds[2]) tds[2].textContent = rowData.tindakan || '';
                    if (tds[3] && rowData.keterangan) tds[3].innerHTML = rowData.keterangan;
                    if (tds[4] && rowData.cenderahati !== undefined) {
                        const input = tds[4].querySelector('input');
                        if (input) {
                            if (input.classList.contains('no-fallback')) return;
                            input.value = Array.isArray(rowData.cenderahati) ? (rowData.cenderahati[0] || '') : (rowData.cenderahati || '');
                        } else {
                            tds[4].textContent = Array.isArray(rowData.cenderahati) ? (rowData.cenderahati[0] || '') : (rowData.cenderahati || '');
                        }
                    }
                    if (tds[5]) {
                        if (Array.isArray(rowData.goodies)) {
                            tds[5].textContent = rowData.goodies[0] || '';
                        } else {
                            tds[5].textContent = rowData.goodies || '';
                        }
                    }
                    if (tds[6]) {
                        if (Array.isArray(rowData.budget)) {
                            tds[6].textContent = rowData.budget[0] || '';
                        } else {
                            tds[6].textContent = rowData.budget || '';
                        }
                    }
                });
                // Only seed DB when force=true (initial empty state)
                if (force) {
                    // Collect data from the table structure (which has correct tindakan values)
                    const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
                    const processedCategories = new Set();
                    
                    for (const row of rows) {
                        if (row.classList.contains('total-row')) continue;
                        const payload = collectChecklistRow(row);
                        if (!payload || !payload.category || processedCategories.has(payload.category)) continue;
                        processedCategories.add(payload.category);
                        await ChecklistAPI.save(payload);
                    }
                }
            } catch (err) {
                console.error('Checklist fallback error', err);
            }
        }

        async function saveChecklistRow(row) {
            try {
                const payload = collectChecklistRow(row);
                if (!payload.category) return;
                const res = await ChecklistAPI.save(payload);
                if (!res || !res.success) {
                    console.warn('Gagal simpan checklist untuk ' + payload.category);
                }
            } catch (err) {
                console.error('Checklist save error', err);
            }
        }

        async function manualSaveAll() {
            try {
                const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
                const map = {};
                const processedCategories = new Set();
                
                rows.forEach(row => {
                    if (row.classList.contains('total-row')) return;
                    const tds = row.querySelectorAll('td');
                    const categoryCell = tds[1];
                    if (!categoryCell) return;
                    
                    // Skip if this is a sub-row (not the first row of a multi-row category)
                    const rowspan = parseInt(categoryCell.getAttribute('rowspan') || '1');
                    const category = categoryCell.textContent.trim();
                    if (!category || processedCategories.has(category)) return;
                    
                    // Mark this category as processed
                    processedCategories.add(category);
                    
                    const p = collectChecklistRow(row);
                    if (!p || !p.category) return;
                    
                    // Debug logging for Daerah BM
                    if (p.category === 'Daerah BM') {
                        console.log('Saving Daerah BM:', {
                            cenderahati: p.cenderahati,
                            cenderahatiType: Array.isArray(p.cenderahati) ? 'array' : typeof p.cenderahati
                        });
                    }
                    
                    map[p.category] = p;
                });
                
                const results = await Promise.all(Object.values(map).map(p => ChecklistAPI.save(p)));
                const ok = results.every(r => r && r.success);
                if (!ok) {
                    alert('Some rows failed to save.');
                } else {
                    alert('All checklist rows saved successfully!');
                    // Reload data after saving to show updated values
                    setTimeout(() => {
                        loadChecklistData().then(() => {
                            console.log('Data reloaded after save');
                        });
                    }, 500);
                }
            } catch (e) {
                console.error('manualSaveAll error', e);
                alert('Error saving checklist: ' + e.message);
            }
        }

        function enableChecklistEditing() {
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            // Allow editing for all roles
            document.querySelectorAll('.cenderahati-input').forEach(input => {
                input.disabled = false;
            });

            rows.forEach(row => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                const ketCell = tds[3];
                const goodCell = tds[5];
                if (ketCell) {
                    ketCell.contentEditable = true;
                    ketCell.querySelectorAll('div').forEach(d => {
                        d.contentEditable = true;
                        // Save when leaving the inner div
                        d.addEventListener('blur', () => saveChecklistRow(row));
                        d.addEventListener('keyup', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                saveChecklistRow(row);
                            }
                        });
                    });
                    ketCell.classList.add('editable-cell');
                    ketCell.addEventListener('blur', () => saveChecklistRow(row));
                    ketCell.addEventListener('keyup', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            saveChecklistRow(row);
                        }
                    });
                }
                if (goodCell) {
                    goodCell.contentEditable = true;
                    goodCell.querySelectorAll('div').forEach(d => {
                        d.contentEditable = true;
                        d.addEventListener('blur', () => saveChecklistRow(row));
                        d.addEventListener('keyup', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                saveChecklistRow(row);
                            }
                        });
                    });
                    goodCell.classList.add('editable-cell');
                    goodCell.addEventListener('blur', () => saveChecklistRow(row));
                    goodCell.addEventListener('keyup', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            saveChecklistRow(row);
                        }
                    });
                }
                // cenderahati inputs save on blur/change
                const cenInput = tds[4]?.querySelector('input');
                if (cenInput) {
                    cenInput.addEventListener('blur', () => saveChecklistRow(row));
                    cenInput.addEventListener('change', () => saveChecklistRow(row));
                }
            });
        }

        // -----------------------------
        // Budget editing (existing rows only)
        // -----------------------------
        function collectBudgetRow(row) {
            const tds = row.querySelectorAll('td');
            const bil = tds[0] ? tds[0].textContent.trim() : '';
            const perkara = tds[1] ? tds[1].textContent.trim() : '';
            const keterangan = tds[2] ? tds[2].textContent.trim() : '';
            // Strip currency symbols/commas; allow empty
            let perbelanjaan = tds[3] ? tds[3].textContent.trim() : '';
            perbelanjaan = perbelanjaan.replace(/[\$,]/g, '').trim();
            if (perbelanjaan === '') {
                perbelanjaan = '0';
            }
            return { bil, perkara, keterangan, perbelanjaan };
        }

        async function saveBudgetRow(row) {
            try {
                const payload = collectBudgetRow(row);
                if (!payload.bil) return; // skip rows without bil
                const res = await BudgetAPI.update(payload);
                if (!res || !res.success) {
                    alert('Gagal simpan budget untuk bil ' + payload.bil);
                }
            } catch (err) {
                console.error('Budget save error', err);
                alert('Ralat simpan budget');
            }
        }

        function enableBudgetEditing() {
            if (!isSuperAdmin()) return;
            const rows = document.querySelectorAll('#calendar-month-budget tbody tr');
            rows.forEach(row => {
                const tds = row.querySelectorAll('td');
                if (tds.length < 4) return;
                // Skip rows without bil (to prevent save errors)
                const bil = tds[0] ? tds[0].textContent.trim() : '';
                if (!bil) return;
                [1,2,3].forEach(idx => {
                    const cell = tds[idx];
                    if (!cell) return;
                    cell.contentEditable = true;
                    cell.classList.add('editable-cell');
                    cell.addEventListener('blur', () => saveBudgetRow(row));
                    cell.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            saveBudgetRow(row);
                            cell.blur();
                        }
                    });
                });
            });
        }
        
        // DIRECT FIX: Force Row 6 Gotong Royong goodies and Row 8 Community Engagement cenderahati
        // This function directly targets the specific cells by their position
        function forceSpecificCellsDirectly() {
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            let row6Found = false;
            let row8Found = false;
            
            rows.forEach((row, index) => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                if (tds.length < 3) return;
                
                const bilCell = tds[0];
                const categoryCell = tds[1];
                
                // Check if this is a main row (has bil and category) or sub-row
                const hasBil = bilCell && bilCell.textContent.trim() !== '';
                const hasCategory = categoryCell && categoryCell.textContent.trim() !== '';
                
                if (hasBil && hasCategory) {
                    // Main row - check bil and category
                    const bil = bilCell.textContent.trim();
                    const category = categoryCell.textContent.trim();
                    
                    // Row 6: Find Daerah BM and check sub-rows
                    if (bil === '6' && category === 'Daerah BM') {
                        const rowspan = parseInt(categoryCell.getAttribute('rowspan') || '1');
                        let currentSubRow = row.nextElementSibling; // Start from first sub-row
                        for (let i = 0; i < rowspan - 1 && currentSubRow; i++) {
                            const subTds = currentSubRow.querySelectorAll('td');
                            // Sub-row structure: tds[0]=Tindakan, tds[1]=Keterangan, tds[2]=Cenderahati, tds[3]=Goodies
                            const tindakan = subTds[0]?.textContent.trim() || '';
                            const keterangan = subTds[1]?.textContent.trim() || '';
                            const goodiesCell = subTds[3];
                            
                            // Check if this is Gotong Royong (sub-row 1)
                            const isGotongRoyong = tindakan === 'OCPD BM' || 
                                                 (tindakan === '' && /^300$/.test(keterangan)) || // Corrupted: keterangan="300"
                                                 keterangan.includes('Gotong Royong');
                            
                            if (isGotongRoyong && goodiesCell) {
                                row6Found = true;
                                const currentGoodies = goodiesCell.textContent.trim();
                                if (currentGoodies !== '-') {
                                    goodiesCell.textContent = '-';
                                    console.log(`forceSpecificCellsDirectly: FIXED Row 6 Gotong Royong goodies from "${currentGoodies}" to "-"`);
                                }
                                break; // Found it, exit loop
                            }
                            currentSubRow = currentSubRow.nextElementSibling;
                        }
                    }
                    
                    // Row 8: Find Daerah Temb and check sub-rows
                    if (bil === '8' && category === 'Daerah Temb') {
                        const rowspan = parseInt(categoryCell.getAttribute('rowspan') || '1');
                        let currentSubRow = row.nextElementSibling; // Start from first sub-row
                        for (let i = 0; i < rowspan - 1 && currentSubRow; i++) {
                            const subTds = currentSubRow.querySelectorAll('td');
                            // Sub-row structure: tds[0]=Keterangan, tds[1]=Cenderahati
                            const keterangan = subTds[0]?.textContent.trim() || '';
                            const cenderahatiInput = subTds[1]?.querySelector('input');
                            
                            // Check if this is Community Engagement (sub-row 2)
                            const isCommunityEngagement = keterangan && (
                                keterangan.includes('Community Engagement') || 
                                keterangan.includes('POLSARA')
                            );
                            
                            if (isCommunityEngagement && cenderahatiInput) {
                                row8Found = true;
                                const currentValue = cenderahatiInput.value.trim();
                                if (currentValue !== '20') {
                                    cenderahatiInput.value = '20';
                                    console.log(`forceSpecificCellsDirectly: FIXED Row 8 Community Engagement cenderahati from "${currentValue}" to "20"`);
                                }
                                break; // Found it, exit loop
                            }
                            currentSubRow = currentSubRow.nextElementSibling;
                        }
                    }
                }
            });
            
            if (!row6Found) console.warn('forceSpecificCellsDirectly: Row 6 Gotong Royong not found!');
            if (!row8Found) console.warn('forceSpecificCellsDirectly: Row 8 Community Engagement not found!');
        }

        // Force correct values for Daerah BM - ALWAYS runs
        function forceDaerahBMValues() {
            console.log('forceDaerahBMValues: Starting...');
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            console.log(`forceDaerahBMValues: Found ${rows.length} rows`);
            rows.forEach(row => {
                const tds = row.querySelectorAll('td');
                const categoryCell = tds[1];
                const category = categoryCell ? categoryCell.textContent.trim() : '';
                if (category === 'Daerah BM') {
                    console.log('forceDaerahBMValues: Found Daerah BM row');
                    const rowspan = parseInt(categoryCell.getAttribute('rowspan') || '1');
                    console.log(`forceDaerahBMValues: Rowspan = ${rowspan}`);
                    if (rowspan > 1) {
                        // Find all Daerah BM sub-rows
                        let currentRow = row;
                        const correctCenderahati = ['', '', '5'];
                        const correctGoodies = ['100', '-', '145'];
                        for (let i = 0; i < rowspan && currentRow; i++) {
                            const subTds = currentRow.querySelectorAll('td');
                            // For sub-rows, cell indices are different due to rowspan:
                            // Sub-row 0: tds[0]=Bil, tds[1]=Perkara, tds[2]=Tindakan, tds[3]=Keterangan, tds[4]=Cenderahati, tds[5]=Goodies
                            // Sub-row 1+: tds[0]=Tindakan, tds[1]=Keterangan, tds[2]=Cenderahati, tds[3]=Goodies
                            const isFirstRow = i === 0;
                            const tindakan = isFirstRow ? (subTds[2]?.textContent.trim() || '') : (subTds[0]?.textContent.trim() || '');
                            const keterangan = isFirstRow ? (subTds[3]?.textContent.trim() || '') : (subTds[1]?.textContent.trim() || '');
                            const input = isFirstRow ? (subTds[4]?.querySelector('input')) : (subTds[2]?.querySelector('input'));
                            const goodiesCell = isFirstRow ? subTds[5] : subTds[3];
                            
                            console.log(`forceDaerahBMValues: Processing sub-row ${i}, tindakan="${tindakan}", keterangan="${keterangan}", currentGoodies="${goodiesCell?.textContent.trim()}", currentCenderahati="${input?.value}"`);
                            
                            // Match by tindakan first (more reliable), then by keterangan (handle corrupted data), then by index
                            let rowIndex = i;
                            if (tindakan === 'P. Derma Darah') {
                                rowIndex = 0; // First sub-row
                            } else if (tindakan === 'OCPD BM') {
                                rowIndex = 1; // Second sub-row (Gotong Royong)
                            } else if (tindakan === '' || !tindakan) {
                                // Handle corrupted data: keterangan might be "300" (Gotong Royong) or "145" (Walkaton)
                                if (keterangan === '300' || /^300$/.test(keterangan)) {
                                    rowIndex = 1; // Second sub-row (Gotong Royong) - corrupted data
                                } else if (keterangan === '145' || /^145$/.test(keterangan)) {
                                    rowIndex = 2; // Third sub-row (Walkaton) - corrupted data
                                } else {
                                    // Fallback: use index
                                    rowIndex = i;
                                }
                            }
                            
                            console.log(`forceDaerahBMValues: Sub-row ${i} mapped to rowIndex ${rowIndex}, targetGoodies="${correctGoodies[rowIndex]}", targetCenderahati="${correctCenderahati[rowIndex]}"`);
                            
                            // Force Cenderahati values
                            if (input && correctCenderahati[rowIndex] !== undefined) {
                                const targetValue = correctCenderahati[rowIndex];
                                if (input.value !== targetValue) {
                                    input.value = targetValue;
                                    console.log(`forceDaerahBMValues: Fixed Row 6 sub-row ${i} (${tindakan || keterangan}) cenderahati to "${targetValue}"`);
                                } else {
                                    console.log(`forceDaerahBMValues: Sub-row ${i} cenderahati already correct: "${input.value}"`);
                                }
                            } else {
                                console.log(`forceDaerahBMValues: Sub-row ${i} - no input found or rowIndex out of range`);
                            }
                            
                            // Force Goodies values
                            if (goodiesCell && correctGoodies[rowIndex] !== undefined) {
                                const currentGoodies = goodiesCell.textContent.trim();
                                const targetGoodies = correctGoodies[rowIndex];
                                if (currentGoodies !== targetGoodies) {
                                    goodiesCell.textContent = targetGoodies;
                                    console.log(`forceDaerahBMValues: Fixed Row 6 sub-row ${i} (${tindakan || keterangan}) goodies from "${currentGoodies}" to "${targetGoodies}"`);
                                } else {
                                    console.log(`forceDaerahBMValues: Sub-row ${i} goodies already correct: "${currentGoodies}"`);
                                }
                            } else {
                                console.log(`forceDaerahBMValues: Sub-row ${i} - no goodiesCell found or rowIndex out of range`);
                            }
                            
                            currentRow = currentRow.nextElementSibling;
                        }
                        return; // Found it, exit
                    }
                }
            });
        }

        // Force correct values for Daerah Belait (Row 7) - ALWAYS runs
        function forceDaerahBelaitValues() {
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            rows.forEach(row => {
                const tds = row.querySelectorAll('td');
                const categoryCell = tds[1];
                if (categoryCell && categoryCell.textContent.trim() === 'Daerah Belait') {
                    const rowspan = parseInt(categoryCell.getAttribute('rowspan') || '1');
                    if (rowspan > 1) {
                        let currentRow = row;
                        const correctCenderahati = ['1', '', ''];
                        const correctGoodies = ['500', '-', '100'];
                        for (let i = 0; i < rowspan && currentRow; i++) {
                            const subTds = currentRow.querySelectorAll('td');
                            const keterangan = subTds[3]?.textContent.trim();
                            const input = subTds[4]?.querySelector('input');
                            const goodiesCell = subTds[5];
                            
                            // Force Cenderahati values
                            if (input) {
                                if (keterangan === 'Open day') {
                                    input.value = '1';
                                } else if (keterangan === 'Gotong Royong' || keterangan === 'Kempen Derma Darah') {
                                    input.value = '';
                                } else if (correctCenderahati[i] !== undefined) {
                                    input.value = correctCenderahati[i];
                                }
                            }
                            
                            // Force Goodies values
                            if (goodiesCell) {
                                if (keterangan === 'Open day') {
                                    goodiesCell.textContent = '500';
                                } else if (keterangan === 'Gotong Royong') {
                                    goodiesCell.textContent = '-';
                                } else if (keterangan === 'Kempen Derma Darah') {
                                    goodiesCell.textContent = '100';
                                } else if (correctGoodies[i] !== undefined) {
                                    goodiesCell.textContent = correctGoodies[i];
                                }
                            }
                            
                            currentRow = currentRow.nextElementSibling;
                        }
                        return;
                    }
                }
            });
        }

        // Force correct values for Cenderahati (Row 11) - ALWAYS runs
        function forceCenderahatiValues() {
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            rows.forEach(row => {
                const tds = row.querySelectorAll('td');
                const categoryCell = tds[1];
                if (categoryCell && categoryCell.textContent.trim() === 'Cenderahati') {
                    const input = tds[4]?.querySelector('input');
                    const goodiesCell = tds[5];
                    
                    // Force Cenderahati value to 493
                    if (input && input.value !== '493') {
                        input.value = '493';
                        console.log('Forced Cenderahati to 493');
                    }
                    
                    // Force Goodies value to 1815
                    if (goodiesCell && goodiesCell.textContent.trim() !== '1815') {
                        goodiesCell.textContent = '1815';
                        console.log('Forced Goodies to 1815');
                    }
                }
            });
        }

        // Force correct Keterangan for Daerah BM - ensure text, never numbers
        function forceDaerahBMKeterangan() {
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            let daeraBMRow = null;
            
            rows.forEach(row => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                const categoryCell = tds[1];
                if (!categoryCell) return;
                
                const category = categoryCell.textContent.trim();
                if (category === 'Daerah BM') {
                    daeraBMRow = row;
                    const rowspan = parseInt(categoryCell.getAttribute('rowspan') || '1');
                    
                    // Correct keterangan values from CSV
                    const correctKeterangan = [
                        'Kempen Derma Darah',
                        'Gotong Royong',
                        'Walkaton'
                    ];
                    
                    let currentRow = row;
                    for (let i = 0; i < rowspan && currentRow; i++) {
                        const subTds = currentRow.querySelectorAll('td');
                        const isFirstRow = i === 0;
                        const keteranganCell = isFirstRow ? subTds[3] : subTds[1];
                        
                        if (keteranganCell && correctKeterangan[i]) {
                            const currentKeterangan = keteranganCell.textContent.trim();
                            const expectedKeterangan = correctKeterangan[i];
                            
                            // Check if it's a number (corrupted data)
                            const isNumber = /^\d+$/.test(currentKeterangan);
                            
                            if (isNumber || currentKeterangan !== expectedKeterangan) {
                                keteranganCell.textContent = expectedKeterangan;
                                console.log(`forceDaerahBMKeterangan: Fixed sub-row ${i} keterangan from "${currentKeterangan}" to "${expectedKeterangan}"${isNumber ? ' (was corrupted number)' : ''}`);
                            }
                        }
                        currentRow = currentRow.nextElementSibling;
                    }
                }
            });
        }

        // Force correct values for Daerah Belait (Row 7) - ensure all values match CSV
        function forceDaerahBelaitValuesComplete() {
            console.log('forceDaerahBelaitValuesComplete: Starting...');
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            
            rows.forEach(row => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                const categoryCell = tds[1];
                if (!categoryCell) return;
                
                const category = categoryCell.textContent.trim();
                if (category === 'Daerah Belait ') {
                    const rowspan = parseInt(categoryCell.getAttribute('rowspan') || '1');
                    
                    // Correct values from CSV
                    const correctKeterangan = ['Open day', 'Gotong Royong', 'Kempen Derma Darah'];
                    const correctCenderahati = ['1', '-', '-'];
                    const correctGoodies = ['500', '-', '100'];
                    
                    let currentRow = row;
                    for (let i = 0; i < rowspan && currentRow; i++) {
                        const subTds = currentRow.querySelectorAll('td');
                        const isFirstRow = i === 0;
                        
                        // For Daerah Belait: tds[0]=Keterangan, tds[1]=Cenderahati, tds[2]=Goodies (for sub-rows)
                        const keteranganCell = isFirstRow ? subTds[3] : subTds[0];
                        const cenderahatiCell = isFirstRow ? subTds[4] : subTds[1];
                        const goodiesCell = isFirstRow ? subTds[5] : subTds[2];
                        
                        // Force Keterangan - AGGRESSIVELY clean and set correct text
                        if (keteranganCell && correctKeterangan[i]) {
                            // Remove any rowspan that might have been incorrectly added
                            if (keteranganCell.hasAttribute('rowspan')) {
                                keteranganCell.removeAttribute('rowspan');
                                console.log(`forceDaerahBelaitValuesComplete: Removed incorrect rowspan from sub-row ${i} keterangan cell`);
                            }
                            
                            // Remove all child nodes and set clean text
                            while (keteranganCell.firstChild) {
                                keteranganCell.removeChild(keteranganCell.firstChild);
                            }
                            
                            const currentKeterangan = keteranganCell.textContent.trim();
                            const expectedKeterangan = correctKeterangan[i];
                            
                            // Check for duplicate/repeating text patterns
                            const hasNewlines = currentKeterangan.includes('\n') || currentKeterangan.includes('\r');
                            const hasMultipleActivities = 
                                (currentKeterangan.includes('Open day') && (currentKeterangan.includes('Gotong Royong') || currentKeterangan.includes('Kempen Derma Darah'))) ||
                                (currentKeterangan.includes('Gotong Royong') && currentKeterangan.includes('Kempen Derma Darah')) ||
                                (currentKeterangan.includes('Kempen Derma Darah') && (currentKeterangan.includes('Open day') || currentKeterangan.includes('Gotong Royong')));
                            const isNumber = /^\d+$/.test(currentKeterangan);
                            const isTooLong = currentKeterangan.length > expectedKeterangan.length * 1.5;
                            
                            // ALWAYS set the correct text, even if it seems correct (to remove any hidden duplicates)
                            keteranganCell.textContent = expectedKeterangan;
                            
                            if (hasNewlines || hasMultipleActivities || isNumber || isTooLong || currentKeterangan !== expectedKeterangan) {
                                console.log(`forceDaerahBelaitValuesComplete: CLEANED Row 7 sub-row ${i + 1} keterangan from "${currentKeterangan.substring(0, 80)}..." to "${expectedKeterangan}"${isNumber ? ' (was number)' : hasMultipleActivities ? ' (had duplicates)' : hasNewlines ? ' (had newlines)' : ''}`);
                            }
                        }
                        
                        // Force Cenderahati - CRITICAL: Sub-rows 2 and 3 MUST be empty inputs with placeholder="-", NO TEXT
                        if (cenderahatiCell && correctCenderahati[i] !== undefined) {
                            // CRITICAL: For sub-rows 2 and 3, remove ALL text content from cell
                            const cellTextBefore = cenderahatiCell.textContent.trim();
                            
                            // Remove ALL child nodes except input
                            const existingInput = cenderahatiCell.querySelector('input');
                            const nodesToRemove = [];
                            for (let node of cenderahatiCell.childNodes) {
                                if (node.nodeType === Node.TEXT_NODE) {
                                    nodesToRemove.push(node);
                                } else if (node !== existingInput && node.nodeType === Node.ELEMENT_NODE) {
                                    nodesToRemove.push(node);
                                }
                            }
                            nodesToRemove.forEach(node => {
                                cenderahatiCell.removeChild(node);
                                if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                                    console.log(`forceDaerahBelaitValuesComplete: Removed text "${node.textContent.trim()}" from Row 7 sub-row ${i + 1} cenderahati cell`);
                                }
                            });
                            
                            // Clear any remaining text content
                            if (cenderahatiCell.textContent.trim() && cenderahatiCell.textContent.trim() !== '-') {
                                console.warn(`forceDaerahBelaitValuesComplete: Row 7 sub-row ${i + 1} cenderahati cell has text "${cenderahatiCell.textContent.trim()}" - clearing it`);
                                cenderahatiCell.textContent = '';
                            }
                            
                            let cenderahatiInput = existingInput;
                            
                            // If no input exists, create one
                            if (!cenderahatiInput) {
                                cenderahatiInput = document.createElement('input');
                                cenderahatiInput.type = 'number';
                                cenderahatiInput.className = 'cenderahati-input no-fallback';
                                cenderahatiInput.setAttribute('data-category', 'Daerah Belait');
                                cenderahatiInput.placeholder = '-';
                                cenderahatiInput.min = '0';
                                cenderahatiCell.appendChild(cenderahatiInput);
                                console.log(`forceDaerahBelaitValuesComplete: Created missing input for Row 7 sub-row ${i + 1} cenderahati`);
                            }
                            
                            // Ensure input type is number, not text
                            if (cenderahatiInput.type !== 'number') {
                                cenderahatiInput.type = 'number';
                                console.log(`forceDaerahBelaitValuesComplete: Changed Row 7 sub-row ${i + 1} cenderahati input type to "number"`);
                            }
                            
                            const currentValue = cenderahatiInput.value.trim();
                            const expectedValue = correctCenderahati[i] === '-' ? '' : correctCenderahati[i];
                            const expectedDisplay = correctCenderahati[i]; // For logging
                            
                            // CRITICAL: For sub-rows 2 and 3 (index 1 and 2), FORCE empty value with placeholder="-"
                            if (i === 1 || i === 2) {
                                // Force empty value and placeholder="-"
                                cenderahatiInput.value = '';
                                cenderahatiInput.placeholder = '-';
                                
                                // Ensure cell has NO text content
                                if (cenderahatiCell.textContent.trim() && cenderahatiCell.textContent.trim() !== '-') {
                                    cenderahatiCell.textContent = '';
                                }
                                
                                console.log(`forceDaerahBelaitValuesComplete: FORCED Row 7 sub-row ${i + 1} (${correctKeterangan[i]}) cenderahati to EMPTY with placeholder="-". Previous value was "${currentValue || '(empty)'}"`);
                            } else {
                                // Sub-row 1: value="1"
                                cenderahatiInput.value = expectedValue;
                                cenderahatiInput.placeholder = '0';
                                if (currentValue !== expectedValue) {
                                    console.log(`forceDaerahBelaitValuesComplete: Fixed Row 7 sub-row ${i + 1} (${correctKeterangan[i]}) cenderahati from "${currentValue || '(empty)'}" to "${expectedDisplay}"`);
                                }
                            }
                            
                            // Final verification: ensure cell has no text
                            const finalCellText = cenderahatiCell.textContent.trim();
                            if (finalCellText && finalCellText !== '-') {
                                console.error(`forceDaerahBelaitValuesComplete: ERROR - Row 7 sub-row ${i + 1} cenderahati cell STILL has text "${finalCellText}"! Clearing it now.`);
                                cenderahatiCell.textContent = '';
                            }
                        }
                        
                        // Force Goodies
                        if (goodiesCell && correctGoodies[i]) {
                            const currentGoodies = goodiesCell.textContent.trim();
                            if (currentGoodies !== correctGoodies[i]) {
                                goodiesCell.textContent = correctGoodies[i];
                                console.log(`forceDaerahBelaitValuesComplete: Fixed sub-row ${i} goodies from "${currentGoodies}" to "${correctGoodies[i]}"`);
                            }
                        }
                        
                        currentRow = currentRow.nextElementSibling;
                    }
                }
            });
        }

        // Remove duplicate/repeating text from keterangan cells
        function removeDuplicateKeteranganText() {
            console.log('removeDuplicateKeteranganText: Starting cleanup...');
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            
            rows.forEach(row => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                
                // Find keterangan cell - could be at different indices depending on row structure
                let keteranganCell = null;
                if (tds.length >= 4) {
                    // Try common positions
                    if (tds[3] && !tds[3].querySelector('input')) {
                        keteranganCell = tds[3]; // Main row: tds[3] = Keterangan
                    } else if (tds[0] && !tds[0].querySelector('input') && !tds[0].textContent.match(/^\d+$/)) {
                        keteranganCell = tds[0]; // Sub-row: tds[0] = Keterangan (for Daerah Belait/Temb)
                    } else if (tds[1] && !tds[1].querySelector('input') && !tds[1].textContent.match(/^\d+$/)) {
                        keteranganCell = tds[1]; // Sub-row: tds[1] = Keterangan (for Daerah BM)
                    }
                }
                
                if (keteranganCell) {
                    const currentText = keteranganCell.textContent.trim();
                    
                    // Check for duplicate patterns:
                    // 1. Contains newlines (multiple lines)
                    // 2. Contains multiple activity names (e.g., "Open day" AND "Gotong Royong")
                    const hasNewlines = currentText.includes('\n');
                    const hasMultipleActivities = 
                        (currentText.includes('Open day') && (currentText.includes('Gotong Royong') || currentText.includes('Kempen Derma Darah'))) ||
                        (currentText.includes('Gotong Royong') && currentText.includes('Kempen Derma Darah')) ||
                        (currentText.includes('Kempen Derma Darah') && currentText.includes('Community Engagement'));
                    
                    if (hasNewlines || hasMultipleActivities) {
                        // Extract the first/primary activity name
                        let cleanText = currentText;
                        if (hasNewlines) {
                            // Take first line
                            cleanText = currentText.split('\n')[0].trim();
                        } else if (hasMultipleActivities) {
                            // Try to identify which one is correct based on context
                            // For Row 7: Open day, Gotong Royong, Kempen Derma Darah
                            // For Row 8: Kempen Derma Darah, Gotong Royong, Community Engagement
                            const row = keteranganCell.closest('tr');
                            const tds = row.querySelectorAll('td');
                            const bilCell = tds[0];
                            const categoryCell = tds[1];
                            
                            if (bilCell && categoryCell) {
                                const bil = bilCell.textContent.trim();
                                const category = categoryCell.textContent.trim();
                                
                                // Determine correct text based on position
                                if (category === 'Daerah Belait ') {
                                    const parentRow = row;
                                    let subRowIndex = 0;
                                    let checkRow = parentRow;
                                    while (checkRow && checkRow.previousElementSibling) {
                                        const prevTds = checkRow.previousElementSibling.querySelectorAll('td');
                                        if (prevTds[1] && prevTds[1].textContent.trim() === 'Daerah Belait ') {
                                            break;
                                        }
                                        if (prevTds[0] && prevTds[0].textContent.trim() === '7') {
                                            subRowIndex++;
                                            break;
                                        }
                                        subRowIndex++;
                                        checkRow = checkRow.previousElementSibling;
                                    }
                                    
                                    const correctTexts = ['Open day', 'Gotong Royong', 'Kempen Derma Darah'];
                                    cleanText = correctTexts[subRowIndex] || cleanText.split('\n')[0].trim();
                                } else if (category === 'Daerah Temb') {
                                    const correctTexts = ['Kempen Derma Darah ', 'Gotong Royong ', 'Community Engagement @ POLSARA '];
                                    // Find sub-row index
                                    let subRowIndex = 0;
                                    let checkRow = row;
                                    while (checkRow && checkRow.previousElementSibling) {
                                        const prevTds = checkRow.previousElementSibling.querySelectorAll('td');
                                        if (prevTds[1] && prevTds[1].textContent.trim() === 'Daerah Temb') {
                                            break;
                                        }
                                        if (prevTds[0] && prevTds[0].textContent.trim() === '8') {
                                            subRowIndex++;
                                            break;
                                        }
                                        subRowIndex++;
                                        checkRow = checkRow.previousElementSibling;
                                    }
                                    cleanText = correctTexts[subRowIndex] || cleanText.split('\n')[0].trim();
                                } else {
                                    // Default: take first part
                                    cleanText = currentText.split('\n')[0].trim();
                                }
                            } else {
                                cleanText = currentText.split('\n')[0].trim();
                            }
                        }
                        
                        if (cleanText !== currentText) {
                            keteranganCell.textContent = cleanText;
                            console.log(`removeDuplicateKeteranganText: Cleaned keterangan from "${currentText.substring(0, 60)}..." to "${cleanText}"`);
                        }
                    }
                }
            });
        }

        // Remove ALL repeating text from ALL rows and columns, ensure cenderahati columns have no text
        // AGGRESSIVE: Remove ALL text from ALL cenderahati columns
        function removeAllTextFromCenderahatiColumns() {
            console.log('removeAllTextFromCenderahatiColumns: Removing ALL text from cenderahati columns...');
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            let cleanedCount = 0;
            
            rows.forEach((row, rowIndex) => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                
                // Find cenderahati cell - it's typically at index 4 for main rows, or index 1-2 for sub-rows
                // Check all possible positions
                for (let i = 0; i < tds.length; i++) {
                    const cell = tds[i];
                    if (!cell) continue;
                    
                    // Check if this is a cenderahati cell by looking for input or checking position
                    const hasInput = cell.querySelector('input.cenderahati-input');
                    const cellText = cell.textContent.trim();
                    
                    // If it has an input OR if it's in a position that could be cenderahati AND has text that's not a number
                    if (hasInput || (i >= 1 && i <= 4 && cellText && cellText !== '-' && !/^\d+$/.test(cellText) && !cellText.match(/^\$[\d,]+\.\d{2}$/))) {
                        // Get all text nodes and non-input elements
                        const nodesToRemove = [];
                        for (let node of cell.childNodes) {
                            if (node.nodeType === Node.TEXT_NODE) {
                                const text = node.textContent.trim();
                                // Remove if it's not a number, not "-", and not a currency format
                                if (text && text !== '-' && !/^\d+$/.test(text) && !text.match(/^\$[\d,]+\.\d{2}$/)) {
                                    nodesToRemove.push(node);
                                }
                            } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName !== 'INPUT') {
                                // Remove any non-input elements that contain text like "Gotong Royong", "Derma Darah", etc.
                                const elemText = node.textContent.trim();
                                if (elemText && !/^\d+$/.test(elemText) && elemText !== '-') {
                                    nodesToRemove.push(node);
                                }
                            }
                        }
                        
                        // Remove the unwanted nodes
                        nodesToRemove.forEach(node => {
                            try {
                                cell.removeChild(node);
                                cleanedCount++;
                                console.log(`removeAllTextFromCenderahatiColumns: Removed "${node.textContent.trim()}" from row ${rowIndex + 1}, cell ${i}`);
                            } catch (e) {
                                console.warn('Error removing node:', e);
                            }
                        });
                        
                        // Ensure input exists and is properly configured
                        let input = cell.querySelector('input');
                        if (!input && (hasInput || i === 4 || (i >= 1 && i <= 2))) {
                            // Create input if it should have one
                            input = document.createElement('input');
                            input.type = 'number';
                            input.className = 'cenderahati-input no-fallback';
                            input.min = '0';
                            input.placeholder = '-';
                            cell.appendChild(input);
                        }
                        
                        // Clear any remaining text content (but keep the input)
                        if (input) {
                            const finalText = cell.textContent.trim();
                            // If there's still text that's not from the input value, clear it
                            if (finalText && finalText !== input.value && finalText !== '-' && !/^\d+$/.test(finalText)) {
                                // Remove all text nodes, keep only the input
                                const textNodes = [];
                                for (let node of cell.childNodes) {
                                    if (node.nodeType === Node.TEXT_NODE) {
                                        textNodes.push(node);
                                    }
                                }
                                textNodes.forEach(node => cell.removeChild(node));
                            }
                        } else {
                            // No input, but if there's text that's not a number or dash, clear it
                            const finalText = cell.textContent.trim();
                            if (finalText && finalText !== '-' && !/^\d+$/.test(finalText) && !finalText.match(/^\$[\d,]+\.\d{2}$/)) {
                                cell.textContent = '';
                            }
                        }
                    }
                }
            });
            
            console.log(`removeAllTextFromCenderahatiColumns: Cleaned ${cleanedCount} text nodes from cenderahati columns`);
        }
        
        function removeAllRepeatingTextAndCleanColumns() {
            console.log('removeAllRepeatingTextAndCleanColumns: Cleaning ALL rows and columns...');
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            let cleanedCount = 0;
            
            rows.forEach(row => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                
                tds.forEach((td, index) => {
                    // Skip if it's a rowspan cell (bil, category, tindakan, budget)
                    if (td.hasAttribute('rowspan')) return;
                    
                    // Check if this is a cenderahati column (should only have input, no text)
                    const hasInput = td.querySelector('input.cenderahati-input') || td.querySelector('input[type="number"]');
                    if (hasInput) {
                        // This is a cenderahati column - AGGRESSIVELY remove ALL text nodes and non-input elements
                        const nodesToRemove = [];
                        for (let node of td.childNodes) {
                            if (node.nodeType === Node.TEXT_NODE) {
                                const text = node.textContent.trim();
                                // Remove ANY text that's not a number or dash
                                if (text && text !== '-' && !/^\d+$/.test(text)) {
                                    nodesToRemove.push(node);
                            }
                            } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName !== 'INPUT') {
                                // Remove any non-input elements (divs, spans, etc.) that might contain text
                                const elemText = node.textContent.trim();
                                if (elemText && !/^\d+$/.test(elemText) && elemText !== '-') {
                                    nodesToRemove.push(node);
                                }
                            }
                        }
                        
                        // Remove all unwanted nodes
                        nodesToRemove.forEach(node => {
                            try {
                                td.removeChild(node);
                                cleanedCount++;
                                console.log(`removeAllRepeatingTextAndCleanColumns: Removed "${node.textContent.trim()}" from cenderahati column`);
                            } catch (e) {
                                console.warn('Error removing node:', e);
                            }
                        });
                        
                        // Double-check: Clear any remaining text content that's not from input value
                        const inputCheck = td.querySelector('input');
                        if (inputCheck) {
                            const inputValue = inputCheck.value.trim();
                            const cellText = td.textContent.trim();
                            // If cell has text that's not the input value, clear it
                            if (cellText && cellText !== inputValue && cellText !== '-' && !/^\d+$/.test(cellText)) {
                                // Remove all remaining text nodes
                                const remainingTextNodes = [];
                                for (let node of td.childNodes) {
                                    if (node.nodeType === Node.TEXT_NODE && node !== inputCheck) {
                                        remainingTextNodes.push(node);
                                    }
                                }
                                remainingTextNodes.forEach(node => {
                                    td.removeChild(node);
                                    cleanedCount++;
                                    console.log(`removeAllRepeatingTextAndCleanColumns: Removed remaining text "${node.textContent.trim()}" from cenderahati column`);
                            });
                        }
                        
                        // Ensure input type is number
                            if (inputCheck.type !== 'number') {
                                inputCheck.type = 'number';
                            console.log(`removeAllRepeatingTextAndCleanColumns: Changed input type to "number"`);
                            }
                        } else {
                            // No input but has text - clear it completely
                            const cellText = td.textContent.trim();
                            if (cellText && cellText !== '-' && !/^\d+$/.test(cellText)) {
                                td.textContent = '';
                                cleanedCount++;
                                console.log(`removeAllRepeatingTextAndCleanColumns: Cleared text "${cellText}" from cenderahati column (no input)`);
                            }
                        }
                        return;
                    }
                    
                    // Check if this is a keterangan column (should have clean text, no duplicates)
                    const cellText = td.textContent.trim();
                    if (cellText) {
                        // Check for duplicate patterns
                        const hasNewlines = cellText.includes('\n') || cellText.includes('\r');
                        const hasMultipleActivities = 
                            (cellText.includes('Open day') && (cellText.includes('Gotong Royong') || cellText.includes('Kempen Derma Darah'))) ||
                            (cellText.includes('Gotong Royong') && cellText.includes('Kempen Derma Darah')) ||
                            (cellText.includes('Kempen Derma Darah') && (cellText.includes('Open day') || cellText.includes('Gotong Royong'))) ||
                            (cellText.includes('Kempen Derma Darah') && cellText.includes('Community Engagement')) ||
                            (cellText.includes('Gotong Royong') && cellText.includes('Community Engagement'));
                        
                        if (hasNewlines || hasMultipleActivities) {
                            // Extract the first/primary text (usually the first line or first activity)
                            let cleanText = cellText;
                            if (hasNewlines) {
                                cleanText = cellText.split(/[\n\r]+/)[0].trim();
                            } else if (hasMultipleActivities) {
                                // Try to identify correct text based on context
                                const row = td.closest('tr');
                                const rowTds = row.querySelectorAll('td');
                                const bilCell = rowTds[0];
                                const categoryCell = rowTds[1];
                                
                                if (bilCell && categoryCell) {
                                    const bil = bilCell.textContent.trim();
                                    const category = categoryCell.textContent.trim();
                                    
                                    // Determine correct text based on row and position
                                    if (category === 'Daerah Belait ') {
                                        const correctTexts = ['Open day', 'Gotong Royong', 'Kempen Derma Darah'];
                                        // Find which sub-row this is
                                        let subRowIndex = 0;
                                        let checkRow = row;
                                        while (checkRow && checkRow.previousElementSibling) {
                                            const prevTds = checkRow.previousElementSibling.querySelectorAll('td');
                                            if (prevTds[1] && prevTds[1].textContent.trim() === 'Daerah Belait ') {
                                                break;
                                            }
                                            if (prevTds[0] && prevTds[0].textContent.trim() === '7') {
                                                subRowIndex++;
                                                break;
                                            }
                                            subRowIndex++;
                                            checkRow = checkRow.previousElementSibling;
                                        }
                                        cleanText = correctTexts[subRowIndex] || cleanText.split(/[\n\r]+/)[0].trim();
                                    } else if (category === 'Daerah Temb') {
                                        const correctTexts = ['Kempen Derma Darah ', 'Gotong Royong ', 'Community Engagement @ POLSARA '];
                                        let subRowIndex = 0;
                                        let checkRow = row;
                                        while (checkRow && checkRow.previousElementSibling) {
                                            const prevTds = checkRow.previousElementSibling.querySelectorAll('td');
                                            if (prevTds[1] && prevTds[1].textContent.trim() === 'Daerah Temb') {
                                                break;
                                            }
                                            if (prevTds[0] && prevTds[0].textContent.trim() === '8') {
                                                subRowIndex++;
                                                break;
                                            }
                                            subRowIndex++;
                                            checkRow = checkRow.previousElementSibling;
                                        }
                                        cleanText = correctTexts[subRowIndex] || cleanText.split(/[\n\r]+/)[0].trim();
                                    } else if (category === 'Daerah BM') {
                                        const correctTexts = ['Kempen Derma Darah', 'Gotong Royong', 'Walkaton'];
                                        let subRowIndex = 0;
                                        let checkRow = row;
                                        while (checkRow && checkRow.previousElementSibling) {
                                            const prevTds = checkRow.previousElementSibling.querySelectorAll('td');
                                            if (prevTds[1] && prevTds[1].textContent.trim() === 'Daerah BM') {
                                                break;
                                            }
                                            if (prevTds[0] && prevTds[0].textContent.trim() === '6') {
                                                subRowIndex++;
                                                break;
                                            }
                                            subRowIndex++;
                                            checkRow = checkRow.previousElementSibling;
                                        }
                                        cleanText = correctTexts[subRowIndex] || cleanText.split(/[\n\r]+/)[0].trim();
                                    } else {
                                        cleanText = cellText.split(/[\n\r]+/)[0].trim();
                                    }
                                } else {
                                    cleanText = cellText.split(/[\n\r]+/)[0].trim();
                                }
                            }
                            
                            if (cleanText !== cellText) {
                                // Remove all child nodes and set clean text
                                while (td.firstChild) {
                                    td.removeChild(td.firstChild);
                                }
                                td.textContent = cleanText;
                                console.log(`removeAllRepeatingTextAndCleanColumns: Cleaned keterangan from "${cellText.substring(0, 60)}..." to "${cleanText}"`);
                            }
                        }
                    }
                });
            });
            
            console.log(`removeAllRepeatingTextAndCleanColumns: Cleanup complete - removed ${cleanedCount} text nodes from cenderahati columns`);
        }
        
        // DIRECT function to force replace text in Row 7 cenderahati columns with "-"
        function forceReplaceRow7CenderahatiText() {
            console.log('forceReplaceRow7CenderahatiText: Directly replacing text in Row 7 cenderahati columns...');
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            
            let foundRow7 = false;
            let subRowIndex = 0;
            
            rows.forEach(row => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                const bilCell = tds[0];
                const categoryCell = tds[1];
                
                if (bilCell && bilCell.textContent.trim() === '7' && categoryCell && categoryCell.textContent.trim() === 'Daerah Belait ') {
                    foundRow7 = true;
                    subRowIndex = 0;
                }
                
                if (foundRow7 && subRowIndex < 3) {
                    const isFirstRow = subRowIndex === 0;
                    const cenderahatiCell = isFirstRow ? tds[4] : tds[1];
                    
                    if (cenderahatiCell) {
                        const cellText = cenderahatiCell.textContent.trim();
                        const hasUnwantedText = cellText && 
                            (cellText.includes('Gotong Royong') || 
                             cellText.includes('Kempen Derma Darah') || 
                             cellText.includes('Derma Darah') ||
                             (cellText !== '-' && !/^\d+$/.test(cellText) && subRowIndex > 0));
                        
                        if (hasUnwantedText || (subRowIndex > 0 && cellText && cellText !== '-')) {
                            console.warn(`forceReplaceRow7CenderahatiText: Row 7 sub-row ${subRowIndex + 1} has text "${cellText}" - FORCING REPLACEMENT`);
                            
                            // COMPLETELY CLEAR the cell
                            cenderahatiCell.innerHTML = '';
                            
                            // Create fresh input
                            const input = document.createElement('input');
                            input.type = 'number';
                            input.className = 'cenderahati-input no-fallback';
                            input.setAttribute('data-category', 'Daerah Belait');
                            input.min = '0';
                            
                            if (subRowIndex === 0) {
                                // Sub-row 1: value="1"
                                input.value = '1';
                                input.placeholder = '0';
                            } else {
                                // Sub-rows 2 and 3: empty with placeholder="-"
                                input.value = '';
                                input.placeholder = '-';
                            }
                            
                            // Append ONLY the input
                            cenderahatiCell.appendChild(input);
                            
                            console.log(`forceReplaceRow7CenderahatiText: REPLACED Row 7 sub-row ${subRowIndex + 1} cenderahati - was "${cellText}", now empty input with placeholder="${input.placeholder}"`);
                        }
                    }
                    
                    subRowIndex++;
                    if (subRowIndex >= 3) {
                        foundRow7 = false;
                    }
                }
            });
        }
        
        // AGGRESSIVE function to remove ALL text from cenderahati columns - runs multiple times
        function aggressivelyRemoveTextFromCenderahati() {
            console.log('aggressivelyRemoveTextFromCenderahati: Starting aggressive cleanup of ALL cenderahati columns...');
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            let totalCleaned = 0;
            
            rows.forEach((row, rowIndex) => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                
                tds.forEach((td, colIndex) => {
                    // Skip rowspan cells
                    if (td.hasAttribute('rowspan')) return;
                    
                    // Check if this cell has a cenderahati input
                    const input = td.querySelector('input.cenderahati-input') || td.querySelector('input[type="number"]');
                    if (input) {
                        // This is a cenderahati cell - remove EVERYTHING except the input
                        const cellTextBefore = td.textContent.trim();
                        const inputValue = input.value.trim();
                        
                        // Remove ALL child nodes except the input
                        const nodesToKeep = [input];
                        const allNodes = Array.from(td.childNodes);
                        
                        allNodes.forEach(node => {
                            if (!nodesToKeep.includes(node)) {
                                try {
                                    td.removeChild(node);
                                    totalCleaned++;
                                    if (node.nodeType === Node.TEXT_NODE || (node.nodeType === Node.ELEMENT_NODE && node.textContent.trim())) {
                                        console.log(`aggressivelyRemoveTextFromCenderahati: Removed "${node.textContent.trim() || node.nodeName}" from row ${rowIndex + 1}, col ${colIndex}`);
                                    }
                                } catch (e) {
                                    // Node might already be removed
                                }
                            }
                        });
                        
                        // Verify final state
                        const cellTextAfter = td.textContent.trim();
                        if (cellTextAfter && cellTextAfter !== inputValue && cellTextAfter !== '-' && !/^\d+$/.test(cellTextAfter)) {
                            // Still has unwanted text - force clear
                            console.warn(`aggressivelyRemoveTextFromCenderahati: Row ${rowIndex + 1}, col ${colIndex} still has text "${cellTextAfter}" - forcing clear`);
                            // Keep only the input
                            while (td.firstChild) {
                                if (td.firstChild === input) {
                                    break;
                                }
                                td.removeChild(td.firstChild);
                            }
                            // Ensure input is at the end
                            if (!td.contains(input)) {
                                td.appendChild(input);
                            }
                        }
                    }
                });
            });
            
            console.log(`aggressivelyRemoveTextFromCenderahati: Cleaned ${totalCleaned} nodes from cenderahati columns`);
        }

        // Final verification and fix for Row 7 to match image exactly
        function finalRow7Verification() {
            console.log('finalRow7Verification: Final check to ensure Row 7 matches image exactly...');
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            
            // Exact values from image
            const imageData = [
                { keterangan: 'Open day', cenderahati: '1', goodies: '500' },
                { keterangan: 'Gotong Royong', cenderahati: '-', goodies: '-' },
                { keterangan: 'Kempen Derma Darah', cenderahati: '-', goodies: '100' }
            ];
            
            let foundRow7 = false;
            let subRowIndex = 0;
            
            rows.forEach(row => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                const bilCell = tds[0];
                const categoryCell = tds[1];
                
                if (bilCell && bilCell.textContent.trim() === '7' && categoryCell && categoryCell.textContent.trim() === 'Daerah Belait ') {
                    foundRow7 = true;
                    subRowIndex = 0;
                }
                
                if (foundRow7 && subRowIndex < 3) {
                    const isFirstRow = subRowIndex === 0;
                    const keteranganCell = isFirstRow ? tds[3] : tds[0];
                    const cenderahatiCell = isFirstRow ? tds[4] : tds[1];
                    const goodiesCell = isFirstRow ? tds[5] : tds[2];
                    const expected = imageData[subRowIndex];
                    
                    // Fix Keterangan - remove all content and set exact text
                    if (keteranganCell && expected.keterangan) {
                        while (keteranganCell.firstChild) {
                            keteranganCell.removeChild(keteranganCell.firstChild);
                        }
                        keteranganCell.textContent = expected.keterangan;
                    }
                    
                    // Fix Cenderahati - ensure it's a number input with correct value
                    if (cenderahatiCell) {
                        // Remove any text nodes
                        const textNodes = [];
                        for (let node of cenderahatiCell.childNodes) {
                            if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                                textNodes.push(node);
                            }
                        }
                        textNodes.forEach(node => cenderahatiCell.removeChild(node));
                        
                        let input = cenderahatiCell.querySelector('input');
                        if (!input) {
                            input = document.createElement('input');
                            input.type = 'number';
                            input.className = 'cenderahati-input no-fallback';
                            input.setAttribute('data-category', 'Daerah Belait');
                            input.min = '0';
                            cenderahatiCell.appendChild(input);
                        }
                        input.type = 'number';
                        const expectedValue = expected.cenderahati === '-' ? '' : expected.cenderahati;
                        input.value = expectedValue;
                        input.placeholder = expected.cenderahati === '-' ? '-' : '0';
                    }
                    
                    // Fix Goodies
                    if (goodiesCell && expected.goodies) {
                        goodiesCell.textContent = expected.goodies;
                    }
                    
                    subRowIndex++;
                    if (subRowIndex >= 3) {
                        foundRow7 = false;
                    }
                }
            });
            
            console.log('finalRow7Verification: Row 7 verification complete');
        }

        // Continuous checker for Row 7 - runs every second to ensure values stay correct
        function startRow7ContinuousFix() {
            console.log('startRow7ContinuousFix: Starting continuous fix for Row 7...');
            setInterval(() => {
                const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
                let row7Found = false;
                
                for (let row of rows) {
                    if (row.classList.contains('total-row')) continue;
                    const tds = row.querySelectorAll('td');
                    if (tds.length < 4) continue;
                    
                    const bilCell = tds[0];
                    const categoryCell = tds[1];
                    
                    if (bilCell && bilCell.textContent.trim() === '7' && categoryCell && categoryCell.textContent.trim() === 'Daerah Belait ') {
                        row7Found = true;
                        const keteranganCell = tds[3];
                        const cenderahatiCell = tds[4];
                        
                        // Check and fix keterangan
                        if (keteranganCell && keteranganCell.textContent.trim() !== 'Open day') {
                            console.log(`startRow7ContinuousFix: Fixing Row 7 sub-row 1 keterangan from "${keteranganCell.textContent.trim()}" to "Open day"`);
                            while (keteranganCell.firstChild) {
                                keteranganCell.removeChild(keteranganCell.firstChild);
                            }
                            keteranganCell.textContent = 'Open day';
                        }
                        
                        // Check and fix cenderahati sub-row 1
                        if (cenderahatiCell) {
                            const input = cenderahatiCell.querySelector('input');
                            if (input) {
                                if (input.value !== '1') {
                                    input.value = '1';
                                    input.placeholder = '0';
                                }
                                if (input.type !== 'number') {
                                    input.type = 'number';
                                }
                            }
                        }
                        
                        // Check sub-rows 2 and 3
                        let nextRow = row.nextElementSibling;
                        let subRowIndex = 1;
                        while (nextRow && subRowIndex < 3) {
                            const nextTds = nextRow.querySelectorAll('td');
                            if (nextTds.length >= 2) {
                                const nextKeterangan = nextTds[0];
                                const nextCenderahati = nextTds[1];
                                
                                // Fix keterangan
                                const expectedKeterangan = subRowIndex === 1 ? 'Gotong Royong' : 'Kempen Derma Darah';
                                if (nextKeterangan && nextKeterangan.textContent.trim() !== expectedKeterangan) {
                                    while (nextKeterangan.firstChild) {
                                        nextKeterangan.removeChild(nextKeterangan.firstChild);
                                    }
                                    nextKeterangan.textContent = expectedKeterangan;
                                }
                                
                                // Fix cenderahati - must be empty with placeholder="-"
                                if (nextCenderahati) {
                                    // Remove any text nodes
                                    const textNodes = [];
                                    for (let node of nextCenderahati.childNodes) {
                                        if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                                            textNodes.push(node);
                                        }
                                    }
                                    textNodes.forEach(n => nextCenderahati.removeChild(n));
                                    
                                    let nextInput = nextCenderahati.querySelector('input');
                                    if (!nextInput) {
                                        nextInput = document.createElement('input');
                                        nextInput.type = 'number';
                                        nextInput.className = 'cenderahati-input no-fallback';
                                        nextInput.setAttribute('data-category', 'Daerah Belait');
                                        nextInput.placeholder = '-';
                                        nextInput.min = '0';
                                        nextCenderahati.appendChild(nextInput);
                                    }
                                    nextInput.type = 'number';
                                    if (nextInput.value !== '') {
                                        nextInput.value = '';
                                    }
                                    if (nextInput.placeholder !== '-') {
                                        nextInput.placeholder = '-';
                                    }
                                    
                                    // Clear any cell text
                                    if (nextCenderahati.textContent.trim() && nextCenderahati.textContent.trim() !== '-') {
                                        nextCenderahati.textContent = '';
                                        nextCenderahati.appendChild(nextInput);
                                    }
                                }
                            }
                            nextRow = nextRow.nextElementSibling;
                            subRowIndex++;
                        }
                        break;
                    }
                }
            }, 1000); // Check every second
        }

        // MutationObserver to watch Row 7 and enforce correct values
        function setupRow7Observer() {
            console.log('setupRow7Observer: Setting up MutationObserver for Row 7...');
            const table = document.querySelector('#calendar-month-checklist tbody');
            if (!table) {
                console.warn('setupRow7Observer: Table not found, will retry...');
                setTimeout(setupRow7Observer, 500);
                return;
            }
            
            const observer = new MutationObserver((mutations) => {
                let shouldFix = false;
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' || mutation.type === 'characterData') {
                        const target = mutation.target;
                        const row = target.closest('tr');
                        if (row) {
                            const tds = row.querySelectorAll('td');
                            const bilCell = tds[0];
                            if (bilCell && bilCell.textContent.trim() === '7') {
                                shouldFix = true;
                            }
                        }
                    }
                });
                
                if (shouldFix) {
                    console.log('setupRow7Observer: Row 7 changed detected, enforcing correct values...');
                    setTimeout(() => {
                        forceRow7SubRow1Keterangan();
                        aggressivelyCleanRow7();
                        finalRow7Verification();
                    }, 50);
                }
            });
            
            // Observe the entire table for changes
            observer.observe(table, {
                childList: true,
                subtree: true,
                characterData: true
            });
            
            console.log('setupRow7Observer: MutationObserver set up successfully');
        }

        // Specifically fix Row 7 sub-row 1 keterangan to "Open day" - DIRECT approach
        function forceRow7SubRow1Keterangan() {
            console.log('forceRow7SubRow1Keterangan: Ensuring Row 7 sub-row 1 keterangan is "Open day"...');
            
            // Direct query for Row 7 - try multiple selectors
            const table = document.querySelector('#calendar-month-checklist');
            if (!table) {
                console.warn('forceRow7SubRow1Keterangan: Table not found!');
                return;
            }
            
            const rows = table.querySelectorAll('tbody tr');
            let row7Found = false;
            
            for (let row of rows) {
                if (row.classList.contains('total-row')) continue;
                const tds = row.querySelectorAll('td');
                if (tds.length < 4) continue;
                
                const bilCell = tds[0];
                const categoryCell = tds[1];
                
                // Check if this is Row 7 main row (sub-row 1) - be more flexible with category matching
                const bil = bilCell ? bilCell.textContent.trim() : '';
                const category = categoryCell ? categoryCell.textContent.trim() : '';
                
                if (bil === '7' && (category === 'Daerah Belait ' || category === 'Daerah Belait' || category.includes('Belait'))) {
                    row7Found = true;
                    const keteranganCell = tds[3]; // Sub-row 1 keterangan is at index 3
                    
                    if (keteranganCell) {
                        // Get current text - handle both textContent and innerHTML with divs
                        let currentText = '';
                        const div = keteranganCell.querySelector('div');
                        if (div) {
                            currentText = div.textContent.trim();
                        } else {
                            currentText = keteranganCell.textContent.trim();
                        }
                        
                        // AGGRESSIVELY remove all content and set "Open day"
                        while (keteranganCell.firstChild) {
                            keteranganCell.removeChild(keteranganCell.firstChild);
                        }
                        keteranganCell.textContent = 'Open day';
                        
                        // Also check cenderahati for sub-row 1
                        const cenderahatiCell = tds[4];
                        if (cenderahatiCell) {
                            // Remove any text nodes first
                            const textNodes = [];
                            for (let node of cenderahatiCell.childNodes) {
                                if (node.nodeType === Node.TEXT_NODE && node.textContent.trim() && !/^\d+$/.test(node.textContent.trim())) {
                                    textNodes.push(node);
                                }
                            }
                            textNodes.forEach(node => cenderahatiCell.removeChild(node));
                            
                            let input = cenderahatiCell.querySelector('input');
                            if (!input) {
                                input = document.createElement('input');
                                input.type = 'number';
                                input.className = 'cenderahati-input no-fallback';
                                input.setAttribute('data-category', 'Daerah Belait');
                                input.min = '0';
                                cenderahatiCell.appendChild(input);
                            }
                            if (input.value !== '1') {
                                input.value = '1';
                                input.placeholder = '0';
                                console.log(`forceRow7SubRow1Keterangan: Also fixed cenderahati to "1"`);
                            }
                        }
                        
                        if (currentText !== 'Open day' && !currentText.includes('Open day')) {
                            console.log(`✅ forceRow7SubRow1Keterangan: FIXED Row 7 sub-row 1 keterangan from "${currentText.substring(0, 50)}" to "Open day"`);
                        } else {
                            console.log(`✅ forceRow7SubRow1Keterangan: Row 7 sub-row 1 keterangan correct: "Open day"`);
                        }
                        break; // Found it, exit loop
                    }
                }
            }
            
            if (!row7Found) {
                console.warn('forceRow7SubRow1Keterangan: Row 7 not found! Table may not be loaded yet. Rows found:', rows.length);
            }
        }

        // Aggressively clean Row 7 - remove all duplicates and ensure correct structure
        function aggressivelyCleanRow7() {
            console.log('aggressivelyCleanRow7: Starting aggressive cleanup of Row 7...');
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            
            let foundRow7 = false;
            let subRowIndex = 0;
            const correctKeterangan = ['Open day', 'Gotong Royong', 'Kempen Derma Darah'];
            const correctCenderahati = ['1', '-', '-'];
            
            rows.forEach(row => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                const bilCell = tds[0];
                const categoryCell = tds[1];
                
                if (bilCell && bilCell.textContent.trim() === '7' && categoryCell && categoryCell.textContent.trim() === 'Daerah Belait ') {
                    foundRow7 = true;
                    subRowIndex = 0;
                }
                
                if (foundRow7 && subRowIndex < 3) {
                    const isFirstRow = subRowIndex === 0;
                    const keteranganCell = isFirstRow ? tds[3] : tds[0];
                    const cenderahatiCell = isFirstRow ? tds[4] : tds[1];
                    
                    // AGGRESSIVELY clean keterangan cell
                    if (keteranganCell) {
                        // Remove all child nodes
                        while (keteranganCell.firstChild) {
                            keteranganCell.removeChild(keteranganCell.firstChild);
                        }
                        // Set correct text
                        keteranganCell.textContent = correctKeterangan[subRowIndex];
                        console.log(`aggressivelyCleanRow7: Set Row 7 sub-row ${subRowIndex + 1} keterangan to "${correctKeterangan[subRowIndex]}"`);
                    }
                    
                    // AGGRESSIVELY clean cenderahati cell - FORCE REPLACE TEXT WITH "-"
                    if (cenderahatiCell) {
                        // CRITICAL: Remove EVERYTHING from the cell first
                        const cellTextBefore = cenderahatiCell.textContent.trim();
                        const hasUnwantedText = cellTextBefore && 
                            (cellTextBefore.includes('Gotong Royong') || 
                             cellTextBefore.includes('Kempen Derma Darah') || 
                             cellTextBefore.includes('Derma Darah') ||
                             (cellTextBefore !== '-' && !/^\d+$/.test(cellTextBefore)));
                        
                        if (hasUnwantedText) {
                            console.warn(`aggressivelyCleanRow7: Found unwanted text "${cellTextBefore}" in Row 7 sub-row ${subRowIndex + 1} cenderahati - FORCING REPLACEMENT`);
                            
                            // Remove ALL child nodes
                        while (cenderahatiCell.firstChild) {
                            cenderahatiCell.removeChild(cenderahatiCell.firstChild);
                        }
                        
                            // Create fresh input element
                            const input = document.createElement('input');
                        input.type = 'number';
                        input.className = 'cenderahati-input no-fallback';
                        input.setAttribute('data-category', 'Daerah Belait');
                        input.min = '0';
                        
                        // Set correct value - sub-rows 2 and 3 MUST be empty with placeholder="-"
                        const expectedValue = correctCenderahati[subRowIndex] === '-' ? '' : correctCenderahati[subRowIndex];
                        input.value = expectedValue;
                        input.placeholder = expectedValue === '' ? '-' : '0';
                        
                            // Append ONLY the input to the cell
                            cenderahatiCell.appendChild(input);
                            
                            console.log(`aggressivelyCleanRow7: REPLACED Row 7 sub-row ${subRowIndex + 1} cenderahati text "${cellTextBefore}" with empty input (placeholder="-")`);
                        } else {
                            // No unwanted text, but ensure structure is correct
                            let input = cenderahatiCell.querySelector('input');
                            if (!input) {
                                input = document.createElement('input');
                                input.type = 'number';
                                input.className = 'cenderahati-input no-fallback';
                                input.setAttribute('data-category', 'Daerah Belait');
                                input.min = '0';
                            cenderahatiCell.appendChild(input);
                        }
                        
                            const expectedValue = correctCenderahati[subRowIndex] === '-' ? '' : correctCenderahati[subRowIndex];
                            input.value = expectedValue;
                            input.placeholder = expectedValue === '' ? '-' : '0';
                            
                            // Remove any remaining text nodes
                            const textNodes = [];
                        for (let node of cenderahatiCell.childNodes) {
                                if (node.nodeType === Node.TEXT_NODE && node !== input) {
                                    textNodes.push(node);
                            }
                        }
                            textNodes.forEach(node => cenderahatiCell.removeChild(node));
                        }
                        
                        // Final verification
                        const finalCellText = cenderahatiCell.textContent.trim();
                        const finalInput = cenderahatiCell.querySelector('input');
                        const finalInputValue = finalInput ? finalInput.value.trim() : '';
                        const finalPlaceholder = finalInput ? finalInput.placeholder : '';
                        
                        if (subRowIndex === 1 || subRowIndex === 2) {
                            // Sub-rows 2 and 3 MUST be empty with placeholder="-"
                            if (finalCellText && finalCellText !== '-' && !/^\d+$/.test(finalCellText)) {
                                console.error(`aggressivelyCleanRow7: FINAL CHECK - Row 7 sub-row ${subRowIndex + 1} STILL has text "${finalCellText}" - clearing cell completely`);
                                cenderahatiCell.textContent = '';
                                if (finalInput) {
                                    cenderahatiCell.appendChild(finalInput);
                                }
                            }
                            if (finalInput && finalInputValue !== '') {
                                console.error(`aggressivelyCleanRow7: FINAL CHECK - Row 7 sub-row ${subRowIndex + 1} input has value "${finalInputValue}" - clearing it`);
                                finalInput.value = '';
                            }
                            if (finalInput && finalPlaceholder !== '-') {
                                console.error(`aggressivelyCleanRow7: FINAL CHECK - Row 7 sub-row ${subRowIndex + 1} placeholder is "${finalPlaceholder}" - setting to "-"`);
                                finalInput.placeholder = '-';
                            }
                        }
                        
                        console.log(`aggressivelyCleanRow7: Row 7 sub-row ${subRowIndex + 1} cenderahati - value="${finalInputValue || '(empty)'}", placeholder="${finalPlaceholder}", cellText="${finalCellText || '(empty)'}"`);
                    }
                    
                    subRowIndex++;
                    if (subRowIndex >= 3) {
                        foundRow7 = false;
                    }
                }
            });
        }

        // ULTRA-AGGRESSIVE: Completely replace Row 7 cenderahati cells - no matter what's in them
        function ultraAggressiveRow7CenderahatiCleanup() {
            console.log('🔥 ultraAggressiveRow7CenderahatiCleanup: ULTRA-AGGRESSIVE cleanup of Row 7 cenderahati...');
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            
            let foundRow7 = false;
            let subRowIndex = 0;
            const correctValues = ['1', '', '']; // Sub-row 1 = "1", Sub-rows 2 & 3 = empty
            const correctPlaceholders = ['0', '-', '-'];
            
            rows.forEach(row => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                const bilCell = tds[0];
                const categoryCell = tds[1];
                
                if (bilCell && bilCell.textContent.trim() === '7' && categoryCell && (categoryCell.textContent.trim() === 'Daerah Belait ' || categoryCell.textContent.trim().includes('Belait'))) {
                    foundRow7 = true;
                    subRowIndex = 0;
                }
                
                if (foundRow7 && subRowIndex < 3) {
                    const isFirstRow = subRowIndex === 0;
                    const cenderahatiCell = isFirstRow ? tds[4] : tds[1];
                    
                    if (cenderahatiCell) {
                        const cellTextBefore = cenderahatiCell.textContent.trim();
                        const hasAnyText = cellTextBefore && 
                            (cellTextBefore.includes('Gotong') || 
                             cellTextBefore.includes('Royong') || 
                             cellTextBefore.includes('Derma') || 
                             cellTextBefore.includes('Darah') ||
                             cellTextBefore.includes('Kempen') ||
                             (cellTextBefore !== '-' && !/^\d+$/.test(cellTextBefore) && subRowIndex > 0));
                        
                        // ALWAYS replace - don't check, just do it
                        if (hasAnyText || subRowIndex > 0) {
                            console.warn(`🔥 ultraAggressiveRow7CenderahatiCleanup: Row 7 sub-row ${subRowIndex + 1} has text "${cellTextBefore}" - COMPLETELY REPLACING`);
                            
                            // COMPLETELY CLEAR - use innerHTML to remove EVERYTHING
                            cenderahatiCell.innerHTML = '';
                            
                            // Create brand new input element
                            const input = document.createElement('input');
                            input.type = 'number';
                            input.className = 'cenderahati-input no-fallback';
                            input.setAttribute('data-category', 'Daerah Belait');
                            input.min = '0';
                            input.value = correctValues[subRowIndex];
                            input.placeholder = correctPlaceholders[subRowIndex];
                            
                            // Append ONLY the input
                            cenderahatiCell.appendChild(input);
                            
                            console.log(`🔥 ultraAggressiveRow7CenderahatiCleanup: REPLACED Row 7 sub-row ${subRowIndex + 1} - was "${cellTextBefore}", now value="${input.value}", placeholder="${input.placeholder}"`);
                        } else {
                            // Even if no unwanted text, ensure structure is correct
                            cenderahatiCell.innerHTML = '';
                            const input = document.createElement('input');
                            input.type = 'number';
                            input.className = 'cenderahati-input no-fallback';
                            input.setAttribute('data-category', 'Daerah Belait');
                            input.min = '0';
                            input.value = correctValues[subRowIndex];
                            input.placeholder = correctPlaceholders[subRowIndex];
                            cenderahatiCell.appendChild(input);
                        }
                    }
                    
                    subRowIndex++;
                    if (subRowIndex >= 3) {
                        foundRow7 = false;
                    }
                }
            });
        }

        // Verify Row 7 (Daerah Belait) cenderahati values match Excel file
        function verifyRow7Cenderahati() {
            console.log('verifyRow7Cenderahati: Checking Row 7 cenderahati values...');
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            
            // Expected values from Excel file
            const expectedValues = [
                { keterangan: 'Open day', cenderahati: '1' },
                { keterangan: 'Gotong Royong', cenderahati: '-' },
                { keterangan: 'Kempen Derma Darah', cenderahati: '-' }
            ];
            
            let foundRow7 = false;
            let subRowIndex = 0;
            
            rows.forEach(row => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                const bilCell = tds[0];
                const categoryCell = tds[1];
                
                if (bilCell && bilCell.textContent.trim() === '7' && categoryCell && categoryCell.textContent.trim() === 'Daerah Belait ') {
                    foundRow7 = true;
                    subRowIndex = 0;
                }
                
                if (foundRow7 && subRowIndex < 3) {
                    const isFirstRow = subRowIndex === 0;
                    const keteranganCell = isFirstRow ? tds[3] : tds[0];
                    const cenderahatiInput = isFirstRow ? tds[4]?.querySelector('input') : tds[1]?.querySelector('input');
                    
                    if (keteranganCell && cenderahatiInput && expectedValues[subRowIndex]) {
                        const currentKeterangan = keteranganCell.textContent.trim();
                        const currentCenderahati = cenderahatiInput.value.trim();
                        const expectedKeterangan = expectedValues[subRowIndex].keterangan;
                        const expectedCenderahati = expectedValues[subRowIndex].cenderahati;
                        const expectedValue = expectedCenderahati === '-' ? '' : expectedCenderahati;
                        
                        // Check for text nodes in cenderahati cell (should only have input)
                        const cenderahatiCell = isFirstRow ? tds[4] : tds[1];
                        if (cenderahatiCell) {
                            const textNodes = [];
                            // Remove ALL text nodes, especially those with words like "Gotong Royong", "Derma Darah"
                            for (let node of cenderahatiCell.childNodes) {
                                if (node.nodeType === Node.TEXT_NODE) {
                                    const text = node.textContent.trim();
                                    // Remove any text that's not a number or dash
                                    if (text && text !== '-' && !/^\d+$/.test(text)) {
                                    textNodes.push(node);
                                    }
                                }
                            }
                            if (textNodes.length > 0) {
                                textNodes.forEach(node => {
                                    cenderahatiCell.removeChild(node);
                                    console.warn(`⚠️ verifyRow7Cenderahati: Removed text node "${node.textContent.trim()}" from Row 7 sub-row ${subRowIndex + 1} cenderahati cell`);
                                });
                            }
                            // Also check if cell still has text content after removing nodes
                            const remainingText = cenderahatiCell.textContent.trim();
                            if (remainingText && remainingText !== '-' && !/^\d+$/.test(remainingText)) {
                                console.warn(`⚠️ verifyRow7Cenderahati: Cell still has text "${remainingText}" - clearing it`);
                                cenderahatiCell.textContent = '';
                            }
                            
                            // Ensure input type is number
                            if (cenderahatiInput.type !== 'number') {
                                cenderahatiInput.type = 'number';
                                console.warn(`⚠️ verifyRow7Cenderahati: Changed Row 7 sub-row ${subRowIndex + 1} cenderahati input type to "number"`);
                            }
                        }
                        
                        // Check for duplicate text in keterangan
                        const hasDuplicates = currentKeterangan.includes('\n') || 
                                            (currentKeterangan.includes('Open day') && (currentKeterangan.includes('Gotong Royong') || currentKeterangan.includes('Kempen Derma Darah'))) ||
                                            (currentKeterangan.includes('Gotong Royong') && currentKeterangan.includes('Kempen Derma Darah'));
                        
                        if (hasDuplicates || currentKeterangan !== expectedKeterangan) {
                            console.warn(`⚠️ Row 7 sub-row ${subRowIndex + 1}: keterangan has duplicates or mismatch - Expected: "${expectedKeterangan}", Got: "${currentKeterangan.substring(0, 60)}..."`);
                            // Clean and set correct text
                            while (keteranganCell.firstChild) {
                                keteranganCell.removeChild(keteranganCell.firstChild);
                            }
                            keteranganCell.textContent = expectedKeterangan;
                            console.log(`✅ Auto-fixed Row 7 sub-row ${subRowIndex + 1} keterangan to "${expectedKeterangan}"`);
                        }
                        
                        if (currentKeterangan === expectedKeterangan || hasDuplicates) {
                            if (currentCenderahati !== expectedValue) {
                                console.warn(`⚠️ Row 7 sub-row ${subRowIndex + 1} (${expectedKeterangan}): cenderahati mismatch - Expected: "${expectedCenderahati}", Got: "${currentCenderahati || '(empty)'}"`);
                                // Auto-fix
                                cenderahatiInput.value = expectedValue;
                                if (expectedValue === '') {
                                    cenderahatiInput.placeholder = '-';
                                }
                                console.log(`✅ Auto-fixed Row 7 sub-row ${subRowIndex + 1} cenderahati to "${expectedCenderahati}"`);
                            } else {
                                console.log(`✅ Row 7 sub-row ${subRowIndex + 1} (${expectedKeterangan}): cenderahati="${expectedCenderahati}" - CORRECT`);
                            }
                        }
                    }
                    
                    subRowIndex++;
                    if (subRowIndex >= 3) {
                        foundRow7 = false; // Reset after processing all 3 sub-rows
                    }
                }
            });
        }

        // Force correct values for Daerah Temb (Row 8) - ALWAYS runs
        function forceDaerahTembValues() {
            console.log('forceDaerahTembValues: Starting...');
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            console.log(`forceDaerahTembValues: Found ${rows.length} rows`);
            rows.forEach(row => {
                const tds = row.querySelectorAll('td');
                const categoryCell = tds[1];
                const category = categoryCell ? categoryCell.textContent.trim() : '';
                if (category === 'Daerah Temb') {
                    console.log('forceDaerahTembValues: Found Daerah Temb row');
                    const rowspan = parseInt(categoryCell.getAttribute('rowspan') || '1');
                    console.log(`forceDaerahTembValues: Rowspan = ${rowspan}`);
                    if (rowspan > 1) {
                        let currentRow = row;
                        // Correct values from CSV: sub-row 1="-", sub-row 2="-", sub-row 3="20"
                        const correctKeterangan = ['Kempen Derma Darah ', 'Gotong Royong ', 'Community Engagement @ POLSARA '];
                        const correctCenderahati = ['', '', '20'];
                        const correctGoodies = ['100', '-', '60'];
                        
                        for (let i = 0; i < rowspan && currentRow; i++) {
                            const subTds = currentRow.querySelectorAll('td');
                            const isFirstRow = i === 0;
                            
                            console.log(`forceDaerahTembValues: Processing sub-row ${i}, isFirstRow=${isFirstRow}, tds.length=${subTds.length}`);
                            
                            // Cell indices for Daerah Temb sub-rows
                            const keteranganCell = isFirstRow ? subTds[3] : subTds[0];
                            const cenderahatiCell = isFirstRow ? subTds[4] : subTds[1];
                            const goodiesCell = isFirstRow ? subTds[5] : subTds[2];
                            
                            console.log(`forceDaerahTembValues: Sub-row ${i} - keteranganCell=${!!keteranganCell}, cenderahatiCell=${!!cenderahatiCell}, goodiesCell=${!!goodiesCell}`);
                            
                            // Remove any rowspan from keterangan cell
                            if (keteranganCell && keteranganCell.hasAttribute('rowspan')) {
                                keteranganCell.removeAttribute('rowspan');
                                console.log(`forceDaerahTembValues: Removed rowspan from sub-row ${i} keterangan`);
                            }
                            
                            // Force Keterangan - AGGRESSIVELY clean and set
                            if (keteranganCell && correctKeterangan[i]) {
                                // Remove all child nodes first
                                while (keteranganCell.firstChild) {
                                    keteranganCell.removeChild(keteranganCell.firstChild);
                                }
                                
                                const currentKeterangan = keteranganCell.textContent.trim();
                                const expectedKeterangan = correctKeterangan[i].trim();
                                
                                // ALWAYS set the correct text
                                keteranganCell.textContent = expectedKeterangan;
                                
                                if (currentKeterangan !== expectedKeterangan) {
                                    console.log(`forceDaerahTembValues: Fixed sub-row ${i} keterangan from "${currentKeterangan.substring(0, 50)}..." to "${expectedKeterangan}"`);
                                } else {
                                    console.log(`forceDaerahTembValues: Sub-row ${i} keterangan already correct: "${expectedKeterangan}"`);
                                }
                            } else if (!keteranganCell) {
                                console.warn(`forceDaerahTembValues: Sub-row ${i} - keteranganCell not found!`);
                            }
                            
                            // Force Cenderahati - ensure it's a number input
                            if (cenderahatiCell) {
                                // Remove any text nodes
                                const textNodes = [];
                                for (let node of cenderahatiCell.childNodes) {
                                    if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                                        textNodes.push(node);
                                    }
                                }
                                textNodes.forEach(node => {
                                    cenderahatiCell.removeChild(node);
                                    console.log(`forceDaerahTembValues: Removed text "${node.textContent.trim()}" from sub-row ${i} cenderahati cell`);
                                });
                                
                                let cenderahatiInput = cenderahatiCell.querySelector('input');
                                if (!cenderahatiInput) {
                                    cenderahatiInput = document.createElement('input');
                                    cenderahatiInput.type = 'number';
                                    cenderahatiInput.className = 'cenderahati-input no-fallback';
                                    cenderahatiInput.setAttribute('data-category', 'Daerah Temb');
                                    cenderahatiInput.placeholder = '-';
                                    cenderahatiInput.min = '0';
                                    cenderahatiCell.appendChild(cenderahatiInput);
                                    console.log(`forceDaerahTembValues: Created input for sub-row ${i}`);
                                } else {
                                    if (cenderahatiInput.type !== 'number') {
                                        cenderahatiInput.type = 'number';
                                        console.log(`forceDaerahTembValues: Changed sub-row ${i} input type to "number"`);
                                    }
                                }
                                
                                if (cenderahatiInput && correctCenderahati[i] !== undefined) {
                                    const currentValue = cenderahatiInput.value.trim();
                                    const targetValue = correctCenderahati[i];
                                    if (currentValue !== targetValue) {
                                        cenderahatiInput.value = targetValue;
                                        if (targetValue === '') {
                                            cenderahatiInput.placeholder = '-';
                                        } else {
                                            cenderahatiInput.placeholder = '0';
                                        }
                                        console.log(`forceDaerahTembValues: Fixed sub-row ${i} cenderahati from "${currentValue || '(empty)'}" to "${targetValue || '-'}"`);
                                    } else {
                                        console.log(`forceDaerahTembValues: Sub-row ${i} cenderahati already correct: "${targetValue || '-'}"`);
                                    }
                                }
                            } else {
                                console.warn(`forceDaerahTembValues: Sub-row ${i} - cenderahatiCell not found!`);
                            }
                            
                            // Force Goodies
                            if (goodiesCell && correctGoodies[i]) {
                                const currentGoodies = goodiesCell.textContent.trim();
                                if (currentGoodies !== correctGoodies[i]) {
                                    goodiesCell.textContent = correctGoodies[i];
                                    console.log(`forceDaerahTembValues: Fixed sub-row ${i} goodies from "${currentGoodies}" to "${correctGoodies[i]}"`);
                                } else {
                                    console.log(`forceDaerahTembValues: Sub-row ${i} goodies already correct: "${correctGoodies[i]}"`);
                                }
                            } else if (!goodiesCell) {
                                console.warn(`forceDaerahTembValues: Sub-row ${i} - goodiesCell not found!`);
                            }
                            
                            currentRow = currentRow.nextElementSibling;
                        }
                        return;
                    }
                }
            });
        }

        // Aggressively fix Row 8 sub-row 2 (Community Engagement) - ensure it matches CSV
        function aggressivelyFixRow8SubRow2() {
            console.log('aggressivelyFixRow8SubRow2: Fixing Row 8 sub-row 2...');
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            
            let foundRow8 = false;
            let subRowIndex = 0;
            
            rows.forEach(row => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                const bilCell = tds[0];
                const categoryCell = tds[1];
                
                if (bilCell && bilCell.textContent.trim() === '8' && categoryCell && categoryCell.textContent.trim() === 'Daerah Temb') {
                    foundRow8 = true;
                    subRowIndex = 0;
                }
                
                if (foundRow8 && subRowIndex < 3) {
                    const isFirstRow = subRowIndex === 0;
                    const keteranganCell = isFirstRow ? tds[3] : tds[0];
                    const cenderahatiCell = isFirstRow ? tds[4] : tds[1];
                    const goodiesCell = isFirstRow ? tds[5] : tds[2];
                    
                    // Specifically fix sub-row 2 (Community Engagement)
                    if (subRowIndex === 2) {
                        console.log(`aggressivelyFixRow8SubRow2: Found sub-row 2, fixing...`);
                        
                        // Fix Keterangan
                        if (keteranganCell) {
                            while (keteranganCell.firstChild) {
                                keteranganCell.removeChild(keteranganCell.firstChild);
                            }
                            keteranganCell.textContent = 'Community Engagement @ POLSARA ';
                            console.log(`aggressivelyFixRow8SubRow2: Set keterangan to "Community Engagement @ POLSARA "`);
                        }
                        
                        // Fix Cenderahati
                        if (cenderahatiCell) {
                            // Remove text nodes
                            const textNodes = [];
                            for (let node of cenderahatiCell.childNodes) {
                                if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                                    textNodes.push(node);
                                }
                            }
                            textNodes.forEach(node => cenderahatiCell.removeChild(node));
                            
                            let input = cenderahatiCell.querySelector('input');
                            if (!input) {
                                input = document.createElement('input');
                                input.type = 'number';
                                input.className = 'cenderahati-input no-fallback';
                                input.setAttribute('data-category', 'Daerah Temb');
                                input.min = '0';
                                cenderahatiCell.appendChild(input);
                            }
                            input.type = 'number';
                            input.value = '20';
                            input.placeholder = '0';
                            console.log(`aggressivelyFixRow8SubRow2: Set cenderahati to "20"`);
                        }
                        
                        // Fix Goodies
                        if (goodiesCell) {
                            goodiesCell.textContent = '60';
                            console.log(`aggressivelyFixRow8SubRow2: Set goodies to "60"`);
                        }
                    }
                    
                    subRowIndex++;
                    if (subRowIndex >= 3) {
                        foundRow8 = false;
                    }
                }
            });
        }

        // Force correct budget values for all rows - ALWAYS runs
        function forceBudgetValues() {
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            const budgetMap = {
                'Perbarisan': '$35,065.50',
                'Mkn Beradat ': ['$1,011.50', '$19,438.00'],
                'Mkn Beradat': ['$1,011.50', '$19,438.00'],
                'Keagamaan': ['$1,275.00', '$1,325.00'],
                'Pameran': '$9,750.00',
                'Daerah TT ': '$2,328.50',
                'Daerah TT': '$2,328.50',
                'Daerah BM': '$1,680.00',
                'Daerah Belait ': '$1,791.00',
                'Daerah Belait': '$1,791.00',
                'Daerah Temb': '$838.70',
                'Kelengkapan': '$18,367.30',
                'PRO': '-',
                'Cenderahati': '-'
            };
            
            const processedCategories = new Set();
            
            rows.forEach(row => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                const categoryCell = tds[1];
                if (!categoryCell) return;
                
                const category = categoryCell.textContent.trim();
                if (!category) return; // Skip sub-rows where category is merged
                
                // Skip if we've already processed this category
                if (processedCategories.has(category)) return;
                
                const expectedBudget = budgetMap[category];
                if (!expectedBudget) return;
                
                const rowspan = parseInt(categoryCell.getAttribute('rowspan') || '1');
                
                if (rowspan > 1 && Array.isArray(expectedBudget)) {
                    // Multi-row category with array budgets - set each sub-row separately
                    let currentRow = row;
                    for (let i = 0; i < rowspan && currentRow; i++) {
                        const subTds = currentRow.querySelectorAll('td');
                        // For sub-rows, budget cell is at index 6 (0-indexed)
                        const subBudgetCell = subTds[6];
                        if (subBudgetCell && expectedBudget[i] !== undefined) {
                            // Remove rowspan if it exists (database might have added it)
                            if (subBudgetCell.hasAttribute('rowspan')) {
                                subBudgetCell.removeAttribute('rowspan');
                                console.log(`Removed rowspan from ${category} sub-row ${i} budget`);
                            }
                            const currentBudget = subBudgetCell.textContent.trim();
                            if (currentBudget !== expectedBudget[i]) {
                                subBudgetCell.textContent = expectedBudget[i];
                                console.log(`Forced ${category} sub-row ${i} budget to ${expectedBudget[i]}`);
                            }
                        }
                        currentRow = currentRow.nextElementSibling;
                    }
                    processedCategories.add(category);
                } else if (rowspan > 1 && typeof expectedBudget === 'string') {
                    // Multi-row category with single budget (rowspan)
                    const budgetCell = tds[6];
                    if (budgetCell) {
                        const currentBudget = budgetCell.textContent.trim();
                        if (currentBudget !== expectedBudget) {
                            budgetCell.textContent = expectedBudget;
                            console.log(`Forced ${category} budget to ${expectedBudget}`);
                        }
                    }
                    processedCategories.add(category);
                } else if (typeof expectedBudget === 'string') {
                    // Single row category
                    const budgetCell = tds[6];
                    if (budgetCell) {
                        const currentBudget = budgetCell.textContent.trim();
                        if (currentBudget !== expectedBudget) {
                            budgetCell.textContent = expectedBudget;
                            console.log(`Forced ${category} budget to ${expectedBudget}`);
                        }
                    }
                    processedCategories.add(category);
                }
            });
        }

        // Master sync function - forces ALL values from CSV exactly
        function syncAllValuesFromCSV() {
            console.log('═══════════════════════════════════════════════════════════');
            console.log('✅ NEW CLEAN TABLE SYNC - Using CSV file as source of truth');
            console.log('📋 File: acarachecklist.csv');
            console.log('🔄 Overriding any database values with CSV data');
            console.log('═══════════════════════════════════════════════════════════');
            
            const rows = Array.from(document.querySelectorAll('#calendar-month-checklist tbody tr')).filter(r => !r.classList.contains('total-row'));
            
            // EXACT data from CSV file - ordered by bil and sub-row index
            const csvData = [
                // Row 1: Perbarisan
                { bil: '1', category: 'Perbarisan', tindakan: 'P. Perbarisan', keterangan: 'Anggaran Perbelanjaan merangkumi 7 hari latihan dan Majlis kemucak perbarisan', cenderahati: '376', goodies: '-', budget: '$35,065.50' },
                
                // Row 2: Mkn Beradat - sub-row 1
                { bil: '2', category: 'Mkn Beradat ', tindakan: 'P. Permakanan', keterangan: 'Raptai makan beradat bersama Pengerusi pada 10/01/2026 dan bersama PJP 13/01/2026. Support Staff untuk 15/01/2026', cenderahati: '-', goodies: '-', budget: '$1,011.50' },
                // Row 2: Mkn Beradat - sub-row 2
                { bil: '2', category: 'Mkn Beradat ', tindakan: 'Setiausaha Mes', keterangan: 'Makan beradat pada 15/01/2026 (belum termasuk support staffs)', cenderahati: '-', goodies: '-', budget: '$19,438.00' },
                
                // Row 3: Keagamaan - sub-row 1
                { bil: '3', category: 'Keagamaan', tindakan: 'BUI', keterangan: 'Mencetak Surah Yassin sebanyak 300 Softcover dan 50 Hardtcover (Ezy Printing)', cenderahati: '-', goodies: '-', budget: '$1,275.00' },
                // Row 3: Keagamaan - sub-row 2
                { bil: '3', category: 'Keagamaan', tindakan: '', keterangan: 'Majlis Doa Kesyukuran HP105 : perbelanjaan kelengkapan & permakanan', cenderahati: '-', goodies: '-', budget: '$1,325.00' },
                
                // Row 4: Pameran
                { bil: '4', category: 'Pameran', tindakan: 'P. Pameran', keterangan: 'Pameran diadakan selama dua(2) hari', cenderahati: '50', goodies: '600', budget: '$9,750.00' },
                
                // Row 5: Daerah TT
                { bil: '5', category: 'Daerah TT ', tindakan: 'OCPD TT', keterangan: 'Kejohanan Bolasepak', cenderahati: '41', goodies: '210', budget: '$2,328.50' },
                
                // Row 6: Daerah BM - sub-row 1
                { bil: '6', category: 'Daerah BM', tindakan: 'P. Derma Darah', keterangan: 'Kempen Derma Darah', cenderahati: '-', goodies: '100', budget: '$1,680.00' },
                // Row 6: Daerah BM - sub-row 2
                { bil: '6', category: 'Daerah BM', tindakan: 'OCPD BM', keterangan: 'Gotong Royong', cenderahati: '-', goodies: '-', budget: '$1,680.00' },
                // Row 6: Daerah BM - sub-row 3
                { bil: '6', category: 'Daerah BM', tindakan: '', keterangan: 'Walkaton', cenderahati: '5', goodies: '145', budget: '$1,680.00' },
                
                // Row 7: Daerah Belait - sub-row 1
                { bil: '7', category: 'Daerah Belait ', tindakan: 'OCPD Belait', keterangan: 'Open day', cenderahati: '1', goodies: '500', budget: '$1,791.00' },
                // Row 7: Daerah Belait - sub-row 2
                { bil: '7', category: 'Daerah Belait ', tindakan: '', keterangan: 'Gotong Royong', cenderahati: '-', goodies: '-', budget: '$1,791.00' },
                // Row 7: Daerah Belait - sub-row 3
                { bil: '7', category: 'Daerah Belait ', tindakan: '', keterangan: 'Kempen Derma Darah', cenderahati: '-', goodies: '100', budget: '$1,791.00' },
                
                // Row 8: Daerah Temb - sub-row 1
                { bil: '8', category: 'Daerah Temb', tindakan: 'OCPD Temb', keterangan: 'Kempen Derma Darah ', cenderahati: '-', goodies: '100', budget: '$838.70' },
                // Row 8: Daerah Temb - sub-row 2
                { bil: '8', category: 'Daerah Temb', tindakan: '', keterangan: 'Gotong Royong ', cenderahati: '-', goodies: '-', budget: '$838.70' },
                // Row 8: Daerah Temb - sub-row 3
                { bil: '8', category: 'Daerah Temb', tindakan: '', keterangan: 'Community Engagement @ POLSARA ', cenderahati: '20', goodies: '60', budget: '$838.70' },
                
                // Row 9: Kelengkapan
                { bil: '9', category: 'Kelengkapan', tindakan: 'P. Kelengkapan', keterangan: 'Perbelanjaan penyewaan kem, backdrop, fabric ceiling, Pull-up banners (4 sets)', cenderahati: '-', goodies: '-', budget: '$18,367.30' },
                
                // Row 10: PRO
                { bil: '10', category: 'PRO', tindakan: '', keterangan: 'Digital poster HP ke -105 (tiada pencetakan)', cenderahati: '-', goodies: '-', budget: '-' },
                
                // Row 11: Cenderahati
                { bil: '11', category: 'Cenderahati', tindakan: '', keterangan: 'Cenderahati kepada Tetamu Kehormat, Peserta dan Pengunjung', cenderahati: '493', goodies: '1815', budget: '-' }
            ];
            
            // Track current bil and sub-row index as we iterate
            let currentBil = '';
            let subRowIndex = 0;
            
            rows.forEach((row) => {
                const tds = row.querySelectorAll('td');
                if (tds.length < 3) return;
                
                // Check if this row has bil number (main row)
                const bilCell = tds[0];
                const categoryCell = tds[1];
                const hasBil = bilCell && bilCell.textContent.trim() && categoryCell && categoryCell.textContent.trim();
                
                if (hasBil) {
                    // This is a main row - reset sub-row index and update bil
                    currentBil = bilCell.textContent.trim();
                    subRowIndex = 0;
                }
                
                if (!currentBil) return;
                
                // Find CSV data entry for this bil and sub-row index
                const matchingEntries = csvData.filter(d => d.bil === currentBil);
                
                // CRITICAL FIX: For Row 7, explicitly map sub-rows to correct CSV entries
                let data;
                if (currentBil === '7') {
                    // Row 7 has specific order: sub-row 0 = "Open day", sub-row 1 = "Gotong Royong", sub-row 2 = "Kempen Derma Darah"
                    const row7Map = {
                        0: matchingEntries.find(d => d.keterangan === 'Open day'),
                        1: matchingEntries.find(d => d.keterangan === 'Gotong Royong'),
                        2: matchingEntries.find(d => d.keterangan === 'Kempen Derma Darah')
                    };
                    data = row7Map[subRowIndex];
                    if (!data) {
                        // Fallback to original method if explicit mapping fails
                        data = matchingEntries[subRowIndex];
                    }
                } else {
                    // For other rows, use standard index-based lookup
                    data = matchingEntries[subRowIndex];
                }
                
                const currentSubRowIndex = subRowIndex; // Store for logging
                
                if (!data) {
                    // Increment for next iteration even if no match
                    subRowIndex++;
                    return;
                }
                
                // Increment sub-row index AFTER using it (for next iteration)
                subRowIndex++;
                
                // Determine cell structure based on row type
                let keteranganCell, cenderahatiCell, goodiesCell, budgetCell;
                
                if (hasBil) {
                    // Main row: tds[0]=Bil, tds[1]=Category, tds[2]=Tindakan, tds[3]=Keterangan, tds[4]=Cenderahati, tds[5]=Goodies, tds[6]=Budget
                    keteranganCell = tds[3];
                    cenderahatiCell = tds[4];
                    goodiesCell = tds[5];
                    budgetCell = tds[6];
                } else {
                    // Sub-row - get category from parent row
                    let parentCategory = '';
                    let parentRow = row.previousElementSibling;
                    let searchCount = 0;
                    while (parentRow && !parentRow.classList.contains('total-row') && searchCount < 10) {
                        const parentTds = parentRow.querySelectorAll('td');
                        if (parentTds.length >= 2) {
                            const parentCatCell = parentTds[1];
                            const catRowspan = parentCatCell?.getAttribute('rowspan');
                            if (catRowspan && parentCatCell.textContent.trim()) {
                                parentCategory = parentCatCell.textContent.trim();
                                break;
                            }
                        }
                        parentRow = parentRow.previousElementSibling;
                        searchCount++;
                    }
                    
                    // Use parent category or fallback to current category cell
                    const category = parentCategory || categoryCell?.textContent.trim() || '';
                    
                    if (category === 'Daerah BM') {
                        // Daerah BM: tds[0]=Tindakan, tds[1]=Keterangan, tds[2]=Cenderahati, tds[3]=Goodies
                        keteranganCell = tds[1];
                        cenderahatiCell = tds[2];
                        goodiesCell = tds[3];
                        budgetCell = null;
                    } else if (category === 'Daerah Belait ' || category === 'Daerah Temb') {
                        // Daerah Belait/Temb: tds[0]=Keterangan, tds[1]=Cenderahati, tds[2]=Goodies
                        keteranganCell = tds[0];
                        cenderahatiCell = tds[1];
                        goodiesCell = tds[2];
                        budgetCell = null;
                    } else {
                        // Row 2, 3: tds[0]=Tindakan, tds[1]=Keterangan, tds[2]=Cenderahati, tds[3]=Goodies, tds[4]=Budget
                        keteranganCell = tds[1];
                        cenderahatiCell = tds[2];
                        goodiesCell = tds[3];
                        budgetCell = tds[4] || tds[6];
                    }
                }
                
                // Apply Keterangan - always update to ensure it matches CSV
                // Special handling for Daerah BM: force text, never allow numbers
                if (keteranganCell && data.keterangan !== undefined) {
                    const keteranganDiv = keteranganCell.querySelector('div');
                    const currentKeterangan = keteranganDiv ? keteranganDiv.textContent.trim() : keteranganCell.textContent.trim();
                    const expectedKeterangan = data.keterangan.trim();
                    
                    // Check if current keterangan is a number (corrupted data) - especially for Daerah BM
                    const isNumber = /^\d+$/.test(currentKeterangan);
                    const needsUpdate = isNumber || currentKeterangan !== expectedKeterangan;
                    
                    // Normalize for comparison (handle &amp; vs &, multiple spaces)
                    const normalizeText = (text) => text.replace(/&amp;/g, '&').replace(/\s+/g, ' ').trim();
                    const normalizedCurrent = normalizeText(currentKeterangan);
                    const normalizedExpected = normalizeText(expectedKeterangan);
                    
                    if (isNumber || normalizedCurrent !== normalizedExpected) {
                        if (keteranganDiv) {
                            // Update div content
                            keteranganDiv.textContent = expectedKeterangan;
                        } else {
                            // Update cell content directly
                            keteranganCell.textContent = expectedKeterangan;
                        }
                        console.log(`Synced Row ${currentBil} sub-row ${currentSubRowIndex} keterangan: "${currentKeterangan}" -> "${expectedKeterangan}"${isNumber ? ' (was corrupted number)' : ''}`);
                    } else {
                        // Log when keterangan is already correct (for debugging Row 2 sub-row 2)
                        if (currentBil === '2' && currentSubRowIndex === 1) {
                            console.log(`Row 2 sub-row 2 keterangan already correct: "${expectedKeterangan.substring(0, 50)}..."`);
                        }
                    }
                }
                
                // Apply Cenderahati - always force correct values from CSV
                const cenderahatiInput = cenderahatiCell?.querySelector('input');
                if (cenderahatiInput) {
                    const currentValue = cenderahatiInput.value.trim();
                    const expectedValue = data.cenderahati.trim();
                    
                    if (data.cenderahati === '-') {
                        if (currentValue !== '') {
                            cenderahatiInput.value = '';
                            cenderahatiInput.placeholder = '-';
                            console.log(`Synced Row ${currentBil} sub-row ${currentSubRowIndex} cenderahati: "${currentValue}" -> "" (empty for -)`);
                        }
                    } else {
                        if (currentValue !== expectedValue) {
                            cenderahatiInput.value = expectedValue;
                            console.log(`Synced Row ${currentBil} sub-row ${currentSubRowIndex} cenderahati: "${currentValue}" -> "${expectedValue}"`);
                        }
                    }
                }
                
                // Apply Goodies
                if (goodiesCell) {
                    const currentGoodies = goodiesCell.textContent.trim();
                    if (currentGoodies !== data.goodies) {
                        goodiesCell.textContent = data.goodies;
                        console.log(`Synced Row ${currentBil} sub-row ${currentSubRowIndex} goodies: ${currentGoodies} -> ${data.goodies}`);
                    }
                }
                
                // Apply Budget
                if (!budgetCell && (currentBil === '6' || currentBil === '7' || currentBil === '8')) {
                    // Get budget from parent row
                    let parentRow = row.previousElementSibling;
                    let searchCount = 0;
                    while (parentRow && !parentRow.classList.contains('total-row') && searchCount < 10) {
                        const parentTds = parentRow.querySelectorAll('td');
                        if (parentTds.length >= 7) {
                            const budgetRowspan = parentTds[6]?.getAttribute('rowspan');
                            if (budgetRowspan) {
                                budgetCell = parentTds[6];
                                break;
                            }
                        }
                        parentRow = parentRow.previousElementSibling;
                        searchCount++;
                    }
                }
                
                if (budgetCell) {
                    // Remove rowspan for Row 2 and Row 3
                    if ((currentBil === '2' || currentBil === '3') && budgetCell.hasAttribute('rowspan')) {
                        budgetCell.removeAttribute('rowspan');
                    }
                    const currentBudget = budgetCell.textContent.trim().replace(/\s+/g, ' ');
                    const expectedBudget = data.budget.trim();
                    if (currentBudget !== expectedBudget && expectedBudget !== '-') {
                        budgetCell.textContent = data.budget;
                        console.log(`Synced Row ${currentBil} sub-row ${currentSubRowIndex} budget: ${currentBudget} -> ${expectedBudget}`);
                    }
                }
            });
            
            console.log('═══════════════════════════════════════════════════════════');
            console.log('✅ CSV Sync completed - All values should match CSV file');
            console.log('═══════════════════════════════════════════════════════════');
            
            // Verify table matches CSV
            verifyTableMatchesCSV();
        }
        
        // Verification function - checks if table matches CSV
        function verifyTableMatchesCSV() {
            console.log('🔍 Verifying table matches CSV file...');
            const rows = Array.from(document.querySelectorAll('#calendar-month-checklist tbody tr')).filter(r => !r.classList.contains('total-row'));
            
            const csvData = [
                { bil: '1', category: 'Perbarisan', tindakan: 'P. Perbarisan', keterangan: 'Anggaran Perbelanjaan merangkumi 7 hari latihan dan Majlis kemucak perbarisan', cenderahati: '376', goodies: '-', budget: '$35,065.50' },
                { bil: '2', category: 'Mkn Beradat ', tindakan: 'P. Permakanan', keterangan: 'Raptai makan beradat bersama Pengerusi pada 10/01/2026 dan bersama PJP 13/01/2026. Support Staff untuk 15/01/2026', cenderahati: '-', goodies: '-', budget: '$1,011.50' },
                { bil: '2', category: 'Mkn Beradat ', tindakan: 'Setiausaha Mes', keterangan: 'Makan beradat pada 15/01/2026 (belum termasuk support staffs)', cenderahati: '-', goodies: '-', budget: '$19,438.00' },
                { bil: '3', category: 'Keagamaan', tindakan: 'BUI', keterangan: 'Mencetak Surah Yassin sebanyak 300 Softcover dan 50 Hardtcover (Ezy Printing)', cenderahati: '-', goodies: '-', budget: '$1,275.00' },
                { bil: '3', category: 'Keagamaan', tindakan: '', keterangan: 'Majlis Doa Kesyukuran HP105 : perbelanjaan kelengkapan & permakanan', cenderahati: '-', goodies: '-', budget: '$1,325.00' },
                { bil: '4', category: 'Pameran', tindakan: 'P. Pameran', keterangan: 'Pameran diadakan selama dua(2) hari', cenderahati: '50', goodies: '600', budget: '$9,750.00' },
                { bil: '5', category: 'Daerah TT ', tindakan: 'OCPD TT', keterangan: 'Kejohanan Bolasepak', cenderahati: '41', goodies: '210', budget: '$2,328.50' },
                { bil: '6', category: 'Daerah BM', tindakan: 'P. Derma Darah', keterangan: 'Kempen Derma Darah', cenderahati: '-', goodies: '100', budget: '$1,680.00' },
                { bil: '6', category: 'Daerah BM', tindakan: 'OCPD BM', keterangan: 'Gotong Royong', cenderahati: '-', goodies: '-', budget: '$1,680.00' },
                { bil: '6', category: 'Daerah BM', tindakan: '', keterangan: 'Walkaton', cenderahati: '5', goodies: '145', budget: '$1,680.00' },
                { bil: '7', category: 'Daerah Belait ', tindakan: 'OCPD Belait', keterangan: 'Open day', cenderahati: '1', goodies: '500', budget: '$1,791.00' },
                { bil: '7', category: 'Daerah Belait ', tindakan: '', keterangan: 'Gotong Royong', cenderahati: '-', goodies: '-', budget: '$1,791.00' },
                { bil: '7', category: 'Daerah Belait ', tindakan: '', keterangan: 'Kempen Derma Darah', cenderahati: '-', goodies: '100', budget: '$1,791.00' },
                { bil: '8', category: 'Daerah Temb', tindakan: 'OCPD Temb', keterangan: 'Kempen Derma Darah ', cenderahati: '-', goodies: '100', budget: '$838.70' },
                { bil: '8', category: 'Daerah Temb', tindakan: '', keterangan: 'Gotong Royong ', cenderahati: '-', goodies: '-', budget: '$838.70' },
                { bil: '8', category: 'Daerah Temb', tindakan: '', keterangan: 'Community Engagement @ POLSARA ', cenderahati: '20', goodies: '60', budget: '$838.70' },
                { bil: '9', category: 'Kelengkapan', tindakan: 'P. Kelengkapan', keterangan: 'Perbelanjaan penyewaan kem, backdrop, fabric ceiling, Pull-up banners (4 sets)', cenderahati: '-', goodies: '-', budget: '$18,367.30' },
                { bil: '10', category: 'PRO', tindakan: '', keterangan: 'Digital poster HP ke -105 (tiada pencetakan)', cenderahati: '-', goodies: '-', budget: '-' },
                { bil: '11', category: 'Cenderahati', tindakan: '', keterangan: 'Cenderahati kepada Tetamu Kehormat, Peserta dan Pengunjung', cenderahati: '493', goodies: '1815', budget: '-' }
            ];
            
            let currentBil = '';
            let subRowIndex = 0;
            let mismatches = [];
            
            rows.forEach((row) => {
                const tds = row.querySelectorAll('td');
                if (tds.length < 3) return;
                
                const bilCell = tds[0];
                const categoryCell = tds[1];
                const hasBil = bilCell && bilCell.textContent.trim() && categoryCell && categoryCell.textContent.trim();
                
                if (hasBil) {
                    currentBil = bilCell.textContent.trim();
                    subRowIndex = 0;
                } else {
                    subRowIndex++;
                }
                
                if (!currentBil) return;
                
                const matchingEntries = csvData.filter(d => d.bil === currentBil);
                const expectedData = matchingEntries[subRowIndex];
                if (!expectedData) return;
                
                // Get actual values from table
                let actualKeterangan = '';
                let actualCenderahati = '';
                let actualGoodies = '';
                let actualBudget = '';
                
                if (hasBil) {
                    const keteranganDiv = tds[3]?.querySelector('div');
                    actualKeterangan = keteranganDiv ? keteranganDiv.textContent.trim() : (tds[3]?.textContent.trim() || '');
                    actualCenderahati = tds[4]?.querySelector('input')?.value.trim() || '';
                    actualGoodies = tds[5]?.textContent.trim() || '';
                    actualBudget = tds[6]?.textContent.trim() || '';
                } else {
                    const category = categoryCell?.textContent.trim() || '';
                    if (category === 'Daerah BM') {
                        actualKeterangan = tds[1]?.textContent.trim() || '';
                        actualCenderahati = tds[2]?.querySelector('input')?.value.trim() || '';
                        actualGoodies = tds[3]?.textContent.trim() || '';
                    } else if (category === 'Daerah Belait ' || category === 'Daerah Temb') {
                        actualKeterangan = tds[0]?.textContent.trim() || '';
                        actualCenderahati = tds[1]?.querySelector('input')?.value.trim() || '';
                        actualGoodies = tds[2]?.textContent.trim() || '';
                    } else {
                        const keteranganDiv = tds[1]?.querySelector('div');
                        actualKeterangan = keteranganDiv ? keteranganDiv.textContent.trim() : (tds[1]?.textContent.trim() || '');
                        actualCenderahati = tds[2]?.querySelector('input')?.value.trim() || '';
                        actualGoodies = tds[3]?.textContent.trim() || '';
                        actualBudget = tds[4]?.textContent.trim() || '';
                    }
                }
                
                // Normalize for comparison
                const normalizeText = (text) => text.replace(/&amp;/g, '&').replace(/\s+/g, ' ').trim();
                const normalizeKeterangan = normalizeText(actualKeterangan);
                const expectedKeterangan = normalizeText(expectedData.keterangan);
                
                // Check for mismatches
                if (normalizeKeterangan !== expectedKeterangan && !/^\d+$/.test(actualKeterangan)) {
                    mismatches.push(`Row ${currentBil} sub-row ${subRowIndex}: Keterangan mismatch - Expected: "${expectedData.keterangan.substring(0, 40)}...", Got: "${actualKeterangan.substring(0, 40)}..."`);
                }
                
                const expectedCenderahati = expectedData.cenderahati === '-' ? '' : expectedData.cenderahati;
                if (actualCenderahati !== expectedCenderahati) {
                    mismatches.push(`Row ${currentBil} sub-row ${subRowIndex}: Cenderahati mismatch - Expected: "${expectedData.cenderahati}", Got: "${actualCenderahati}"`);
                }
                
                if (actualGoodies !== expectedData.goodies) {
                    mismatches.push(`Row ${currentBil} sub-row ${subRowIndex}: Goodies mismatch - Expected: "${expectedData.goodies}", Got: "${actualGoodies}"`);
                }
                
                if (hasBil && actualBudget && expectedData.budget !== '-') {
                    const normalizedBudget = actualBudget.replace(/\s+/g, ' ').trim();
                    if (normalizedBudget !== expectedData.budget.trim()) {
                        mismatches.push(`Row ${currentBil} sub-row ${subRowIndex}: Budget mismatch - Expected: "${expectedData.budget}", Got: "${normalizedBudget}"`);
                    }
                }
                
                subRowIndex++;
            });
            
            if (mismatches.length === 0) {
                console.log('✅ VERIFICATION PASSED: Table matches CSV file perfectly!');
            } else {
                console.warn('⚠️ VERIFICATION FAILED: Found ' + mismatches.length + ' mismatches:');
                mismatches.forEach(m => console.warn('  - ' + m));
            }
        }

        // Specifically force Row 2 sub-row 2 budget to $19,438.00
        function forceRow2SubRow2Budget() {
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            rows.forEach(row => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                if (tds.length < 7) return;
                
                const bilCell = tds[0];
                const tindakanCell = tds[2];
                const budgetCell = tds[6];
                
                if (!bilCell || !tindakanCell || !budgetCell) return;
                
                const bil = bilCell.textContent.trim();
                const tindakan = tindakanCell.textContent.trim();
                
                // Check if this is Row 2 sub-row 2 (Setiausaha Mes)
                if (bil === '2' && tindakan === 'Setiausaha Mes') {
                    // Remove rowspan if exists
                    if (budgetCell.hasAttribute('rowspan')) {
                        budgetCell.removeAttribute('rowspan');
                    }
                    // Force correct budget
                    const currentBudget = budgetCell.textContent.trim().replace(/\s+/g, ' ');
                    if (currentBudget !== '$19,438.00') {
                        budgetCell.textContent = '$19,438.00';
                        console.log(`Force corrected Row 2 sub-row 2 budget from ${currentBudget} to $19,438.00`);
                    }
                }
            });
        }

        // Force correct values for empty cenderahati fields (should be empty, not 0)
        function forceEmptyCenderahatiValues() {
            const rows = document.querySelectorAll('#calendar-month-checklist tbody tr');
            rows.forEach(row => {
                if (row.classList.contains('total-row')) return;
                const tds = row.querySelectorAll('td');
                const categoryCell = tds[1];
                if (!categoryCell) return;
                
                const category = categoryCell.textContent.trim();
                const keterangan = tds[3]?.textContent.trim();
                const input = tds[4]?.querySelector('input');
                
                if (!input) return;
                
                // Fix Row 9 (Kelengkapan) - should be empty, not 0
                if (category === 'Kelengkapan') {
                    if (input.value === '0' || input.value === '') {
                        input.value = '';
                        input.placeholder = '-';
                    }
                }
                
                // Fix Row 10 (PRO) - should be empty, not 0, and fix keterangan
                if (category === 'PRO') {
                    if (input.value === '0' || input.value === '') {
                        input.value = '';
                        input.placeholder = '-';
                    }
                    // Fix keterangan text
                    const keteranganDiv = tds[3]?.querySelector('div');
                    if (keteranganDiv && !keteranganDiv.textContent.includes('Digital poster')) {
                        keteranganDiv.textContent = 'Digital poster HP ke -105 (tiada pencetakan)';
                    }
                }
                
                // Fix Daerah Belait - Gotong Royong and Kempen Derma Darah should be empty
                if (category === 'Daerah Belait' || category === 'Daerah Belait ') {
                    if (keterangan === 'Gotong Royong' || keterangan === 'Kempen Derma Darah') {
                        if (input.value === '0') {
                            input.value = '';
                        }
                    }
                }
                
                // Fix Daerah Temb - Kempen Derma Darah and Gotong Royong should be empty, Community Engagement should be 20
                if (category === 'Daerah Temb') {
                    if (keterangan === 'Kempen Derma Darah ' || keterangan === 'Gotong Royong ') {
                        if (input.value === '0') {
                            input.value = '';
                        }
                    } else if (keterangan === 'Community Engagement @ POLSARA ' || keterangan === 'Community Engagement @ POLSARA') {
                        if (input.value !== '20') {
                            input.value = '20';
                        }
                    }
                }
                
                // Fix Daerah BM - Gotong Royong should be empty
                if (category === 'Daerah BM') {
                    if (keterangan === 'Gotong Royong') {
                        if (input.value === '0') {
                            input.value = '';
                        }
                    }
                }
            });
        }

        // Add event listeners to cenderahati inputs
        document.addEventListener('DOMContentLoaded', function() {
            // Attach event listeners after a short delay to ensure inputs are rendered
            setTimeout(() => {
                document.querySelectorAll('.cenderahati-input').forEach(input => {
                    // Update total in real-time as user types
                    input.addEventListener('input', function() {
                        updateCenderahatiTotal();
                    });
                    
                    input.addEventListener('change', async function() {
                        const row = this.closest('tr');
                        const category = this.dataset.category ||
                            row.querySelector('td:nth-child(2)')?.textContent.trim() ||
                            row.querySelector('td:first-child')?.textContent.trim();
                        if (category) {
                            const count = parseInt(this.value) || 0;
                            await saveCenderahatiData(category, count);
                        }
                    });
                    
                    // Also save on blur (when user clicks away)
                    input.addEventListener('blur', async function() {
                        const row = this.closest('tr');
                        const category = this.dataset.category ||
                            row.querySelector('td:nth-child(2)')?.textContent.trim() ||
                            row.querySelector('td:first-child')?.textContent.trim();
                        if (category) {
                            const count = parseInt(this.value) || 0;
                            await saveCenderahatiData(category, count);
                        }
                    });
                });
                
                console.log('Cenderahati event listeners attached');
            }, 600);

            // Load checklist data and enable editing (with fallback seed if empty)
            loadChecklistData().then(async (loaded) => {
                // If nothing loaded, seed fallback ONCE
                if (!loaded) {
                    await applyChecklistFallback(true);
                }
                enableChecklistEditing();
                
                // Wait a bit for DOM to settle after data load
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // MASTER SYNC: Force ALL values from CSV exactly - runs AFTER data loads
                syncAllValuesFromCSV();
                forceRow2SubRow2Budget(); // Specifically target Row 2 sub-row 2
                // ALWAYS force correct values for Daerah BM, Daerah Belait, Daerah Temb, Cenderahati, and Budgets after loading
                // Run immediately and with delays to ensure values stick
                forceBudgetValues();
                
                // Set up MutationObserver to watch for budget cell changes
                const budgetObserver = new MutationObserver((mutations) => {
                    let shouldSync = false;
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList' || mutation.type === 'characterData') {
                            const target = mutation.target;
                            if (target.classList && target.classList.contains('budget-cell')) {
                                // Check if Row 2 sub-row 2 budget changed
                                const row = target.closest('tr');
                                if (row) {
                                    const tds = row.querySelectorAll('td');
                                    const bilCell = tds[0];
                                    const tindakanCell = tds[2];
                                    if (bilCell && tindakanCell) {
                                        const bil = bilCell.textContent.trim();
                                        const tindakan = tindakanCell.textContent.trim();
                                        if (bil === '2' && tindakan === 'Setiausaha Mes') {
                                            const currentBudget = target.textContent.trim();
                                            if (currentBudget !== '$19,438.00') {
                                                shouldSync = true;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    });
                    if (shouldSync) {
                        console.log('Budget cell changed - forcing sync');
                        forceRow2SubRow2Budget();
                        syncAllValuesFromCSV();
                    }
                });
                
                // Observe all budget cells
                document.querySelectorAll('.budget-cell').forEach(cell => {
                    budgetObserver.observe(cell, { childList: true, characterData: true, subtree: true });
                });
                
                // Set up MutationObserver for goodies cells (Row 6 Gotong Royong)
                const goodiesObserver = new MutationObserver((mutations) => {
                    let shouldSync = false;
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList' || mutation.type === 'characterData') {
                            const target = mutation.target;
                            if (target.classList && target.classList.contains('goodies-cell')) {
                                const row = target.closest('tr');
                                if (row) {
                                    const tds = row.querySelectorAll('td');
                                    const categoryCell = tds[1];
                                    const keteranganCell = tds[3];
                                    if (categoryCell && keteranganCell) {
                                        const category = categoryCell.textContent.trim();
                                        const keterangan = keteranganCell.textContent.trim();
                                        // Check if this is Row 6 Gotong Royong
                                        if (category === 'Daerah BM' && keterangan === 'Gotong Royong') {
                                            const currentGoodies = target.textContent.trim();
                                            if (currentGoodies !== '-') {
                                                shouldSync = true;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    });
                    if (shouldSync) {
                        console.log('Goodies cell changed - forcing sync');
                        forceDaerahBMValues();
                        forceSpecificCellsDirectly();
                    }
                });
                
                // Set up MutationObserver for cenderahati inputs (Row 8 Community Engagement)
                const cenderahatiObserver = new MutationObserver((mutations) => {
                    let shouldSync = false;
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                            const target = mutation.target;
                            if (target.classList && target.classList.contains('cenderahati-input')) {
                                const row = target.closest('tr');
                                if (row) {
                                    const tds = row.querySelectorAll('td');
                                    const categoryCell = tds[1];
                                    const keteranganCell = tds[3];
                                    if (categoryCell && keteranganCell) {
                                        const category = categoryCell.textContent.trim();
                                        const keterangan = keteranganCell.textContent.trim();
                                        // Check if this is Row 8 Community Engagement
                                        if (category === 'Daerah Temb' && (keterangan === 'Community Engagement @ POLSARA ' || keterangan === 'Community Engagement @ POLSARA')) {
                                            const currentValue = target.value.trim();
                                            if (currentValue !== '20') {
                                                shouldSync = true;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    });
                    if (shouldSync) {
                        console.log('Cenderahati input changed - forcing sync');
                        forceDaerahTembValues();
                        forceSpecificCellsDirectly();
                    }
                });
                
                // Observe all goodies cells
                setTimeout(() => {
                    document.querySelectorAll('.goodies-cell').forEach(cell => {
                        goodiesObserver.observe(cell, { childList: true, characterData: true, subtree: true });
                    });
                    // Observe all cenderahati inputs
                    document.querySelectorAll('.cenderahati-input').forEach(input => {
                        cenderahatiObserver.observe(input, { attributes: true, attributeFilter: ['value'] });
                    });
                }, 500);
                
                // IMMEDIATE SYNC: Run syncAllValuesFromCSV first to set correct values
                // This uses the NEW CLEAN TABLE built from CSV file
                syncAllValuesFromCSV();
                
                // Final verification to ensure Row 7 matches image exactly
                finalRow7Verification();
                
                // Remove ALL repeating text from ALL rows and columns first
                removeAllRepeatingTextAndCleanColumns();
                aggressivelyRemoveTextFromCenderahati();
                forceReplaceRow7CenderahatiText();
                ultraAggressiveRow7CenderahatiCleanup(); // ULTRA-AGGRESSIVE cleanup
                
                // Aggressively clean Row 7
                aggressivelyCleanRow7();
                
                // Force Row 7 sub-row 1 keterangan to "Open day"
                forceRow7SubRow1Keterangan();
                
                // Setup MutationObserver to watch Row 7
                setupRow7Observer();
                
                // Start continuous fix for Row 7 (runs every second)
                startRow7ContinuousFix();
                
                // Final verification for Row 7 to match image
                finalRow7Verification();
                
                // Aggressively fix Row 8 sub-row 2
                aggressivelyFixRow8SubRow2();
                
                // Remove any duplicate text from keterangan cells
                removeDuplicateKeteranganText();
                
                // Verify Row 7 cenderahati values
                verifyRow7Cenderahati();
                
                // Verify table matches CSV after initial sync
                setTimeout(() => {
                    removeDuplicateKeteranganText();
                    verifyRow7Cenderahati();
                    verifyTableMatchesCSV();
                }, 150);
                
                forceDaerahBMValues();
                forceDaerahBMKeterangan(); // Force Daerah BM keterangan to be text, not numbers
                forceDaerahBelaitValues();
                forceDaerahBelaitValuesComplete(); // Force Daerah Belait all values from CSV
                forceDaerahTembValues();
                forceCenderahatiValues();
                forceEmptyCenderahatiValues();
                forceSpecificCellsDirectly(); // DIRECT FIX
                setTimeout(syncAllValuesFromCSV, 50);
                setTimeout(forceRow2SubRow2Budget, 50);
                setTimeout(forceDaerahBMKeterangan, 50);
                setTimeout(forceSpecificCellsDirectly, 50);
                setTimeout(syncAllValuesFromCSV, 100);
                setTimeout(forceRow2SubRow2Budget, 100);
                setTimeout(forceBudgetValues, 100);
                setTimeout(removeAllRepeatingTextAndCleanColumns, 50);
                setTimeout(aggressivelyRemoveTextFromCenderahati, 50);
                setTimeout(ultraAggressiveRow7CenderahatiCleanup, 50); // ULTRA-AGGRESSIVE
                setTimeout(forceReplaceRow7CenderahatiText, 50);
                setTimeout(finalRow7Verification, 50);
                // IMMEDIATE fixes - run as soon as possible
                forceRow7SubRow1Keterangan();
                aggressivelyCleanRow7();
                ultraAggressiveRow7CenderahatiCleanup(); // ULTRA-AGGRESSIVE
                
                setTimeout(aggressivelyCleanRow7, 50);
                setTimeout(ultraAggressiveRow7CenderahatiCleanup, 50); // ULTRA-AGGRESSIVE
                setTimeout(forceRow7SubRow1Keterangan, 50);
                setTimeout(setupRow7Observer, 100);
                setTimeout(startRow7ContinuousFix, 200);
                setTimeout(aggressivelyFixRow8SubRow2, 50);
                setTimeout(removeAllRepeatingTextAndCleanColumns, 100);
                setTimeout(aggressivelyRemoveTextFromCenderahati, 100);
                setTimeout(ultraAggressiveRow7CenderahatiCleanup, 100); // ULTRA-AGGRESSIVE
                setTimeout(forceReplaceRow7CenderahatiText, 100);
                setTimeout(finalRow7Verification, 100);
                setTimeout(aggressivelyFixRow8SubRow2, 100);
                setTimeout(forceDaerahBMValues, 100);
                setTimeout(forceDaerahBMKeterangan, 100);
                setTimeout(forceDaerahBelaitValues, 100);
                setTimeout(forceDaerahBelaitValuesComplete, 100);
                setTimeout(forceDaerahTembValues, 100);
                setTimeout(removeDuplicateKeteranganText, 100);
                setTimeout(verifyRow7Cenderahati, 100);
                setTimeout(forceCenderahatiValues, 100);
                setTimeout(forceEmptyCenderahatiValues, 100);
                setTimeout(forceSpecificCellsDirectly, 100);
                // More frequent cleanup with longer delays
                setTimeout(ultraAggressiveRow7CenderahatiCleanup, 200);
                setTimeout(ultraAggressiveRow7CenderahatiCleanup, 300);
                setTimeout(ultraAggressiveRow7CenderahatiCleanup, 500);
                setTimeout(ultraAggressiveRow7CenderahatiCleanup, 750);
                setTimeout(ultraAggressiveRow7CenderahatiCleanup, 1000);
                setTimeout(ultraAggressiveRow7CenderahatiCleanup, 1500);
                setTimeout(ultraAggressiveRow7CenderahatiCleanup, 2000);
                setTimeout(ultraAggressiveRow7CenderahatiCleanup, 3000);
                setTimeout(ultraAggressiveRow7CenderahatiCleanup, 5000);
            });
            
            // Load and enable To Do List (wait for API to be available)
            if (typeof ToDoListAPI !== 'undefined') {
                loadToDoListData();
                enableToDoListEditing();
                restrictToDoListAccess();
            } else {
                // Wait a bit for script to load
                setTimeout(() => {
                    if (typeof ToDoListAPI !== 'undefined') {
                        loadToDoListData();
                        enableToDoListEditing();
                        restrictToDoListAccess();
                    } else {
                        console.error('ToDoListAPI not available after timeout');
                    }
                }, 500);
            }
            
            // Also force values immediately and after delays - run multiple times to ensure it sticks
            // MASTER SYNC runs first to ensure CSV values override everything
            setTimeout(syncAllValuesFromCSV, 200);
            setTimeout(forceRow2SubRow2Budget, 200);
            setTimeout(syncAllValuesFromCSV, 500);
            setTimeout(forceRow2SubRow2Budget, 500);
            setTimeout(syncAllValuesFromCSV, 1000);
            setTimeout(forceRow2SubRow2Budget, 1000);
            setTimeout(syncAllValuesFromCSV, 1500);
            setTimeout(forceRow2SubRow2Budget, 1500);
            setTimeout(syncAllValuesFromCSV, 2000);
            setTimeout(forceRow2SubRow2Budget, 2000);
            setTimeout(syncAllValuesFromCSV, 3000);
            setTimeout(forceRow2SubRow2Budget, 3000);
            setTimeout(forceBudgetValues, 200);
            setTimeout(forceBudgetValues, 500);
            setTimeout(forceBudgetValues, 1000);
            setTimeout(forceBudgetValues, 1500);
            setTimeout(forceBudgetValues, 2000);
            setTimeout(forceBudgetValues, 3000);
            setTimeout(forceSpecificCellsDirectly, 200);
            setTimeout(forceSpecificCellsDirectly, 500);
            setTimeout(forceSpecificCellsDirectly, 1000);
            setTimeout(forceSpecificCellsDirectly, 1500);
            setTimeout(forceSpecificCellsDirectly, 2000);
            setTimeout(forceSpecificCellsDirectly, 3000);
            setTimeout(forceDaerahBMValues, 200);
            setTimeout(forceDaerahBMKeterangan, 200);
            setTimeout(forceDaerahBMValues, 500);
            setTimeout(forceDaerahBMKeterangan, 500);
            setTimeout(forceDaerahBMValues, 1000);
            setTimeout(forceDaerahBMKeterangan, 1000);
            setTimeout(forceDaerahBMValues, 1500);
            setTimeout(forceDaerahBMKeterangan, 1500);
            setTimeout(forceDaerahBMValues, 2000);
            setTimeout(forceDaerahBMKeterangan, 2000);
            setTimeout(forceDaerahBMValues, 3000);
            setTimeout(forceDaerahBMKeterangan, 3000);
            setTimeout(forceDaerahBelaitValues, 500);
            setTimeout(forceDaerahBelaitValuesComplete, 500);
            setTimeout(forceDaerahBelaitValues, 1000);
            setTimeout(forceDaerahBelaitValuesComplete, 1000);
            setTimeout(forceDaerahBelaitValues, 2000);
            setTimeout(forceDaerahBelaitValuesComplete, 2000);
            setTimeout(forceDaerahTembValues, 200);
            setTimeout(forceDaerahTembValues, 500);
            setTimeout(forceDaerahTembValues, 1000);
            setTimeout(forceDaerahTembValues, 1500);
            setTimeout(forceDaerahTembValues, 2000);
            setTimeout(forceDaerahTembValues, 3000);
            setTimeout(removeAllRepeatingTextAndCleanColumns, 200);
            setTimeout(aggressivelyRemoveTextFromCenderahati, 200);
            setTimeout(forceReplaceRow7CenderahatiText, 200);
            setTimeout(removeAllRepeatingTextAndCleanColumns, 500);
            setTimeout(aggressivelyRemoveTextFromCenderahati, 500);
            setTimeout(forceReplaceRow7CenderahatiText, 500);
            setTimeout(removeAllRepeatingTextAndCleanColumns, 1000);
            setTimeout(aggressivelyRemoveTextFromCenderahati, 1000);
            setTimeout(forceReplaceRow7CenderahatiText, 1000);
            setTimeout(removeAllRepeatingTextAndCleanColumns, 2000);
            setTimeout(aggressivelyRemoveTextFromCenderahati, 2000);
            setTimeout(forceReplaceRow7CenderahatiText, 2000);
            setTimeout(aggressivelyCleanRow7, 200);
            setTimeout(aggressivelyCleanRow7, 500);
            setTimeout(aggressivelyCleanRow7, 1000);
            setTimeout(forceRow7SubRow1Keterangan, 200);
            setTimeout(forceRow7SubRow1Keterangan, 500);
            setTimeout(forceRow7SubRow1Keterangan, 1000);
            setTimeout(forceRow7SubRow1Keterangan, 2000);
            setTimeout(finalRow7Verification, 200);
            setTimeout(finalRow7Verification, 500);
            setTimeout(finalRow7Verification, 1000);
            setTimeout(finalRow7Verification, 2000);
            setTimeout(aggressivelyFixRow8SubRow2, 200);
            setTimeout(aggressivelyFixRow8SubRow2, 500);
            setTimeout(aggressivelyFixRow8SubRow2, 1000);
            setTimeout(aggressivelyFixRow8SubRow2, 2000);
            setTimeout(removeDuplicateKeteranganText, 200);
            setTimeout(removeDuplicateKeteranganText, 500);
            setTimeout(removeDuplicateKeteranganText, 1000);
            setTimeout(removeDuplicateKeteranganText, 2000);
            setTimeout(verifyRow7Cenderahati, 200);
            setTimeout(verifyRow7Cenderahati, 500);
            setTimeout(verifyRow7Cenderahati, 1000);
            setTimeout(verifyRow7Cenderahati, 2000);
            setTimeout(forceCenderahatiValues, 500);
            setTimeout(forceCenderahatiValues, 1000);
            setTimeout(forceCenderahatiValues, 2000);
            setTimeout(forceEmptyCenderahatiValues, 200);
            setTimeout(forceEmptyCenderahatiValues, 500);
            setTimeout(forceEmptyCenderahatiValues, 1000);
            setTimeout(forceEmptyCenderahatiValues, 2000);
            setTimeout(forceEmptyCenderahatiValues, 3000);
            
            // Also force on any input change for Daerah BM
            setTimeout(() => {
                document.querySelectorAll('.cenderahati-input[data-category="Daerah BM"]').forEach((input, index) => {
                    const correctValues = ['0', '0', '5'];
                    if (correctValues[index] !== undefined && input.value !== correctValues[index]) {
                        input.value = correctValues[index];
                    }
                    // Add event listener to prevent wrong values
                    input.addEventListener('input', function() {
                        const row = this.closest('tr');
                        const tds = row.querySelectorAll('td');
                        const keterangan = tds[3]?.textContent.trim();
                        if (keterangan === 'Gotong Royong' && this.value !== '0') {
                            this.value = '0';
                        } else if (keterangan === 'Kempen Derma Darah' && this.value !== '0') {
                            this.value = '0';
                        } else if (keterangan === 'Walkaton' && this.value !== '5') {
                            this.value = '5';
                        }
                    });
                });
            }, 1500);

            // Enable budget editing for super admin
            enableBudgetEditing();
        });
        
        // To Do List Functions
        async function loadToDoListData() {
            try {
                // Use window.ToDoListAPI as fallback
                const API = window.ToDoListAPI || ToDoListAPI;
                if (typeof API === 'undefined') {
                    console.error('ToDoListAPI is not defined. Make sure api-client.js is loaded.');
                    return;
                }
                const res = await API.getAll();
                if (!res || !res.success) return;
                
                // Load row data (no title box anymore)
                if (res.data && Array.isArray(res.data)) {
                    res.data.forEach(item => {
                        const rowNum = item.row_number || item.row_num;
                        const row = document.querySelector(`tr[data-row-id="${rowNum}"]`);
                        if (row) {
                            const dateInput = row.querySelector('.todolist-date-input');
                            const taskInput = row.querySelector('.todolist-task-input');
                            const checkbox = row.querySelector('.todolist-checkbox');
                            const cell = checkbox ? checkbox.closest('.todolist-checkbox-cell') : null;
                            
                            if (dateInput) dateInput.value = item.date_value || '';
                            if (taskInput) taskInput.value = item.task || '';
                            if (checkbox) {
                                checkbox.checked = item.done == 1;
                                // Apply green-checked class for non-super-admin users
                                if (!isSuperAdmin() && checkbox.checked && cell) {
                                    cell.classList.add('green-checked');
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('Error loading To Do List data:', e);
            }
        }
        
        async function saveToDoListItem(rowNumber, checklistFor, dateValue, task, done) {
            try {
                // Use window.ToDoListAPI as fallback
                const API = window.ToDoListAPI || ToDoListAPI;
                if (typeof API === 'undefined') {
                    console.error('ToDoListAPI is not defined. Make sure api-client.js is loaded.');
                    throw new Error('ToDoListAPI is not available');
                }
                const currentUser = AuthAPI.getCurrentUser();
                const res = await API.save({
                    row_number: rowNumber,
                    checklist_for: checklistFor,
                    date_value: dateValue,
                    task: task,
                    done: done,
                    username: currentUser ? currentUser.username : 'System'
                });
                
                return res && res.success;
            } catch (e) {
                console.error('Error saving To Do List item:', e);
                throw e;
            }
        }
        
        function enableToDoListEditing() {
            // No auto-save - user will click Save button manually
        }
        
        function restrictToDoListAccess() {
            // Only super_admin can edit To Do List (strict check)
            let isSuperAdminUser = false;
            try {
                if (AuthAPI && AuthAPI.isLoggedIn()) {
                    const user = AuthAPI.getCurrentUser();
                    if (user && user.role === 'super_admin') {
                        isSuperAdminUser = true;
                    }
                }
            } catch (e) {
                console.warn('ToDoList access check failed', e);
            }
            
            // Hide save button for non-super-admin users
            const saveButton = document.querySelector('.todolist-save-button');
            if (saveButton) {
                if (!isSuperAdminUser) {
                    saveButton.style.display = 'none';
                } else {
                    saveButton.style.display = 'flex';
                }
            }
            
            // Disable all input fields for non-super-admin users
            const dateInputs = document.querySelectorAll('.todolist-date-input');
            const taskInputs = document.querySelectorAll('.todolist-task-input');
            const checkboxes = document.querySelectorAll('.todolist-checkbox');
            
            dateInputs.forEach(input => {
                input.disabled = !isSuperAdminUser;
                if (!isSuperAdminUser) {
                    input.style.cursor = 'not-allowed';
                    input.style.opacity = '1';
                    input.style.backgroundColor = '#f3f4f6';
                    input.style.color = '#000000';
                } else {
                    input.style.cursor = 'text';
                    input.style.opacity = '1';
                    input.style.backgroundColor = 'transparent';
                    input.style.color = '#374151';
                }
            });
            
            taskInputs.forEach(input => {
                input.disabled = !isSuperAdminUser;
                if (!isSuperAdminUser) {
                    input.style.cursor = 'not-allowed';
                    input.style.opacity = '1';
                    input.style.backgroundColor = '#f3f4f6';
                    input.style.color = '#000000';
                } else {
                    input.style.cursor = 'text';
                    input.style.opacity = '1';
                    input.style.backgroundColor = 'transparent';
                    input.style.color = '#374151';
                }
            });
            
            checkboxes.forEach(checkbox => {
                checkbox.disabled = !isSuperAdminUser;
                const cell = checkbox.closest('.todolist-checkbox-cell');
                
                if (!isSuperAdminUser) {
                    checkbox.style.cursor = 'not-allowed';
                    checkbox.style.width = '18px';
                    checkbox.style.height = '18px';
                    
                    // If checkbox is checked, add green-checked class to cell
                    if (checkbox.checked && cell) {
                        cell.classList.add('green-checked');
                    } else if (cell) {
                        cell.classList.remove('green-checked');
                    }
                    
                    // Listen for changes (though disabled, this helps with initial state)
                    checkbox.addEventListener('change', function() {
                        if (this.checked && cell) {
                            cell.classList.add('green-checked');
                        } else if (cell) {
                            cell.classList.remove('green-checked');
                        }
                    });
                } else {
                    checkbox.style.cursor = 'pointer';
                    checkbox.style.opacity = '1';
                    checkbox.style.accentColor = '#8b5cf6';
                    if (cell) {
                        cell.classList.remove('green-checked');
                    }
                }
            });
        }
        
        async function saveAllToDoListData() {
            const statusEl = document.getElementById('todolist-save-status');
            const saveButton = document.querySelector('.todolist-save-button');
            
            // Check if API is available
            if (typeof ToDoListAPI === 'undefined' || typeof window.ToDoListAPI === 'undefined') {
                if (statusEl) {
                    statusEl.textContent = '✗ API not loaded. Please refresh the page.';
                    statusEl.className = 'todolist-save-status error';
                }
                console.error('ToDoListAPI is not defined');
                return;
            }
            
            // Use window.ToDoListAPI as fallback
            const API = window.ToDoListAPI || ToDoListAPI;
            
            // Show saving status
            if (statusEl) {
                statusEl.textContent = 'Saving...';
                statusEl.className = 'todolist-save-status';
            }
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.style.opacity = '0.6';
                saveButton.style.cursor = 'not-allowed';
            }
            
            try {
                // No checklist_for title anymore, use empty string
                const checklistFor = '';
                
                // Get all rows
                const rows = document.querySelectorAll('#todolist-tbody tr');
                const savePromises = [];
                
                rows.forEach(row => {
                    const rowId = row.getAttribute('data-row-id');
                    if (!rowId) return;
                    
                    const rowNumber = parseInt(rowId);
                    const dateInput = row.querySelector('.todolist-date-input');
                    const taskInput = row.querySelector('.todolist-task-input');
                    const checkbox = row.querySelector('.todolist-checkbox');
                    
                    const dateValue = dateInput ? dateInput.value.trim() : '';
                    const task = taskInput ? taskInput.value.trim() : '';
                    const done = checkbox && checkbox.checked ? 1 : 0;
                    
                    savePromises.push(saveToDoListItem(rowNumber, checklistFor, dateValue, task, done));
                });
                
                // Wait for all saves to complete
                await Promise.all(savePromises);
                
                // Show success status
                if (statusEl) {
                    statusEl.textContent = '✓ Saved successfully!';
                    statusEl.className = 'todolist-save-status success';
                    setTimeout(() => {
                        statusEl.textContent = '';
                        statusEl.className = 'todolist-save-status';
                    }, 3000);
                }
            } catch (e) {
                console.error('Error saving To Do List:', e);
                if (statusEl) {
                    statusEl.textContent = '✗ Error saving: ' + (e.message || 'Unknown error');
                    statusEl.className = 'todolist-save-status error';
                    setTimeout(() => {
                        statusEl.textContent = '';
                        statusEl.className = 'todolist-save-status';
                    }, 5000);
                }
            } finally {
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.style.opacity = '1';
                    saveButton.style.cursor = 'pointer';
                }
            }
        }
    </script>
</body>
</html>

