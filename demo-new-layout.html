<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RBPF HP-105 Checklist - New Layout Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/api-client.js?v=6"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f3f4f6;
            overflow-x: hidden;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 180px;
            height: 100vh;
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            position: fixed;
            left: 0;
            top: 0;
            color: white;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            padding: 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 0.75rem;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            overflow: hidden;
        }
        
        .sidebar-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
            padding: 0.25rem;
        }
        
        .sidebar-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            letter-spacing: -0.025em;
        }
        
        .sidebar-subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .sidebar-nav {
            padding: 1rem 0;
        }
        
        .nav-section {
            margin-bottom: 0.5rem;
        }
        
        .nav-section-title {
            font-size: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.75rem 1.5rem 0.5rem;
            opacity: 0.6;
            font-weight: 600;
        }
        
        .nav-item {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            color: rgba(255,255,255,0.9);
            text-decoration: none;
        }
        
        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .nav-item.active {
            background: rgba(255,255,255,0.15);
            color: white;
            font-weight: 600;
            border-left: 4px solid #fbbf24;
        }
        
        .nav-item svg {
            width: 1.25rem;
            height: 1.25rem;
            flex-shrink: 0;
        }
        
        .nav-item-expandable {
            justify-content: space-between;
        }
        
        .nav-item-arrow {
            width: 1rem;
            height: 1rem;
            transition: transform 0.3s;
        }
        
        .nav-item-arrow.rotated {
            transform: rotate(180deg);
        }
        
        .nav-submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0,0,0,0.1);
        }
        
        .nav-submenu.expanded {
            max-height: 500px;
        }
        
        .nav-submenu-item {
            padding: 0.625rem 1.5rem 0.625rem 3.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8125rem;
            color: rgba(255,255,255,0.85);
        }
        
        .nav-submenu-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .badge {
            background: #ef4444;
            color: white;
            font-size: 0.625rem;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-weight: 700;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 180px;
            min-height: 100vh;
            background: #f3f4f6;
        }
        
        .top-bar {
            background: white;
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .countdown-in-header {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #fbbf24;
            border-radius: 0.75rem;
            padding: 0.75rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .countdown-in-header-title {
            font-size: 0.875rem;
            font-weight: 700;
            color: #92400e;
            white-space: nowrap;
        }
        
        .countdown-in-header-timer {
            font-size: 1.5rem;
            font-weight: 800;
            color: #b91c1c;
            white-space: nowrap;
        }
        
        .countdown-in-header-date {
            font-size: 0.75rem;
            color: #92400e;
            white-space: nowrap;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
        }
        
        .user-avatar svg {
            width: 24px;
            height: 24px;
        }
        
        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(59,130,246,0.3);
        }
        
        .user-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 10px 15px rgba(0,0,0,0.1);
            min-width: 180px;
            overflow: hidden;
            z-index: 1000;
            display: none;
        }
        
        .user-dropdown.show {
            display: block;
        }
        
        .user-dropdown-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            color: #374151;
            text-decoration: none;
        }
        
        .user-dropdown-item:hover {
            background: #f3f4f6;
        }
        
        .user-dropdown-item svg {
            width: 1.125rem;
            height: 1.125rem;
            flex-shrink: 0;
        }
        
        .user-dropdown-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 0.25rem 0;
        }
        
        .calendar-container {
            padding: 1rem 2rem;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            max-width: 100%;
        }
        
        .calendar-month {
            background: white;
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .calendar-month-title {
            text-align: center;
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }
        
        .calendar-days-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
            margin-bottom: 0.375rem;
        }
        
        .calendar-day-name {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: #6b7280;
            padding: 0.375rem 0;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
        }
        
        .calendar-day {
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.5rem 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.625rem;
            min-height: 85px;
            position: relative;
        }
        
        .calendar-day:hover {
            background: #eff6ff;
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(59,130,246,0.1);
        }
        
        .calendar-day-number {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.375rem;
            font-size: 0.75rem;
        }
        
        .calendar-day-events {
            font-size: 0.65rem;
            line-height: 1.3;
            color: #4b5563;
        }
        
        .calendar-day.weekend {
            background: #fef3c7;
        }
        
        .calendar-day.empty {
            background: #f9fafb;
            cursor: default;
        }
        
        .calendar-day.empty:hover {
            background: #f9fafb;
            border-color: #e5e7eb;
            box-shadow: none;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .calendar-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="rbpfnew.jpg" alt="RBPF Logo">
            </div>
            <div class="sidebar-title">HP-105 CHECKLIST</div>
        </div>
        
        <div class="sidebar-nav">
            <!-- Main Section -->
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                
                <a href="meeting-list.html" class="nav-item">
                    <span>Minit Mesyuarat</span>
                </a>
                
                <a href="senarai-ajk.html" class="nav-item">
                    <span>Senarai AJK</span>
                </a>
                
                <a href="acara-aktiviti.html" class="nav-item">
                    <span>Acara/Aktiviti</span>
                </a>
                
                <a href="budget.html" class="nav-item">
                    <span>Budget</span>
                </a>
            </div>
        </div>
        
        <div style="padding: 1.5rem; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.5rem; opacity: 0.6; margin-top: auto;">
            HP105 (DKH) @2025
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <!-- Countdown Timer in Header -->
            <div class="countdown-in-header">
                <div class="countdown-in-header-title">🎉 Countdown to HP-105</div>
                <div class="countdown-in-header-timer" id="countdownTimer">Loading...</div>
                <div class="countdown-in-header-date">📅 15 Januari 2026</div>
            </div>
            
            <div class="user-info">
                <div>
                    <div style="text-align: right; font-size: 0.875rem; font-weight: 600; color: #1f2937;" id="userName">Loading...</div>
                    <div style="text-align: right; font-size: 0.75rem; color: #6b7280;" id="userRole">-</div>
                </div>
                <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                
                <!-- User Dropdown Menu -->
                <div class="user-dropdown" id="userDropdown">
                    <a href="activity.html" class="user-dropdown-item" id="activityMenuItem" style="display: none;">
                        <span>Activity Log</span>
                    </a>
                    <a href="backup.html" class="user-dropdown-item" id="backupMenuItem" style="display: none;">
                        <span>Backup Manager</span>
                    </a>
                    <a href="create-user.html" class="user-dropdown-item" id="createUserMenuItem" style="display: none;">
                        <span>Create User</span>
                    </a>
                    <a href="users.html" class="user-dropdown-item" id="usersMenuItem" style="display: none;">
                        <span>Users</span>
                    </a>
                    <div class="user-dropdown-divider"></div>
                    <a href="#" onclick="resetMyPassword(); return false;" class="user-dropdown-item" style="color: #3b82f6;">
                        <span>Reset Password</span>
                    </a>
                    <div class="user-dropdown-divider"></div>
                    <a href="#" onclick="logout(); return false;" class="user-dropdown-item" style="color: #dc2626;">
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Calendar Section -->
        <div class="calendar-container">
            <div class="calendar-grid">
                <!-- December 2025 -->
                <div class="calendar-month">
                    <h3 class="calendar-month-title">December 2025</h3>
                    <div class="calendar-days-header">
                        <div class="calendar-day-name">Sun</div>
                        <div class="calendar-day-name">Mon</div>
                        <div class="calendar-day-name">Tue</div>
                        <div class="calendar-day-name">Wed</div>
                        <div class="calendar-day-name">Thu</div>
                        <div class="calendar-day-name">Fri</div>
                        <div class="calendar-day-name">Sat</div>
                    </div>
                    <div class="calendar-days" id="calendar-dec-2025"></div>
                </div>
                
                <!-- January 2026 -->
                <div class="calendar-month">
                    <h3 class="calendar-month-title">January 2026</h3>
                    <div class="calendar-days-header">
                        <div class="calendar-day-name">Sun</div>
                        <div class="calendar-day-name">Mon</div>
                        <div class="calendar-day-name">Tue</div>
                        <div class="calendar-day-name">Wed</div>
                        <div class="calendar-day-name">Thu</div>
                        <div class="calendar-day-name">Fri</div>
                        <div class="calendar-day-name">Sat</div>
                    </div>
                    <div class="calendar-days" id="calendar-jan-2026"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Calendar Event Modal (Same as original) -->
    <div id="calendarEventModal" class="hidden fixed inset-0 flex items-center justify-center z-50 p-4" style="background-color: rgba(0, 0, 0, 0.5);">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full overflow-y-auto" style="max-height: 90vh;">
            <div class="p-4 sm:p-6">
                <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-800"></h3>
                    <button onclick="closeCalendarModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div id="eventsList" class="mb-4"></div>
                <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                    <h4 class="font-semibold text-gray-700 mb-3">Add New Event</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                            <input type="time" id="eventTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Activity / Event Title</label>
                            <input type="text" id="eventTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Perbarisan, Meeting, etc.">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Venue</label>
                            <input type="text" id="eventVenue" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Padang Kawad, Bilik Mesyuarat">
                        </div>
                        <button id="addEventButton" onclick="addCalendarEvent()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                            Add Event
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Check authentication
        window.onload = function() {
            if (!AuthAPI.isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }
            
            loadUserInfo();
            updateCountdown();
            setInterval(updateCountdown, 1000);
            generateCalendar();
            loadAllCalendarEvents();
        };
        
        // Load user info
        function loadUserInfo() {
            const user = AuthAPI.getCurrentUser();
            if (user) {
                document.getElementById('userName').textContent = user.username;
                document.getElementById('userRole').textContent = user.role === 'super_admin' ? 'Super Admin' : (user.role === 'admin' ? 'Admin' : 'User');
                
                // Show dropdown for all users, but limit items based on role
                if (user.role === 'super_admin') {
                    // Super admin sees everything
                    document.getElementById('activityMenuItem').style.display = 'block';
                    document.getElementById('backupMenuItem').style.display = 'block';
                    document.getElementById('createUserMenuItem').style.display = 'block';
                    document.getElementById('usersMenuItem').style.display = 'block';
                } else if (user.role === 'admin') {
                    // Admin only sees Create User, Users, and Logout
                    document.getElementById('activityMenuItem').style.display = 'none';
                    document.getElementById('backupMenuItem').style.display = 'none';
                    document.getElementById('createUserMenuItem').style.display = 'block';
                    document.getElementById('usersMenuItem').style.display = 'block';
                } else {
                    // Regular users see nothing (shouldn't happen, but just in case)
                    document.getElementById('activityMenuItem').style.display = 'none';
                    document.getElementById('backupMenuItem').style.display = 'none';
                    document.getElementById('createUserMenuItem').style.display = 'none';
                    document.getElementById('usersMenuItem').style.display = 'none';
                }
            }
        }
        
        // Update countdown
        function updateCountdown() {
            const now = new Date();
            const eventDate = new Date('January 15, 2026 00:00:00');
            const timeDiff = eventDate.getTime() - now.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            let countdownText;
            if (daysDiff > 1) {
                countdownText = `${daysDiff} hari lagi!`;
            } else if (daysDiff === 1) {
                countdownText = "ESOK!";
            } else if (daysDiff <= 0) {
                if (now.getDate() === 15 && now.getMonth() === 0 && now.getFullYear() === 2026) {
                    countdownText = "HARI INI! 🎉";
                } else {
                    countdownText = "Acara telah selesai.";
                }
            }
            
            document.getElementById('countdownTimer').textContent = countdownText;
        }
        
        // Toggle submenu
        function toggleSubmenu(menuId) {
            const submenu = document.getElementById(menuId + '-submenu');
            const arrow = event.currentTarget.querySelector('.nav-item-arrow');
            
            submenu.classList.toggle('expanded');
            arrow.classList.toggle('rotated');
        }
        
        // Toggle user dropdown
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }
        
        // Close user dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userInfo = document.querySelector('.user-info');
            const dropdown = document.getElementById('userDropdown');
            
            if (userInfo && !userInfo.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // Logout
        function logout() {
            if (confirm('Adakah anda pasti mahu log keluar?')) {
                AuthAPI.logout();
            }
        }
        
        // Reset current user's own password
        async function resetMyPassword() {
            const currentUser = AuthAPI.getCurrentUser();
            if (!currentUser) {
                alert('You must be logged in to reset your password.');
                return;
            }
            
            const newPassword = prompt('Enter your new password:');
            if (!newPassword) {
                return; // User cancelled
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long.');
                return;
            }
            
            const confirmPassword = prompt('Confirm your new password:');
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match.');
                return;
            }
            
            // Get user ID from sessionStorage
            const userId = parseInt(sessionStorage.getItem('rbpf_user_id'));
            if (!userId) {
                alert('Unable to identify your user account. Please log out and log back in.');
                return;
            }
            
            const result = await UsersAPI.resetPassword(userId, newPassword);
            
            if (result.success) {
                alert('Your password has been changed successfully!');
                // Log the activity
                if (window.ActivityAPI) {
                    await ActivityAPI.log(`Changed own password`, 'general');
                }
            } else {
                alert('Failed to change password: ' + (result.message || 'Unknown error'));
            }
        }
        
        // Generate calendar
        function generateCalendar() {
            // December 2025
            const decContainer = document.getElementById('calendar-dec-2025');
            const dec2025 = new Date(2025, 11, 1);
            const decDaysInMonth = 31;
            const decFirstDay = dec2025.getDay();
            
            let decHTML = '';
            for (let i = 0; i < decFirstDay; i++) {
                decHTML += '<div class="calendar-day empty"></div>';
            }
            for (let day = 1; day <= decDaysInMonth; day++) {
                // Only Friday (5) and Sunday (0) are public holidays, Saturday (6) is working day
                const dayOfWeek = (decFirstDay + day - 1) % 7;
                const isPublicHoliday = dayOfWeek === 0 || dayOfWeek === 5;
                decHTML += `
                    <div class="calendar-day ${isPublicHoliday ? 'weekend' : ''}" onclick="editCalendarDate('dec', ${day})">
                        <div class="calendar-day-number">${day}</div>
                        <div id="dec-${day}-notes" class="calendar-day-events"></div>
                    </div>
                `;
            }
            decContainer.innerHTML = decHTML;
            
            // January 2026
            const janContainer = document.getElementById('calendar-jan-2026');
            const jan2026 = new Date(2026, 0, 1);
            const janDaysInMonth = 31;
            const janFirstDay = jan2026.getDay();
            
            let janHTML = '';
            for (let i = 0; i < janFirstDay; i++) {
                janHTML += '<div class="calendar-day empty"></div>';
            }
            for (let day = 1; day <= janDaysInMonth; day++) {
                // Only Friday (5) and Sunday (0) are public holidays, Saturday (6) is working day
                const dayOfWeek = (janFirstDay + day - 1) % 7;
                const isPublicHoliday = dayOfWeek === 0 || dayOfWeek === 5;
                janHTML += `
                    <div class="calendar-day ${isPublicHoliday ? 'weekend' : ''}" onclick="editCalendarDate('jan', ${day})">
                        <div class="calendar-day-number">${day}</div>
                        <div id="jan-${day}-notes" class="calendar-day-events"></div>
                    </div>
                `;
            }
            janContainer.innerHTML = janHTML;
        }
        
        // Calendar functions (simplified - use same functions from original)
        let currentCalendarMonth = '';
        let currentCalendarDay = 0;
        let calendarEvents = [];
        let editingEventId = null;
        
        function formatTimeAMPM(timeString) {
            if (!timeString) return 'All Day';
            const [hours, minutes] = timeString.split(':');
            let hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            if (hour === 0) hour = 12;
            else if (hour > 12) hour = hour - 12;
            return `${hour}:${minutes} ${ampm}`;
        }
        
        async function editCalendarDate(month, day) {
            currentCalendarMonth = month;
            currentCalendarDay = day;
            const monthName = month === 'dec' ? 'December' : 'January';
            document.getElementById('modalTitle').textContent = `Events for ${monthName} ${day}`;
            await loadCalendarEvents(month, day);
            document.getElementById('calendarEventModal').classList.remove('hidden');
        }
        
        function closeCalendarModal() {
            document.getElementById('calendarEventModal').classList.add('hidden');
            document.getElementById('eventTime').value = '';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventVenue').value = '';
            editingEventId = null;
            loadAllCalendarEvents();
        }
        
        async function loadCalendarEvents(month, day) {
            try {
                const result = await CalendarEventsAPI.getByDay(month, day);
                if (result.success && result.data) {
                    calendarEvents = result.data;
                    displayCalendarEvents();
                }
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }
        
        function displayCalendarEvents() {
            const eventsList = document.getElementById('eventsList');
            if (calendarEvents.length === 0) {
                eventsList.innerHTML = '<p style="color: #6b7280; font-size: 0.875rem; font-style: italic;">No events scheduled for this day yet.</p>';
                return;
            }
            
            const currentUser = AuthAPI.getCurrentUser();
            const isSuperAdmin = currentUser && currentUser.role === 'super_admin';
            
            let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
            calendarEvents.forEach(event => {
                const formattedTime = formatTimeAMPM(event.event_time);
                const actionButtons = isSuperAdmin ? `
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="editCalendarEventData(${event.id})" style="color: #3b82f6; font-size: 0.75rem; font-weight: 600;">Edit</button>
                        <button onclick="deleteCalendarEvent(${event.id})" style="color: #ef4444; font-size: 0.75rem; font-weight: 600;">Delete</button>
                    </div>
                ` : '';
                
                html += `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex-grow: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                    <span style="color: #3b82f6; font-weight: 700; font-size: 0.875rem;">${formattedTime}</span>
                                    <span style="color: #1f2937; font-weight: 600; font-size: 0.875rem;">${event.event_title}</span>
                                </div>
                                ${event.venue ? `<div style="color: #6b7280; font-size: 0.75rem;">📍 ${event.venue}</div>` : ''}
                                <div style="color: #9ca3af; font-size: 0.625rem; margin-top: 0.25rem;">Added by: ${event.created_by}</div>
                            </div>
                            ${actionButtons}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            eventsList.innerHTML = html;
        }
        
        function editCalendarEventData(eventId) {
            const event = calendarEvents.find(e => e.id === eventId);
            if (event) {
                document.getElementById('eventTime').value = event.event_time || '';
                document.getElementById('eventTitle').value = event.event_title || '';
                document.getElementById('eventVenue').value = event.venue || '';
                editingEventId = eventId;
                document.getElementById('addEventButton').textContent = 'Update Event';
                document.getElementById('addEventButton').style.background = '#16a34a';
            }
        }
        
        async function addCalendarEvent() {
            const eventTime = document.getElementById('eventTime').value.trim();
            const eventTitle = document.getElementById('eventTitle').value.trim();
            const eventVenue = document.getElementById('eventVenue').value.trim();
            
            if (!eventTitle) {
                alert('Please enter an event title');
                return;
            }
            
            let result;
            if (editingEventId) {
                result = await CalendarEventsAPI.update(editingEventId, eventTime, eventTitle, eventVenue);
            } else {
                result = await CalendarEventsAPI.create(currentCalendarMonth, currentCalendarDay, eventTime, eventTitle, eventVenue);
            }
            
            if (result.success) {
                document.getElementById('eventTime').value = '';
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventVenue').value = '';
                editingEventId = null;
                document.getElementById('addEventButton').textContent = 'Add Event';
                document.getElementById('addEventButton').style.background = '#2563eb';
                await loadCalendarEvents(currentCalendarMonth, currentCalendarDay);
            } else {
                alert('Error: ' + result.message);
            }
        }
        
        async function deleteCalendarEvent(eventId) {
            if (confirm('Delete this event?')) {
                const result = await CalendarEventsAPI.delete(eventId);
                if (result.success) {
                    await loadCalendarEvents(currentCalendarMonth, currentCalendarDay);
                }
            }
        }
        
        async function loadAllCalendarEvents() {
            const result = await CalendarEventsAPI.getAll();
            if (result.success && result.data) {
                const eventsByDay = {};
                result.data.forEach(event => {
                    const key = `${event.month}-${event.day}`;
                    if (!eventsByDay[key]) eventsByDay[key] = [];
                    eventsByDay[key].push(event);
                });
                
                Object.keys(eventsByDay).forEach(key => {
                    const events = eventsByDay[key];
                    const el = document.getElementById(`${key}-notes`);
                    const dayEl = document.querySelector(`[onclick*="'${key.split('-')[0]}', ${key.split('-')[1]}"]`);
                    
                    if (el) {
                        let html = '';
                        const colors = ['#1f2937', '#991b1b', '#166534']; // black, dark red, dark green
                        events.forEach((event, index) => {
                            const displayTime = event.event_time ? formatTimeAMPM(event.event_time) + ' ' : '';
                            const color = colors[index % colors.length];
                            html += `<div style="margin-bottom: 3px; line-height: 1.3; color: ${color}; font-weight: ${events.length > 1 ? '600' : '400'};">• ${displayTime}${event.event_title}</div>`;
                        });
                        el.innerHTML = html;
                    }
                    
                    // Update day number color if multiple events
                    if (dayEl && events.length > 1) {
                        const dayNumberEl = dayEl.querySelector('.calendar-day-number');
                        if (dayNumberEl) {
                            const colors = ['#1f2937', '#991b1b', '#166534'];
                            dayNumberEl.style.color = colors[(events.length - 1) % colors.length];
                            dayNumberEl.style.fontWeight = '700';
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>

